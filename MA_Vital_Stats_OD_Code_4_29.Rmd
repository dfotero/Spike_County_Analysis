---
title: "MA Data Cleaning - updated Feb 2024"
authors: "Catherine DiGennaro, Tianna Herman, and Hannah Lee"
date: "2/6/2024"
output: html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '.')

library(sf)
#library(ggsflabel)
library(ggmap)
library(tmap)
library(ggrepel)
library(ggh4x)
library("writexl")
library(scales)
library(tidyverse)
library(dplyr)
library(readxl)
library(lubridate)
library(tidycensus)
library(gtable)
library(grid)
library(ggplot2)
library(gganimate)
library(lattice)
library(chron)
library("data.table")
library(calendR)
library(progress)
`%!in%` <- Negate(`%in%`)
census_api_key(Sys.getenv("CENSUS_API_KEY"))
#register_google(key = "AIzaSyC-uv165vsZAEM-ovBrK8-7JMVrBRGRSpY")

#setwd("/Users/Hannah/Documents/R/Mass-Vital-Statistics")
setwd("/Users/gvq6rg/OneDrive - Mass General Brigham/Mass Vital Statistics- Death Data/Data")
#setwd("C:/Users/HL522/OneDrive - Mass General Brigham/R/Mass-Vital-Statistics")
#setwd("//rfawin.partners.org/mgh-itafisma/CDC Study- Mass Datasets/Mass Vital Statistics") 
```

``` {r icd_codes, include=FALSE}
# Drug overdose deaths are identified using underlying cause of death codes X40-X44, X60-X64, X85, and Y10-Y14
# https://www.cdc.gov/nchs/nvss/vsrr/drug-overdose-data.htm#:~:text=Drug%20overdose%20deaths%20are%20identified,X85%2C%20and%20Y10%E2%80%93Y14.
UCOD_OD_codes <- c("X40","X41","X42","X43","X44",
                   "X60","X61","X62","X63","X64",
                   "X85",
                   "Y10","Y11","Y12","Y13","Y14")

# The following multiple cause of death codes used to identify specific drug types
heroin <- "T401"
rx_opioids <- "T402|T403"
other <- "T406"
fentanyl <- "T404"
cocaine <- "T405"
psychostimulants <- "T436"
alcohol <- "E244|F10|G312|G621|G721|I426|K292|K70|K852|K860|R780|X45|X65|Y15"
benzos <- "T424"
xylazine <- "T427"
```

```{r import_data}
setwd("/Users/gvq6rg/OneDrive - Mass General Brigham/Mass Vital Statistics- Death Data/Data")
MA2023_filtered <- suppressWarnings(read_xlsx("DEATH_CODplus_2023_v0624.xlsx", 2)) %>% filter(TRX_CAUSE_ACME %in% UCOD_OD_codes)
MA2022_filtered <- suppressWarnings(read_xlsx("DEATH_CODplus_2022_v0624.xlsx", 2)) %>% filter(TRX_CAUSE_ACME %in% UCOD_OD_codes)
MA2021_filtered <- suppressWarnings(read_xlsx("DEATH_CODplus_2021_v0324.xlsx", 2)) %>% filter(TRX_CAUSE_ACME %in% UCOD_OD_codes)
MA2020_filtered <- suppressWarnings(read_xlsx("DEATH_CODplus_2020_v0723.xlsx", 2)) %>% filter(TRX_CAUSE_ACME %in% UCOD_OD_codes)
MA2019_filtered <- suppressWarnings(read_xlsx("DEATH_CODplus_2019_v0322.xlsx", 2)) %>% filter(TRX_CAUSE_ACME %in% UCOD_OD_codes)
MA2018_filtered <- suppressWarnings(read_xlsx("DEATH_CODplus_2018_v0322.xlsx", 2)) %>% filter(TRX_CAUSE_ACME %in% UCOD_OD_codes)
MA2017_filtered <- suppressWarnings(read_xlsx("DEATH_CODplus_2017_v0322.xlsx", 2)) %>% filter(TRX_CAUSE_ACME %in% UCOD_OD_codes)
MA2016_filtered <- suppressWarnings(read_xlsx("DEATH_CODplus_2016.xlsx", 2)) %>% filter(TRX_CAUSE_ACME %in% UCOD_OD_codes)
MA2015_filtered <- suppressWarnings(read_xlsx("DEATH_CODplus_2015.xlsx", 2)) %>% filter(TRX_CAUSE_ACME %in% UCOD_OD_codes)
MA2014_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2014_10072020.xlsx", 2)) %>% filter(TRX_CAUSE_ACME %in% UCOD_OD_codes)
MA2013_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2013_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
MA2012_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2012_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
MA2011_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2011_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
MA2010_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2010_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
MA2009_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2009_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
MA2008_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2008_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
MA2007_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2007_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
MA2006_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2006_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
MA2005_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2005_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
MA2004_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2004_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
MA2003_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2003_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
MA2002_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2002_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
MA2001_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2001_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
MA2000_filtered <- suppressWarnings(read_xlsx("Death_CODplus_2000_05282021.xlsx")) %>% filter(underlying_cause %in% UCOD_OD_codes)
# Meta data for population data set can be found at this link: https://www2.census.gov/programs-surveys/popest/technical-documentation/file-layouts/2020-2021/SUB-EST2021.pdf
MA2020_CityPop <- read_csv("sub-est2021_25.csv") 
MA2020_CountyRacePop <- suppressWarnings(read_xlsx("DECENNIALPL2020.P2-2022-07-12T165506_new.xlsx"))

MA_OD_15_23 <-
  as_tibble(
    rbind(
      MA2023_filtered,
      MA2022_filtered,
      MA2021_filtered,
      MA2020_filtered,
      MA2019_filtered,
      MA2018_filtered,
      MA2017_filtered,
      MA2016_filtered,
      MA2015_filtered))
MA_OD_15_23_CLEAN <- MA_OD_15_23 %>% 
  mutate(DOD_4_FD = as_date(DOD_4_FD, format = '%m/%d/%Y'),
         YOD = year(DOD_4_FD))

MA_OD_00_13 <-
  as_tibble(
    rbind(
       MA2013_filtered,
       MA2012_filtered,
       MA2011_filtered,
       MA2010_filtered,
       MA2009_filtered,
       MA2008_filtered,
       MA2007_filtered,
       MA2006_filtered,
       MA2005_filtered,
       MA2004_filtered,
       MA2003_filtered,
       MA2002_filtered,
       MA2001_filtered,
       MA2000_filtered))
```

```{r rename_old_cols_and_reformat}
MA_OD_00_13_CLEAN <- MA_OD_00_13 %>% 
  mutate(DOD_4_FD = as_date(date_of_death),
         YOD = year(DOD_4_FD),
         DSTATEL = case_when(
           state_of_death == "MA" ~ "MASSACHUSETTS",
           state_of_death == "ZZ" ~ "UNKNOWN",
           TRUE ~ "ERROR"
         ),
         SEX = case_when(
           sex == 1 ~ "M",
           sex == 2 ~ "F",
           sex %in% c(3, 9) ~ "UNKNOWN",
           TRUE ~ "ERROR"
         ),
         AGE1_CALC = as.numeric(age),
         INJRY_PLACEL = case_when(
           type_of_place_where_death_occurred %in% c(1, 2, 3, 4) ~ "HOSPITAL",
           type_of_place_where_death_occurred == 5 ~ "NURSING HOME",
           type_of_place_where_death_occurred == 6 ~ "DECEDENT'S RESIDENCE",
           type_of_place_where_death_occurred == 7 ~ "OTHER PRIVATE LOCATION",
           type_of_place_where_death_occurred == 9 ~ "UNKNOWN",
           TRUE ~ "ERROR"
          ),
          RACEGROUP = case_when(
           hispanic == "0" & race == "01" ~ "White NH",
           hispanic == "0" & race %in% c("02", "13") ~ "Black NH",
           hispanic == "0" & race == "03" ~ "American Indian / Alaska Native / Other NH",
           hispanic == "0" & race %in% c("04", "05", "06", "07", "08", "09", "10", "11", "12") ~ "Asian/PI NH",
           hispanic == "0" & race %in% c("14", "99")  ~ "Unknown",
           hispanic %in% c("1", "2", "3", "4", "5", "6", "7", "8", "9") | race == "15" ~ "Hispanic",
           TRUE ~ "ERROR"
         )) %>% 
  rename(TRX_CAUSE_ACME = underlying_cause,
         DNAME_CITY = city_town_of_death,
         TRX_REC_AXIS_CD = other_causes,
         DZIP9 = zip_code)
  
# HISPANIC INDICATORS: 
# - DETHNIC1 - DETHNIC4    
# - RACE_HISP_LAT_BLACK & RACE_HISP_LAT_WHITE
# - DETHNIC_DOMINICAN, DETHNIC_OTHER_SOUTH_AM, DETHNIC_CENTRAL_AM, DETHNIC_HONDORAN, DETHNIC_COLUMBIAN, DETHNIC_GUATEMALAN

MA2014_filtered_CLEAN <- MA2014_filtered %>% 
  mutate(DOD_4_FD = as_date(DOD_4_FD, format="%m/%d/%Y"),
         YOD = 2014,
         hispanic = case_when(
           (DETHNIC1 == "Y" |
              DETHNIC2 == "Y" |
              DETHNIC3 == "Y" |
              DETHNIC4 == "Y" | 
              RACE_HISP_LAT_BLACK == "Y" |
              RACE_HISP_LAT_WHITE == "Y" |
              DETHNIC_DOMINICAN == "Y" | 
              DETHNIC_OTHER_SOUTH_AM == "Y" |
              DETHNIC_CENTRAL_AM == "Y" | 
              DETHNIC_HONDORAN == "Y" |
              DETHNIC_COLUMBIAN == "Y" | 
              DETHNIC_GUATEMALAN == "Y") ~ "Y",
           TRUE ~ "N"
         ),
         RACEGROUP = case_when(
           hispanic == "N" & RACE1 == "Y" ~ "White NH",
           hispanic == "N" & RACE3 == "Y" ~ "American Indian / Alaska Native / Other NH",
           hispanic == "N" & RACE_BLACK == "Y" ~ "Black NH",
           hispanic == "N" & (RACE4 == "Y" |
                                RACE5 == "Y" |
                                RACE6 == "Y" |
                                RACE7 == "Y" |
                                RACE8 == "Y" |
                                RACE9 == "Y" |
                                RACE10 == "Y" |
                                RACE11 == "Y" |
                                RACE12 == "Y" |
                                RACE13 == "Y" |
                                RACE14 == "Y" | 
                                RACE_ASIAN == "Y") ~ "Asian/PI NH",
           hispanic == "Y" ~ "Hispanic",
           TRUE ~ "Unknown"
         ))

#clean ma city_county table
MA2020_CityPopFilter <- mutate_all(MA2020_CityPop, .funs = toupper)
MA2020_CityFilter <- MA2020_CityPopFilter %>%
    mutate(NAME = str_remove_all(NAME, "TOWN| CITY"))
colnames(MA2020_CityFilter)[which(names(MA2020_CityFilter) == "NAME")] <- "DNAME_CITY"

  #add county names
MA2020_CityFilter <- MA2020_CityFilter %>%
  mutate(County_name = case_when(
    (COUNTY == "1") ~ "Barnstable", 
    (COUNTY == "3") ~ "Berkshire",
    (COUNTY == "5") ~ "Bristol",
    (COUNTY == "7") ~ "Dukes",
    (COUNTY == "9") ~ "Essex",
    (COUNTY == "11") ~ "Franklin",
    (COUNTY == "13") ~ "Hampden",
    (COUNTY == "15") ~ "Hampshire",
    (COUNTY == "17") ~ "Middlesex",
    (COUNTY == "19") ~ "Nantucket",
    (COUNTY == "21") ~ "Norfolk",
    (COUNTY == "23") ~ "Plymouth",
    (COUNTY == "25") ~ "Suffolk",
    (COUNTY == "27") ~ "Worcester",
    TRUE ~ "Other Area")
  ) 

MA2020_CityFilter$ESTIMATESBASE2020 <- as.numeric(MA2020_CityFilter$ESTIMATESBASE2020)

```

```{r bind_cleaned_dfs}
MA_OD <- bind_rows(MA_OD_00_13_CLEAN, MA2014_filtered_CLEAN, MA_OD_15_23_CLEAN) 
MA_OD$DNAME_CITY <- as.character(MA_OD$DNAME_CITY)
MA2020_CityFilter$DNAME_CITY <- as.character(MA2020_CityFilter$DNAME_CITY)
MA_OD$County_name<-MA_OD$DCOUNTY
MA_OD$County_name<-tolower(MA_OD$County_name)
MA_OD$County_name<-str_to_title(MA_OD$County_name)
#MA_OD <- MA_OD %>%right_join(MA2020_CityFilter, by = c("DNAME_CITY" = "DNAME_CITY"))
```


```{r Clean up ICD codes}
# Reformat the other causes of death
# General categories are three characters, subcategories are four characters
# https://www.cms.gov/Medicare/Coding/ICD10/Downloads/2019-ICD10-Coding-Guidelines-.pdf 

MA_OD$TRX_REC_AXIS_CD <- gsub("\u00A0", "", MA_OD$TRX_REC_AXIS_CD)
MA_OD$TRX_REC_AXIS_CD <- sapply(MA_OD$TRX_REC_AXIS_CD, function(x) {
  x <- gsub("^\\s+", "", x)

  # Split the string by any number of spaces
  split_string <- unlist(strsplit(x, "\\s+"))

  # Remove leading and trailing whitespace
  split_string <- trimws(split_string)
  # Remove empty strings
  split_string <- split_string[split_string != ""]
})
```

```{r Get ICD-10 Codes Info}
library(readr)

# Specify the file path (adjust the path to where your file is located)
file_path <- "icd10cm-order-April-2024.txt"

# Define the widths of each field based on the documentation
widths <- c(5, 1, 7, 1, 1, 1, 60, 1, 323)

# Read the file
icd_data <- read_fwf(file_path,
                     fwf_widths(widths, 
                                c("order_number", "blank1", "code", "blank2", "valid_flag", 
                                  "blank3", "short_description", "blank4", "long_description")),
                     col_types = cols(.default = "c"))  # Treat all columns as characters
icd_data <- icd_data[, !(names(icd_data) %in% c("blank1", "blank2", "blank3", "short_description", "blank4"))]
```

```{r Analyze ICD-10 codes; Get unique descriptions of each ICD-10 Code}
# Get unique codes
unique_codes <- lapply(MA_OD$TRX_REC_AXIS_CD, unique)

# Combine all unique vectors into one list
unique_codes <- unique(trimws(unlist(unique_codes)))

# Get frequency of each unique code
frequency <- table(trimws(unlist(MA_OD$TRX_REC_AXIS_CD)))

# Create a data frame with unique codes and their frequencies
ICD_10_codes <- data.frame(codes = names(frequency), frequency = as.numeric(frequency))

# Sort the data frame by frequency
ICD_10_codes <- ICD_10_codes[order(ICD_10_codes$frequency, decreasing = TRUE), ]

# Filter data with just "T" codes
filtered_ICD_10_codes  <- ICD_10_codes[grepl("^T", ICD_10_codes$codes), ]

description <- setNames(icd_data$long_description, icd_data$code)

# Map ICD codes to descriptions
MA_OD$code_descriptions <- lapply(MA_OD$TRX_REC_AXIS_CD, function(icd_vector) {
  descriptions <- description[icd_vector]
  return(descriptions[!is.na(descriptions)])  # Return descriptions, excluding NA for unmatched codes
})

# Map ICD codes to descriptions
ICD_10_codes$code_descriptions <- lapply(ICD_10_codes$codes, function(icd_vector) {
  descriptions <- description[icd_vector]
  return(descriptions[!is.na(descriptions)])  # Return descriptions, excluding NA for unmatched codes
})
ICD_10_codes$codes <- sapply(ICD_10_codes$codes, toString)
ICD_10_codes$code_descriptions <- sapply(ICD_10_codes$code_descriptions, toString)
ICD_10_codes <- ICD_10_codes[order(ICD_10_codes$frequency, decreasing = TRUE), ]

write.csv(ICD_10_codes, "unique_ICD_10_codes.csv", row.names = FALSE)


MA_OD_fil <-  MA_OD %>%
  select(TRX_REC_AXIS_CD, code_descriptions)
View(as.data.frame(MA_OD$code_descriptions))
MA_OD_fil$TRX_REC_AXIS_CD <- sapply(MA_OD_fil$TRX_REC_AXIS_CD, toString)
MA_OD_fil$code_descriptions <- sapply(MA_OD_fil$code_descriptions, toString)
MA_OD_f$code_descriptions <- sapply(MA_OD_f$code_descriptions, toString)

write.csv(MA_OD_fil, "MA_OD_filtered.csv", row.names = FALSE)
write.csv(filtered_ICD_10_codes, "ICD_10_codes_Vital_Stats_Data.csv", row.names = FALSE)

```


```{r classify_drugs}
ODs_classified <- MA_OD

ODs_classified <- ODs_classified %>%
  mutate(
    heroin = case_when(grepl(heroin, TRX_REC_AXIS_CD) ~ 1,
                       TRUE ~ 0),
    rx_opioids = case_when(grepl(rx_opioids, TRX_REC_AXIS_CD) ~ 1,
                           TRUE ~ 0),
    fentanyl = case_when(grepl(fentanyl, TRX_REC_AXIS_CD) ~ 1,
                         TRUE ~ 0),
    other = case_when(grepl(other, TRX_REC_AXIS_CD) ~ 1,
                      TRUE ~ 0),
    cocaine = case_when(grepl(cocaine, TRX_REC_AXIS_CD) ~ 1,
                        TRUE ~ 0),
    psychostimulants = case_when(grepl(psychostimulants, TRX_REC_AXIS_CD) ~ 1,
                                 TRUE ~ 0),
    alcohol = case_when(grepl(alcohol, TRX_REC_AXIS_CD) ~ 1,
                        TRUE ~ 0),
    benzos = case_when(grepl(benzos, TRX_REC_AXIS_CD) ~ 1,
                       TRUE ~ 0),
    xylazine = case_when(grepl(xylazine, TRX_REC_AXIS_CD) ~ 1,
                       TRUE ~ 0)
  )
```

```{r classify_ODs}

# Code for looking into stimulant-only overdoses
coc_or_ps_only <- c("T405", "T436")

opioids_only <- c("T401", "T400", "T402", "T403", "T404", "T406")

# "Among deaths with an underlying cause of drug overdose, the percentage with at least one drug or drug class specified is defined as that with at least one ICD–10 multiple cause-of-death code in the range T36–T50.8"
# https://www.cdc.gov/nchs/nvss/vsrr/drug-overdose-data.htm

# Function that checks that at least one code is a part of the T36-T50.8 AND T51 (alcohol) codes; For X-only deaths
one_drug_only <- function(t_values, allowed_codes) {
  t_values <- grep("^T(3[0-9][0-9]|4[0-9][0-9]|50[0-8]|510)", t_values, value = TRUE) 
  # Check if all values are within the specified range "T30" to "T508" and only contain values I am interested in
  if(length(t_values) > 0 && all(t_values %in% allowed_codes)) {
    return(1)
  } else {
    return(0)
  }
}
# Function that checks that all codes that I am interested in is a part of the T36-T50.8 AND T51 codes, but no other T codes present
at_least_one_drug_only <- function(t_values, allowed_codes) {
  # Filter t_values that match the regex for allowed T-codes (T300-T508)
  t_values <- grep("^T(3[0-9][0-9]|4[0-9][0-9]|50[0-8]|510)", t_values, value = TRUE)
  
  # Check if there is at least one t_value present for each allowed code
  all_codes_present <- all(sapply(allowed_codes, function(code) {
    any(t_values == code)
  }))
  
  # Return 1 if all allowed codes are present, otherwise return 0
  if(length(t_values) > 0 && all_codes_present && all(t_values %in% allowed_codes)) {
    return(1)
  } else {
    return(0)
  }
}

# Function that checks that at least one drug from two groups are a part of the T36-T50.1 AND T51 codes, but no other T codes present
at_least_two_drugs_only <- function(t_values, allowed_codes1, allowed_codes2) {
  # Filter t_values that match the regex for allowed T-codes within specified range
  t_values <- grep("^T(3[0-9][0-9]|4[0-9][0-9]|50[0-8]|510)", t_values, value = TRUE)
  
  # Filter t_values that match the regex for allowed T-codes in group 1
  t_values_group1 <- intersect(t_values, allowed_codes1)
  
  # Filter t_values that match the regex for allowed T-codes in group 2
  t_values_group2 <- intersect(t_values, allowed_codes2)
  
  # Check if at least one code from each group is present
  codes_group1_present <- length(t_values_group1) > 0
  codes_group2_present <- length(t_values_group2) > 0
  
  # Return 1 if at least one code from each group is present, otherwise return 0
  if(codes_group1_present && codes_group2_present) {
    return(1)
  } else {
    return(0)
  }
}

# Apply the function to each row in the data
stim_only <- sapply(ODs_classified$TRX_REC_AXIS_CD, one_drug_only, allowed_codes = coc_or_ps_only)
opioid_only <- sapply(ODs_classified$TRX_REC_AXIS_CD, one_drug_only, allowed_codes = opioids_only)
coc_only <- sapply(ODs_classified$TRX_REC_AXIS_CD, one_drug_only, allowed_codes = cocaine)
ps_only <- sapply(ODs_classified$TRX_REC_AXIS_CD, one_drug_only, allowed_codes = psychostimulants)
coc_and_ps_only <- sapply(ODs_classified$TRX_REC_AXIS_CD, at_least_one_drug_only, allowed_codes = coc_or_ps_only)
opioid_and_stim_only <- sapply(ODs_classified$TRX_REC_AXIS_CD, function(row) {
  at_least_two_drugs_only(row, allowed_codes1 = opioids_only, allowed_codes2 = coc_or_ps_only)
})

ODs_classified$stim_only <- stim_only
ODs_classified$coc_only <- coc_only
ODs_classified$ps_only <- ps_only
ODs_classified$coc_and_ps_only <- coc_and_ps_only
ODs_classified$opioid_and_stim_only <- opioid_and_stim_only
ODs_classified$opioid_only <- opioid_only

ODs_drug_categories <- ODs_classified %>%
  mutate(
    opioid_and_stim_involved = case_when(
        (heroin == 1 | rx_opioids == 1 | other == 1| fentanyl == 1) &
        (cocaine == 1 | psychostimulants == 1) ~ 1,
      TRUE ~ 0
    ),
    stim_involved = case_when(
      (cocaine == 1 | psychostimulants == 1) ~ 1,
      TRUE ~ 0
    ),
    heroin_only = case_when(
        heroin == 1 &
        rx_opioids == 0 &
        fentanyl == 0 &
        cocaine == 0 &
        psychostimulants == 0 &
        benzos == 0 ~ 1,
      TRUE ~ 0
    ),
    rx_opioids_only = case_when(
      heroin == 0 &
        rx_opioids == 1 &
        fentanyl == 0 &
        cocaine == 0 &
        psychostimulants == 0 &
        benzos == 0 ~ 1,
      TRUE ~ 0
    ),
    rx_opioids_and_heroin_only = case_when(
      heroin == 1 &
        rx_opioids == 1 &
        fentanyl == 0 &
        cocaine == 0 &
        psychostimulants == 0 &
        benzos == 0 ~ 1,
      TRUE ~ 0
    ),
    any_opioids_only = case_when(
      (heroin == 1 | rx_opioids == 1 | other == 1| fentanyl == 1) &
        cocaine == 0 &
        psychostimulants == 0 &
        benzos == 0 &
        alcohol == 0 ~ 1,
      TRUE ~ 0
    ),
     any_opioids = case_when(
      (heroin == 1 | rx_opioids == 1 | other == 1| fentanyl == 1)  ~ 1,
      TRUE ~ 0
    ),
    meth_w_opioids = case_when(
      (heroin == 1 | rx_opioids == 1 | other == 1| fentanyl == 1) &
      psychostimulants == 1 ~ 1,
    TRUE ~ 0),
    any_opioids_nostim = case_when(
      (heroin == 1 | rx_opioids == 1 | other == 1| fentanyl == 1) &
       psychostimulants == 0 & 
       cocaine == 0 ~ 1,
      TRUE ~ 0
    ),
    any_opioids_with_or_without_fent = case_when((
      heroin == 1 | rx_opioids == 1 | fentanyl == 1 | other == 1) ~ 1,
    TRUE ~ 0),
    fentanyl_cocaine_only = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 1 &
        cocaine == 1 &
        psychostimulants == 0 &
        benzos == 0 ~ 1,
      TRUE ~ 0),
    fentanyl_only = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 1 &
        cocaine == 0 &
        psychostimulants == 0 &
        benzos == 0 ~ 1,
      TRUE ~ 0
    ),
     cocaine_any_opioid = case_when(
     (heroin == 1 | rx_opioids == 1 | other == 1| fentanyl == 1) &
        cocaine == 1 &
        psychostimulants == 0 ~ 1,
      TRUE ~ 0
    ),
    psychostimulants_any_opioid = case_when(
     (heroin == 1 | rx_opioids == 1 | other == 1| fentanyl == 1) &
        cocaine == 0 &
        psychostimulants == 1 ~ 1,
      TRUE ~ 0
    ),
    psychostimulant_involved_and_alc = case_when(alcohol == 1 &
                                                   psychostimulants == 1 ~ 1,
                                                 TRUE ~ 0),
    psychostimulant_only_and_alc = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 0 &
        cocaine == 0 &
        alcohol == 1 &
        psychostimulants == 1 &
        benzos == 0 ~ 1,
      TRUE ~ 0
    ),
    psychostimulant_opioids_and_alc = case_when(
      (heroin == 1 |
        rx_opioids == 1 |
        fentanyl == 1) &
        alcohol == 1 &
        psychostimulants == 1 &
        benzos == 0 ~ 1,
      TRUE ~ 0
    ),
    psychostimulant_coc_and_alc = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 0 &
        cocaine == 1 &
        alcohol == 1 &
        psychostimulants == 1 &
        benzos == 0 ~ 1,
      TRUE ~ 0
    ),
    psychostimulant_coc = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        other == 0 &
        fentanyl == 0 &
        cocaine == 1 &
        psychostimulants == 1 &
        alcohol == 0 &
        xylazine == 0 &
        benzos == 0 ~ 1,
      TRUE ~ 0
    ),
    benzos_only = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 0 &
        cocaine == 0 &
        psychostimulants == 0 &
        benzos == 1 ~ 1,
      TRUE ~ 0
    ),
    benzos_rxopioids = case_when(
      heroin == 0 &
        rx_opioids == 1 &
        fentanyl == 0 &
        cocaine == 0 &
        psychostimulants == 0 &
        benzos == 1 ~ 1,
      TRUE ~ 0
    ),
    benzos_cocaine = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 0 &
        cocaine == 1 &
        psychostimulants == 0 &
        benzos == 1 ~ 1,
      TRUE ~ 0
    ),
    benzos_psycostim = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 0 &
        cocaine == 0 &
        psychostimulants == 1 &
        benzos == 1 ~ 1,
      TRUE ~ 0
    ),
    benzos_and_alc = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 0 &
        cocaine == 0 &
        alcohol == 1 &
        psychostimulants == 0 &
        benzos == 1 ~ 1,
      TRUE ~ 0
    ),
    benzos_and_heroin = case_when(
      heroin == 1 &
        rx_opioids == 0 &
        fentanyl == 0 &
        cocaine == 0 &
        alcohol == 0 &
        psychostimulants == 0 &
        benzos == 1 ~ 1,
      TRUE ~ 0
    ),
    benzos_and_fent = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 1 &
        cocaine == 0 &
        alcohol == 0 &
        psychostimulants == 0 &
        benzos == 1 ~ 1,
      TRUE ~ 0
    ),
    benzos_and_anyopioid = case_when(
      heroin == 1 |
        rx_opioids == 1 |
        fentanyl == 1 |
        cocaine == 0 &
        alcohol == 0 &
        psychostimulants == 0 &
        benzos == 1 ~ 1,
      TRUE ~ 0
    ),
    benzos_and_anystim_only = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 0 &
        cocaine == 1 |
        psychostimulants == 1 &
        alcohol == 0 &
        benzos == 1 ~ 1,
      TRUE ~ 0
    ),
    unidentified = case_when(
      heroin == 0 &
        rx_opioids == 0 &
        fentanyl == 0 &
        cocaine == 0 &
        alcohol == 0 &
        psychostimulants == 0 &
        benzos == 0 &
        other == 1 ~ 1,
      TRUE ~ 0
    ),
    any_opioids_with_stim = case_when(
     (heroin == 1 | rx_opioids == 1 | fentanyl == 1 | other == 1) &
       (psychostimulants == 1 | cocaine == 1) ~ 1,
    TRUE ~ 0
    ),
    any_opioids_with_ps = case_when(
     (heroin == 1 | rx_opioids == 1 | fentanyl == 1 | other == 1) &
       psychostimulants == 1 ~ 1,
    TRUE ~ 0
    ),
    any_opioids_with_cocaine = case_when(
     (heroin == 1 | rx_opioids == 1 | fentanyl == 1 | other == 1) &
       psychostimulants == 0 &
        cocaine == 1 ~ 1,
    TRUE ~ 0
    ),
    any_opioids_with_ps_and_coc = case_when(
     (heroin == 1 | rx_opioids == 1 | fentanyl == 1 | other == 1) &
       psychostimulants == 1 &
        cocaine == 1 ~ 1,
    TRUE ~ 0
    ),
  any_stim = case_when(
    (psychostimulants == 1 | cocaine == 1) ~ 1,
    TRUE ~ 0
  ),
  any_xylazine = case_when(
    xylazine == 1 ~ 1,
    TRUE ~ 0
  ),
    xylazine_any_opioid = case_when(
     (heroin == 1 | rx_opioids == 1 | other == 1| fentanyl == 1) &
        xylazine == 1 ~ 1,
      TRUE ~ 0
    ),
  xylazine_any_stim = case_when(
     (cocaine == 1 | psychostimulants == 1) &
        xylazine == 1 ~ 1,
      TRUE ~ 0
  ),
  xylazine_fent = case_when(
     fentanyl == 1 &
     xylazine == 1 ~ 1,
      TRUE ~ 0
  )
  )

```

```{r dates_to_monthyear or quaterly}
#ODs_drug_categories$MonthYear <- ym(format(ymd(ODs_drug_categories$DOD_4_FD), "%Y-%m"))
ODs_drug_categories$QTR <- paste0(year(ODs_drug_categories$DOD_4_FD),         
                              ".0",
                              quarter(ODs_drug_categories$DOD_4_FD))
```

```{r city}
metro_boston_cities <- c("SAUGUS", "REVERE", "EVERETT", "CHELSEA", "WINTHROP", "MILTON", "QUINCY", "BRAINTREE", "HINGHAM", "WEYMOUTH")
ODs_drug_categories <- ODs_drug_categories %>% 
  mutate(boston = case_when(DNAME_CITY == "BOSTON" ~ 1,
                            TRUE ~ 0),
         metro_boston = case_when(DNAME_CITY %in% metro_boston_cities ~ 1,
                                  TRUE ~ 0))

```

```{r aggregate counties}
western_counties <- c("Berkshire", "Hampden", "Hampshire", "Franklin")
central_counties <- c("Worcester")
NE_counties <- c("Essex", "Middlesex", "Suffolk")
SE_counties <- c("Norfolk", "Bristol", "Plymouth", "Barnstable", "Dukes", "Nantucket")
ODs_drug_categories <- ODs_drug_categories %>% 
  mutate(region = case_when(County_name  %in% central_counties ~ "Central",
                          County_name  %in% western_counties ~ "West",
                          County_name  %in% NE_counties ~ "NE",
                          County_name  %in% SE_counties ~ "SE",
                          TRUE ~ "NO REGION")) 
ODs_drug_categories <- ODs_drug_categories %>%
           mutate(region=factor(region,levels=c("West","Central","NE", "SE")))
```


```{r location_type}
categorized_places <- as_tibble(readxl::read_xlsx("Categorized OD Locations.xlsx",
                                        range = "A1:B231"))

ODs_drug_categories <- ODs_drug_categories %>% 
   left_join(categorized_places, by=c("INJRY_PLACEL" = "Place")) 

ODs_drug_categories$Category <- as.factor(ODs_drug_categories$Category)
```

```{r zipcodes}
# Change any 9 digit zip codes to 5 digits
ODs_drug_categories$DZIP9 <- stringr::str_extract(ODs_drug_categories$DZIP9,'\\d{5}')
```

```{r age categories}
ODs_drug_categories <- data.table(ODs_drug_categories)
ODs_drug_categories[, AGE1_RANGE := cut(AGE1_CALC, breaks = c(-1, 15, 30, 45, 60, 110), labels = c("0-14", "15-29", "30-44", "45-59", ">60"))]
```

```{r race by sex cat}
ODs_drug_categories <- ODs_drug_categories %>%
  mutate(SEX_RACE = case_when(
    (SEX == "M" & RACEGROUP == "Hispanic") ~ "Hispanic M", 
    (SEX == "F" & RACEGROUP == "Hispanic") ~ "Hispanic F", 
    (SEX == "M" & RACEGROUP == "White NH") ~ "White NH M", 
    (SEX == "F" & RACEGROUP == "White NH") ~ "White NH F", 
    (SEX == "M" & RACEGROUP == "Black NH") ~ "Black NH M", 
    (SEX == "F" & RACEGROUP == "Black NH") ~ "Black NH F", 
    (SEX == "M" & RACEGROUP == "Asian/PI NH") ~ "Asian/PI NH M", 
    (SEX == "F" & RACEGROUP == "Asian/PI NH") ~ "Asian/PI NH F", 
    (SEX == "M" & RACEGROUP == "American Indian / Alaska Native / Other NH") ~ "American Indian / Alaska Native / Other NH M", 
    (SEX == "F" & RACEGROUP == "American Indian / Alaska Native / Other NH") ~ "American Indian / Alaska Native / Other NH F", 
    TRUE ~ "0")
  )

ODs_drug_categories <- ODs_drug_categories %>% mutate(SEX = case_when(
    (SEX == "M") ~ "Male", 
    (SEX == "F") ~ "Female", 
    TRUE ~ "0")
  )
  
```

```{r drug_summary}
ODs_drug_categories_pared <- ODs_drug_categories %>% 
  select(YOD, DOD_4_FD, SEX, RACEGROUP, AGE1_CALC, DNAME_CITY, DZIP9, DSTATEL, County_name, ESTIMATESBASE2020:SEX_RACE) %>%
  mutate(ID = row_number()) %>%
  mutate(area = case_when(DNAME_CITY == "BOSTON" ~ "BOSTON",
                          DNAME_CITY %in% metro_boston_cities ~ "METRO BOSTON",
                          TRUE ~ "NOT BOSTON")) %>% 
  pivot_longer(c(heroin:xylazine_fent), names_to = "drug_category", values_to = "drug_involved") %>% 
  filter(drug_involved == 1) %>% 
  select(-c(boston, metro_boston, drug_involved))

#totals 
MA_ODs_deaths_by_day <- ODs_drug_categories %>% 
  group_by(DOD_4_FD) %>% 
  summarize("Total Overdose Deaths" = n())
```


```{r drug_summary}
MA_ODs_drugs_by_day <- ODs_drug_categories %>% 
  group_by(DOD_4_FD) %>% 
  summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(ps_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(coc_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>% 
  pivot_longer(!c(DOD_4_FD, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
  ungroup()
```


```{r drug_summary}
# boston and metro boston area
MA_ODs_drugs_by_quarter_city <- ODs_drug_categories %>% 
  group_by(DOD_4_FD, boston, metro_boston) %>% 
   summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(cocaine_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>% 
  pivot_longer(!c(DOD_4_FD, boston, metro_boston, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
  ungroup()

MA_ODs_drugs_by_quarter_fraction_in_bos <- ODs_drug_categories_pared %>% 
  group_by(DOD_4_FD, drug_category, area) %>% 
  summarize("Count" = n()) %>% 
  mutate(Prop = Count/sum(Count)) %>% 
  ungroup()

# location type
MA_ODs_drugs_by_quarter_loc <- ODs_drug_categories %>% 
  group_by(QTR, RACEGROUP, Category) %>% 
   summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(cocaine_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>%  
  pivot_longer(!c(QTR, RACEGROUP, Category, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
  ungroup()

MA_ODs_drugs_by_quarter_fraction_per_loc <- ODs_drug_categories_pared %>% 
  group_by(QTR, drug_category, RACEGROUP, Category) %>% 
  summarize("Count" = n()) %>% 
  mutate(Prop = Count/sum(Count)) %>% 
  ungroup()

# MA CITIES 
MA_ODs_drugs_by_quarter_macity <- ODs_drug_categories %>% 
  group_by(DOD_4_FD, DNAME_CITY, ESTIMATESBASE2020) %>% 
    summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(cocaine_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>%   
  pivot_longer(!c(DOD_4_FD, DNAME_CITY, ESTIMATESBASE2020, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
  ungroup() %>% 
  mutate(std_pop_prop_bycity = num_deaths/ESTIMATESBASE2020)

MA_ODs_drugs_by_quarter_fraction_per_macity <- ODs_drug_categories_pared %>% 
  group_by(DOD_4_FD, drug_category, DNAME_CITY) %>% 
  summarize("Count" = n()) %>% 
  mutate(Prop = Count/sum(Count)) %>% 
  ungroup()


#county analysis 

#FIX TO REMOVE THE POP COUNTS BY INDIVIDUAL YEAR, GO BACK TO USING JUST MOST RECENT CENSUS DATA#

#census pop variables
yearvas <- c(2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019)
MA_POP_multiyear_county <- map_dfr(
  yearvas,
  ~ get_acs(
      geography = "county",
      variables = "B01003_001E",
      state = "MA",
      year = .x,
      survey = "acs1",
      geometry = FALSE
      ),
  .id = "year" 
  ) %>%
  select(-moe) %>%  
  arrange(variable, NAME)

year2000 <- c(2000)
MA_POP_00_county <- map_dfr(
  year2000,
  ~get_decennial(
  geography = "county",
  variables = "P001001",
  state = "MA",
  year = 2000
  ),
  .id = "year")
MA_POP_00_county <- MA_POP_00_county %>%
  mutate(YOD = case_when(
    (year == "1") ~ "2000",
    TRUE ~ "0")
  )
colnames(MA_POP_00_county)[5] <- "estimate"

MA_POP_multiyear_county <- MA_POP_multiyear_county %>%
  mutate(YOD = case_when(
    (year == "1") ~ "2005", 
    (year == "2") ~ "2006",
    (year == "3") ~ "2007",
    (year == "4") ~ "2008",
    (year == "5") ~ "2009",
    (year == "6") ~ "2010",
    (year == "7") ~ "2011",
    (year == "8") ~ "2012",
    (year == "9") ~ "2013",
    (year == "10") ~ "2014",
    (year == "11") ~ "2015",
    (year == "12") ~ "2016",
    (year == "13") ~ "2017",
    (year == "14") ~ "2018",
    (year == "15") ~ "2019",
    TRUE ~ "0")
  )

MA_POP_multiyear_county <- rbind(MA_POP_multiyear_county, MA_POP_00_county)

MA_POP_multiyear_county <- MA_POP_multiyear_county %>%
  mutate(County_name = case_when(
    (NAME == "Barnstable County, Massachusetts") ~ "Barnstable", 
    (NAME == "Berkshire County, Massachusetts") ~ "Berkshire",
    (NAME == "Bristol County, Massachusetts") ~ "Bristol",
    (NAME == "Dukes County, Massachusetts") ~ "Dukes",
    (NAME == "Essex County, Massachusetts") ~ "Essex",
    (NAME == "Franklin County, Massachusetts") ~ "Franklin",
    (NAME == "Hampden County, Massachusetts") ~ "Hampden",
    (NAME == "Hampshire County, Massachusetts") ~ "Hampshire",
    (NAME == "Middlesex County, Massachusetts") ~ "Middlesex",
    (NAME == "Nantucket County, Massachusetts") ~ "Nantucket",
    (NAME == "Norfolk County, Massachusetts") ~ "Norfolk",
    (NAME == "Plymouth County, Massachusetts") ~ "Plymouth",
    (NAME == "Suffolk County, Massachusetts") ~ "Suffolk",
    (NAME == "Worcester County, Massachusetts") ~ "Worcester",
    TRUE ~ "Other Area")
  )

MA_POP_multiyear_county <- select(MA_POP_multiyear_county, c('estimate','County_name','YOD'))
MA_POP_multiyear_county$YOD <- as.numeric(MA_POP_multiyear_county$YOD)

MA_ODs_drugs_by_quarter_county <- ODs_drug_categories %>% 
  group_by(DOD_4_FD, YOD, County_name, region) %>% 
   summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(cocaine_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>%   
  pivot_longer(!c(DOD_4_FD, YOD, County_name, region, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
  ungroup() %>% 
  left_join(MA_POP_multiyear_county, by = c("County_name", "YOD")) %>% 
  mutate(std_pop_prop = num_deaths/estimate)

MA_ODs_drugs_by_quarter_fraction_per_county <- ODs_drug_categories_pared %>% 
  group_by(DOD_4_FD, drug_category, County_name) %>% 
  summarize("Count" = n()) %>% 
  mutate(Prop = Count/sum(Count)) %>% 
  ungroup()

###########
# SIDE ANALYSIS FOR ERIN- create table of percentage for each county by drug involved for comparison to state and DEA numbers

#MA_ODs_drugs_by_year_county <- ODs_drug_categories %>% 
#  group_by(YOD, County_name) %>% 
#  summarize("Total Overdose Deaths" = n(),
#            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
#            "Prop Only Opioids" = sum(any_opioids_no_fent_only)/n(),
#            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
#            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
#            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
#            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
#            "Prop Involving Cocaine" = sum(cocaine)/n(),
#            "Prop Only Cocaine" = sum(cocaine_only)/n(),
#            "Prop Involving Benzos" = sum(benzos)/n(),
#            "Prop Only Benzos" = sum(benzos_only)/n()) %>% 
#  pivot_longer(!c(YOD, County_name, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
#  ungroup() 

#fwrite(MA_ODs_drugs_by_year_county, 'C:/Users/TJH52/Documents/R/r exports/MA_ODs_drugs_by_year_county.csv')
#County_MAOD_by_year <- read_csv("C:/Users/TJH52/Documents/R/r exports/MA_ODs_drugs_by_year_county.csv") 

##########
 
# race/ethnicity

#census race variables
race_vars <- c(
Hispanic = "B03001_003",
`White NH` = "B03002_003",
`Black NH` = "B03002_004",
`Asian/PI NH` = "B03002_006",
`American Indian / Alaska Native / Other NH` = "B03002_005"
)

race_by_yr <- get_acs(geography = "state", variables = race_vars, year = 2020, state = "Massachusetts")

MA_ODs_drugs_by_quarter_raceethnicity <- ODs_drug_categories %>% 
  group_by(YOD, RACEGROUP) %>% 
   summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(cocaine_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>%  
  pivot_longer(!c(YOD, RACEGROUP, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
  ungroup() %>% 
  left_join(race_by_yr, by = c("RACEGROUP" = "variable"))  %>% 
        mutate(num_deaths_proj = case_when(YOD == 2022 ~ num_deaths * 4,
                                      TRUE ~ num_deaths)) %>% 
  mutate(std_race_prop = num_deaths/estimate) %>%
  mutate(std_race_prop_proj = num_deaths_proj/estimate)

MA_ODs_drugs_by_quarter_fraction_per_raceethnicity <- ODs_drug_categories_pared %>% 
  group_by(QTR, drug_category, RACEGROUP) %>% 
  summarize("Count" = n()) %>% 
  mutate(Prop = Count/sum(Count)) %>% 
  ungroup()

#Sex categories
sex_by_yr <- get_acs(geography = "state", 
                     variables = c( `M` = "B01001_002",
                                    `F` = "B01001_026"),
                     year = 2020, 
                     state = "Massachusetts")

MA_ODs_drugs_by_quarter_sex <- ODs_drug_categories %>% 
  group_by(YOD, SEX) %>% 
   summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(cocaine_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>%   
  pivot_longer(!c(YOD, SEX, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
  ungroup()%>% 
  left_join(sex_by_yr, by = c("SEX" = "variable")) %>% 
        mutate(num_deaths_proj = case_when(YOD == 2023 ~ num_deaths * 4,
                                      TRUE ~ num_deaths)) %>%
  mutate(std_sex_prop = num_deaths/estimate) %>%
  mutate(std_sex_prop_proj = num_deaths_proj/estimate)

MA_ODs_drugs_by_quarter_fraction_per_sex <- ODs_drug_categories_pared %>% 
  group_by(SEX) %>% 
  summarize("Count" = n()) %>% 
  mutate(Prop = Count/sum(Count)) %>% 
  ungroup()

#AGE#
ODs_drug_categories_pared <- MA_ODs_drugs_by_quarter_age_stats %>% filter( YOD >= 2017 & YOD <= 2022)
MA_ODs_drugs_by_quarter_age_stats <- ODs_drug_categories_pared %>% 
  summarize("Mean Age" = mean(AGE1_CALC),
            "Median Age" = median(AGE1_CALC),
            "SD Age" = sd(AGE1_CALC),
            "Min Age" = min(AGE1_CALC),
            "Max Age" = max(AGE1_CALC)) 
#race by county
MA_ODs_drugs_by_quarter_racecounty <- ODs_drug_categories %>% 
  group_by(QTR, RACEGROUP, County_name, region) %>% 
   summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(cocaine_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>%  
  pivot_longer(!c(QTR, RACEGROUP, County_name, region, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
  ungroup() 

MA_ODs_drugs_by_quarter_racecounty <- merge(MA_ODs_drugs_by_quarter_racecounty, MA2020_CountyRacePop, by=c("County_name","RACEGROUP")) 
MA_ODs_drugs_by_quarter_racecounty <- MA_ODs_drugs_by_quarter_racecounty %>%
  mutate(std_countyrace_prop = num_deaths/estimate)

# RACE BY CITY
dec_race_vars <- c(
Hispanic = "P4_002N",
`White NH` = "P1_003N",
`Black NH` = "P1_004N",
`Other NH` = "P1_007N", "P1_006N", "P1_005N", "P1_008N" ### FIX THIS- can only have one ####
)

race_by_macity <- get_decennial(geography = "place", variables = dec_race_vars, year = 2020, state = "Massachusetts")

names(race_by_macity)[names(race_by_macity) == 'NAME'] <- 'DNAME_CITY'
race_by_macity$DNAME_CITY <- toupper(race_by_macity$DNAME_CITY)
race_by_macity <- race_by_macity %>%
    mutate(DNAME_CITY = str_remove_all(DNAME_CITY, "TOWN| CITY| CDP|, MASSACHUSETTS"))

MA_ODs_drugs_by_quarter_racecity <- ODs_drug_categories %>% 
  group_by(QTR, DNAME_CITY, RACEGROUP) %>% 
   summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(cocaine_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>%  
  pivot_longer(!c(QTR, DNAME_CITY, RACEGROUP, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
  ungroup() %>%
  left_join(race_by_macity, by = c("DNAME_CITY" = "DNAME_CITY", 'RACEGROUP'='variable')) %>% 
  mutate(std_race_by_macity_prop = num_deaths/value)

# RACE BY Region (aggregated data analysis)
dec_countyrace_vars <- c(
Hispanic = "P2_002N",
`White NH` = "P2_005N",
`Black NH` = "P2_006N",
`Other NH` = "P2_007N", "P2_008N", "P2_009N", "P2_010N" #### FIX THIS - CAN ONLY HAVE ONE ####
)

race_by_macounty <- get_decennial(geography = "county", variables = dec_countyrace_vars, year = 2020, state = "Massachusetts")

names(race_by_macounty)[names(race_by_macounty) == 'NAME'] <- 'County_name'
race_by_macounty$County_name <- tolower(race_by_macounty$County_name)
race_by_macounty <- race_by_macounty %>%
    mutate(County_name = str_remove_all(County_name, " county|, massachusetts"))
race_by_macounty$County_name <- gsub("\\b([a-z])", "\\U\\1", race_by_macounty$County_name, perl=TRUE)

#combine counties 
race_by_macounty <- race_by_macounty %>%
  mutate(region = case_when(County_name  %in% central_counties ~ "Central",
                          County_name  %in% western_counties ~ "West",
                          County_name  %in% NE_counties ~ "NE",
                          County_name  %in% SE_counties ~ "SE",
                          TRUE ~ "NO REGION"))

race_by_macounty$region = as.factor(race_by_macounty$region)
race_by_macounty$variable = as.factor(race_by_macounty$variable)

race_by_macounty <- aggregate(race_by_macounty$value, by = list(race_by_macounty$variable, race_by_macounty$region), FUN = sum)

MA_ODs_drugs_by_quarter_agg_racecounty <- ODs_drug_categories %>% 
  group_by(YOD, region, RACEGROUP) %>% 
   summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(cocaine_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>%   
  pivot_longer(!c(YOD, region, RACEGROUP, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
  ungroup() %>%
  left_join(race_by_macounty, by = c("RACEGROUP" = "Group.1", 'region'='Group.2')) %>% 
  mutate(std_race_by_agg_macounty_prop = num_deaths/x)

#raw counts by county and race 
MA_ODs_drugs_raw <- ODs_drug_categories %>% 
  group_by(QTR, RACEGROUP, County_name, region, DZIP9) %>% 
   summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(cocaine_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>%  
  pivot_longer(!c(QTR, RACEGROUP, County_name, region, DZIP9, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>% 
  ungroup()


age <- ODs_drug_categories %>%
  group_by(DOD_4_FD, AGE1_RANGE) %>%
  summarize("Total Overdose Deaths" = n())

# Race and Age ##THIS NEEDS TO BE FIXED, CAN'T USE STANDARDIZED RACE POP COUNTS AND LEAVE OUT THE STANDARDIZED AGE FACTOR##
MA_ODs_quarter_raceethnicity_age <- ODs_drug_categories %>% 
  group_by(QTR, RACEGROUP, AGE1_RANGE) %>% 
   summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(cocaine_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>%   
  pivot_longer(!c(QTR, RACEGROUP, AGE1_RANGE, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
  ungroup() %>% 
  left_join(race_by_yr, by = c("RACEGROUP" = "variable")) %>% 
  mutate(std_race_prop = num_deaths/estimate)

MA_ODs_quarter_fraction_per_raceethnicity_age <- ODs_drug_categories_pared %>% 
  group_by(QTR, drug_category, RACEGROUP, AGE1_RANGE) %>% 
  summarize("Count" = n()) %>% 
  mutate(Prop = Count/sum(Count)) %>% 
  ungroup()


# Sex by age analysis #
sex_by_age_vars <- c(`Male 0-14` = c("B01001_003", "B01001_004", "B01001_005"),
                     `Male 15-29` = c("B01001_006", "B01001_007", "B01001_008", "B01001_009", "B01001_010", "B01001_011"), ### FIX THIS- CAN ONLY HAVE ONE... MAYBE ADD THEM TOGETHER IN THE END#####
                     `Male 30-44` = c("B01001_012", "B01001_013", "B01001_014"),
                     `Male 45-59` = c("B01001_015", "B01001_016", "B01001_017"),
                     `Male >60` = c("B01001_018", "B01001_019", "B01001_020", "B01001_021", "B01001_022", "B01001_023", "B01001_024", "B01001_025"), 
                     `Female 0-14` = c("B01001_027", "B01001_028", "B01001_029"),
                     `Female 15-29` = c("B01001_030", "B01001_031", "B01001_032", "B01001_033", "B01001_034", "B01001_035"),
                     `Female 30-44` = c("B01001_036", "B01001_037", "B01001_038"),
                     `Female 45-59` = c("B01001_039", "B01001_040", "B01001_041"),
                     `Female >60` = c("B01001_042", "B01001_043", "B01001_044", "B01001_045", "B01001_046", "B01001_047", "B01001_048", "B01001_049"))

sex_by_age_yr <- get_acs(geography = "state", 
                     variables = sex_by_age_vars,
                     year = 2020, 
                     state = "Massachusetts")

MA_ODs_drugs_by_quarter_sex_age <- ODs_drug_categories %>% 
  group_by(YOD, SEX, AGE1_RANGE) %>% 
   summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(cocaine_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>%  
  pivot_longer(!c(YOD, SEX, AGE1_RANGE, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
  ungroup()%>% 
  left_join(sex_by_age_yr, by = c("SEX" = "variable")) %>% 
  mutate(std_sex_AGE_prop = num_deaths/estimate)

# Analysis by race and sex

sex_race_vars <- c(`Hispanic M` = c("B01001I_002"),
                   `Hispanic F` = c("B01001I_017"),
                   `White NH M` = c("B01001A_002"),
                   `White NH F` = c("B01001A_017"),
                   `Black NH M` = c("B01001B_002"),
                   `Black NH F` = c("B01001B_017"),
                   `Asian/PI NH M` = c("B01001D_002"),
                   `Asian/PI NH F` = c("B01001D_017"),
                   `American Indian / Alaska Native / Other NH M` = "B01001C_002",
                   `American Indian / Alaska Native / Other NH F` = "B01001C_017")

sex_race_by_yr <- get_acs(geography = "state", 
                     variables = sex_race_vars,
                     year = 2020, 
                     state = "Massachusetts") 

MA_ODs_drugs_by_quarter_sex_race <- ODs_drug_categories %>% 
  group_by(YOD, SEX_RACE) %>% 
   summarize("Total Overdose Deaths" = n(),
            "Prop Involving Opioids" = sum(any_opioids_with_or_without_fent)/n(),
            "Prop Only Opioids" = sum(any_opioids_only)/n(),
            "Prop Involving Fentanyl" = sum(fentanyl)/n(),
            "Prop Only Fentanyl" = sum(fentanyl_only)/n(),
            "Prop Involving Psychostimulants" = sum(psychostimulants)/n(),
            "Prop Only Psychostimulants" = sum(psychostimulants_only)/n(),
            "Prop Involving Cocaine" = sum(cocaine)/n(),
            "Prop Only Cocaine" = sum(cocaine_only)/n(),
            "Prop Involving Benzos" = sum(benzos)/n(),
            "Prop Only Benzos" = sum(benzos_only)/n(),
            "Prop Involving RX Opioids" = sum(rx_opioids)/n(),
            "Prop Involving Heroin"  = sum(heroin)/n(),
            "Prop Opioid + Stim Involved Deaths" = sum(any_opioids_with_stim)/n(),
            "Prop Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only)/n(),
            "Prop Benzo + Stim Only Deaths" = sum(benzos_and_anystim_only)/n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>%  
  pivot_longer(!c(YOD, SEX_RACE, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths") %>%
  ungroup()%>% 
  left_join(sex_by_yr, by = c("SEX_RACE" = "variable")) %>% 
  mutate(std_sex_prop = num_deaths/estimate)

MA_ODs_drugs_by_quarter_fraction_sex_race <- ODs_drug_categories_pared %>% 
  group_by(QTR, drug_category, SEX_RACE) %>% 
  summarize("Count" = n()) %>% 
  mutate(Prop = Count/sum(Count)) %>% 
  ungroup()

```

```{r plot_drugs_overview}
# Raw counts are e.g., "Involving Opioids" and proportions are e.g., "Prop Involving Opioids"
involving <- c("Involving Cocaine", "Involving Fentanyl", "Involving Opioids", "Involving Psychostimulants", "Involving Benzos")
only <- c("Only Cocaine", "Only Fentanyl", "Only Opioids", "Only Psychostimulants", "Only Benzos")
prop_involving <- c("Prop Involving RX Opioids", "Prop Involving Fentanyl", "Prop Involving Heroin", "Prop Involving Psychostimulants", "Prop Involving Cocaine", "Prop Involving Benzos")
prop_only <- c("Prop Only RX Opioids", "Prop Only Fentanyl", "Prop Only Heroin", "Prop Only Psychostimulants", "Prop Only Cocaine", "Prop Only Benzos")
meth <- c("Involving Meth + Fent")
stim_new <- c("Involving Opioid + PS", "Involving Opioid + Coc", "Involving Any Opioid") 
stim <- c("Only Cocaine", "Only Psychostimulants", "Involving Opioid + PS", "Involving Opioid + Coc", "Involving Any Opioid", "Involving Opioid + Any Stim", "Only Opioids", "Involving Any Opioid- No Stim") 
stim_mut_exclusive <- c("Only Cocaine", "Only Psychostimulants", "Involving Opioid + PS", "Involving Opioid + Coc", "Involving Any Opioid- No Stim")        

#pull table of counts
counts_involving_p <- MA_ODs_drugs_by_quarter %>%
  filter(drug %in% stim,
         YOD > "2014") 

#graphing
overview_involving_p <- MA_ODs_drugs_by_quarter %>%
  filter(drug %in% involving,
         QTR > 2014.1,
         QTR < 2022.4) %>% 
  ggplot(aes(x = QTR, y = num_deaths, group = drug, color = drug)) + 
  geom_line() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Overdose Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") 

n_overview_only_p <- MA_ODs_drugs_by_quarter %>%
  filter(drug %in% stim,
         QTR > 2010.1,
         QTR < 2022.4) %>% 
  ggplot(aes(x = QTR, y = `Total Overdose Deaths`)) + 
  geom_line() +
  #coord_cartesian(ylim=c(0, 250), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Number of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom")

overview_only_p <- MA_ODs_drugs_by_quarter %>%
  filter(drug %in% stim,
         QTR > 2010.1,
         QTR < 2022.4) %>% 
  ggplot(aes(x = QTR, y = num_deaths, group = drug, color = drug)) + 
  geom_line() +
  #coord_cartesian(ylim=c(0, 0.42), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Prop Overdoses Deaths w/ Only Specific Drugs", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") 

overview_involving_by_drug_p <- MA_ODs_drugs_by_quarter %>%
  filter(drug %in% interested,
         YOD > 2010,
         YOD < 2022) %>% 
  ggplot(aes(x = YOD, y = num_deaths, group = drug, color = drug)) + 
  geom_line() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Num of Overdoses Deaths with Specific Drugs", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") 


overview_involving_p
n_overview_involving_p
overview_only_p
overview_involving_by_drug_p

ggsave(plot = overview_involving_by_drug_p, filename = "overview_involving_by_drug_p_xylazine", device = "png", height = 5, width = 9)
```

```{r plots_location_types}
overview_loc_involving_p <- MA_ODs_drugs_by_quarter_loc %>%
  filter(drug %in% involving, QTR > 2015.1, Category %!in% c("UNKNOWN", NA)) %>% 
  ggplot(aes(x = QTR, y = num_deaths, group = drug, color = drug)) + 
# geom_smooth(se = FALSE, span = 0.5) +
  geom_line() +
# coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(RACEGROUP ~ Category)

overview_loc_only_p <- MA_ODs_drugs_by_quarter_loc %>%
  filter(drug %!in% involving, 
          !grepl("Prop",drug),
         Category %!in% c("UNKNOWN", NA)) %>% 
  ggplot(aes(x = QTR, y = num_deaths, group = drug, color = drug)) + 
  #geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~Category)

locations_by_involving_drug_p <- MA_ODs_drugs_by_quarter_fraction_per_loc %>% 
  filter(drug_category %in% involving_categories, Category %!in% c("UNKNOWN", NA)) %>%
  ggplot(aes(x = QTR, y = Prop, group = Category, color = Category)) + 
#  geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
#  coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

locations_by_only_drug_p <- MA_ODs_drugs_by_quarter_fraction_per_loc %>% 
  filter(drug_category %in% only_categories, Category %!in% c("UNKNOWN", NA)) %>%
  ggplot(aes(x = QTR, y = Prop, group = Category, color = Category)) + 
  geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

overview_loc_involving_p
overview_loc_only_p
locations_by_involving_drug_p
locations_by_only_drug_p

# ggsave(plot = overview_involving_p, filename = "overview_loc_involving_p.png", device = "png", height = 5, width = 9)
```

```{r plot_boston}
overview_city_involving_p <- MA_ODs_drugs_by_quarter_city %>%
  filter(drug %in% stim,
         boston == 1,
         DOD_4_FD > "2021-01-01") %>% 
  ggplot(aes(x = DOD_4_FD, y = num_deaths, group = drug, color = drug)) + 
  geom_smooth(se = FALSE, span = 0.5) +
  geom_line() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Number of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") 
  #facet_wrap(vars(boston, metro_boston), labeller = "label_both")

overview_city_only_p <- MA_ODs_drugs_by_quarter_city %>%
  filter(drug %!in% involving) %>% 
  ggplot(aes(x = QTR, y = num_deaths, group = drug, color = drug)) + 
  #geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(vars(boston, metro_boston), labeller = "label_both")

city_by_involving_drug_p <- MA_ODs_drugs_by_quarter_fraction_in_bos %>% 
  filter(drug_category %in% involving_categories) %>%
  ggplot(aes(x = QTR, y = Prop, group = area, color = area)) + 
  #geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

city_by_only_drug_p <- MA_ODs_drugs_by_quarter_fraction_in_bos %>% 
  filter(drug_category %in% only_categories) %>%
  ggplot(aes(x = QTR, y = Prop, group = area, color = area)) + 
  #geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

overview_city_involving_p
overview_city_only_p
city_by_involving_drug_p
city_by_only_drug_p

ggsave(plot = overview_involving_p, filename = "overview_city_involving_p.png", device = "png", height = 5, width = 9)
```

Stimulants + opioids preliminary analysis BOSTON
```{r cdc_analysis_on_boston}
ODs_stim_and_opioids <- ODs_drug_categories %>% 
  select(YOD, QTR, DOD_4_FD, SEX, RACEGROUP, AGE1_RANGE, DNAME_CITY, DZIP9, region) %>%
  mutate(ID = row_number())

ODs_stim_and_opioids <- ODs_drug_categories %>%
  mutate(h_no_f_no_stim = case_when( #OC1S1
    heroin == 1 &
      fentanyl == 0 &
      cocaine == 0 &
      psychostimulants == 0 ~ 1,
    TRUE ~ 0
  ),
  no_h_f_no_stim = case_when( #OC2S1
    heroin == 0 &
      fentanyl == 1 &
      cocaine == 0 &
      psychostimulants == 0 ~ 1,
    TRUE ~ 0
  ),
  h_and_f_no_stim = case_when( #OC3S1
    heroin == 1 &
      fentanyl == 1 &
      cocaine == 0 &
      psychostimulants == 0 ~ 1,
    TRUE ~ 0
  ),
  h_no_f_PS_only = case_when( #OC1S2
    heroin == 1 &
      fentanyl == 0 &
      cocaine == 0 &
      psychostimulants == 1 ~ 1,
    TRUE ~ 0
  ),
  no_h_f_PS_only = case_when( #OC2S2
    heroin == 0 &
      fentanyl == 1 &
      cocaine == 0 &
      psychostimulants == 1 ~ 1,
    TRUE ~ 0
  ),
  h_and_f_PS_only = case_when( #OC3S2
    heroin == 1 &
      fentanyl == 1 &
      cocaine == 0 &
      psychostimulants == 1 ~ 1,
    TRUE ~ 0
  ),
  h_no_f_coc_only = case_when( #OC1S3
    heroin == 1 &
      fentanyl == 0 &
      cocaine == 1 &
      psychostimulants == 0 ~ 1,
    TRUE ~ 0
  ),
  no_h_f_coc_only = case_when( #OC2S3
    heroin == 0 &
      fentanyl == 1 &
      cocaine == 1 &
      psychostimulants == 0 ~ 1,
    TRUE ~ 0
  ),
  h_and_f_coc_only = case_when( #OC3S3
    heroin == 1 &
      fentanyl == 1 &
      cocaine == 1 &
      psychostimulants == 0 ~ 1,
    TRUE ~ 0
  ),
  h_no_f_coc_and_PS = case_when( #OC1S4
    heroin == 1 &
      fentanyl == 0 &
      cocaine == 1 &
      psychostimulants == 1 ~ 1,
    TRUE ~ 0
  ),
  no_h_f_coc_and_PS = case_when( #OC2S4
    heroin == 0 &
      fentanyl == 1 &
      cocaine == 1 &
      psychostimulants == 1 ~ 1,
    TRUE ~ 0
  ),
  h_and_f_coc_and_PS = case_when( #OC3S4
    heroin == 1 &
      fentanyl == 1 &
      cocaine == 1 &
      psychostimulants == 1 ~ 1,
    TRUE ~ 0
  ),
  PS_only = case_when(
    heroin == 0 &
      rx_opioids == 0 &
      other == 0 &
      fentanyl == 0 &
      cocaine == 0 &
      benzos == 0 &
      psychostimulants == 1 ~ 1,
    TRUE ~ 0
  ), 
  Coc_only = case_when(
    heroin == 0 &
      rx_opioids == 0 &
      other == 0 &
      fentanyl == 0 &
      cocaine == 1 &
      benzos == 0 &
      psychostimulants == 0 ~ 1,
    TRUE ~ 0
  ),
   any_opioids_with_stim = case_when(
     (heroin == 1 | rx_opioids == 1 | fentanyl == 1 | other == 1) &
      (psychostimulants == 1 | cocaine == 1) ~ 1,
    TRUE ~ 0
  ),
   any_opioids_w_PS = case_when(
      (heroin == 1 | rx_opioids == 1 | fentanyl == 1 | other == 1) &
        cocaine == 0 &
        psychostimulants == 1 ~ 1,
      TRUE ~ 0
    ),
  any_opioids_w_Coc = case_when(
      (heroin == 1 | rx_opioids == 1 | fentanyl == 1 | other == 1) &
        cocaine == 1 &
        psychostimulants == 0 ~ 1,
      TRUE ~ 0
    ),
  any_stim = case_when(
    (psychostimulants == 1 | cocaine == 1) ~ 1,
    TRUE ~ 0
  ),
  only_stim = case_when(
    heroin == 0 &
      rx_opioids == 0 &
      other == 0 &
      fentanyl == 0 &
      (cocaine == 1 | psychostimulants == 1) ~ 1,
    TRUE ~ 0),
     meth_and_cocaine= case_when(
     (heroin == 1 | rx_opioids == 1 | fentanyl == 1 | other == 1) &
      (psychostimulants == 1 & cocaine == 1) ~ 1,
    TRUE ~ 0
  ),
  )
```

Stimulants + opioids summary and graphing 
```{r}
ODs_stim_and_opioids_summary <- ODs_stim_and_opioids %>% 
  group_by(YOD, region) %>% 
  summarize("Total Overdose Deaths" = n(),
            "Total Stim Deaths" = sum(any_stim),
            "H no Stim" = sum(h_no_f_no_stim),
            "F no Stim" = sum(no_h_f_no_stim),
            "H+F no Stim" = sum(h_and_f_no_stim),
            "H+PS" = sum(h_no_f_PS_only),
            "F+PS" = sum(no_h_f_PS_only),
            "H+F+PS" = sum(h_and_f_PS_only),
            "H+Cocaine" = sum(h_no_f_coc_only),
            "F+Cocaine" = sum(no_h_f_coc_only),
            "H+F+Cocaine" = sum(h_and_f_coc_only),
            "H+PS+Cocaine" = sum(h_no_f_coc_and_PS),
            "F+PS+Cocaine" = sum(no_h_f_coc_and_PS),
            "Stim Only Deaths" = sum(only_stim),
            "PS Only" = sum(PS_only),
            "Cocaine Only" = sum(Coc_only),
            "Opioid + Stim Deaths" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Prop H no Stim" = sum(h_no_f_no_stim)/n(),
            "Prop F no Stim" = sum(no_h_f_no_stim)/n(),
            "Prop H+F no Stim" = sum(h_and_f_no_stim)/n(),
            "Prop H+PS" = sum(h_no_f_PS_only)/n(),
            "Prop F+PS" = sum(no_h_f_PS_only)/n(),
            "Prop H+F+PS" = sum(h_and_f_PS_only)/n(),
            "Prop H+Cocaine" = sum(h_no_f_coc_only)/n(),
            "Prop F+Cocaine" = sum(no_h_f_coc_only)/n(),
            "Prop H+F+Cocaine" = sum(h_and_f_coc_only)/n(),
            "Prop H+PS+Cocaine" = sum(h_no_f_coc_and_PS)/n(),
            "Prop F+PS+Cocaine" = sum(no_h_f_coc_and_PS)/n(),
            "Prop H+F+PS+Cocaine" = sum(h_and_f_coc_and_PS)/n(),
            "Prop Involving PS Only" = sum(PS_only)/sum(any_stim),
            "Prop Involving Cocaine Only" = sum(Coc_only)/sum(any_stim),
            "Prop Involving Opioid + Stim" = sum(any_opioids_with_stim)/sum(any_stim),
            "Prop Involving Opioid + PS" = sum(any_opioids_w_PS)/sum(any_stim),
            "Prop Involving Opioid + Coc" = sum(any_opioids_w_Coc)/sum(any_stim),
            ) %>% 
  pivot_longer(! c(YOD, region, `Total Overdose Deaths`), names_to = "drug", values_to = "num_deaths")  %>%
  ungroup() 

###### Getting Opioid and Stim counts by year in different table structure ########

ODs_stim_short_summary <- ODs_stim_and_opioids %>% 
  group_by(YOD) %>% 
  summarize("Total Stim Deaths" = sum(any_stim),
            ) %>% 
  pivot_longer(! c(YOD), names_to = "Total_Stim", values_to = "num_deaths_stim")  %>%
  ungroup() 

ODs_stim_only_short_summary <- ODs_stim_and_opioids %>% 
  group_by(YOD) %>% 
  summarize("Stim Only Deaths" = sum(only_stim),
            ) %>% 
  pivot_longer(! c(YOD), names_to = "Stim_Only", values_to = "num_deaths_only_stim")  %>%
  ungroup() 

ODs_stim_opioid_short_summary <- ODs_stim_and_opioids %>% 
  group_by(YOD) %>% 
  summarize("Opioid + Stim Deaths" = sum(any_opioids_with_stim),
            ) %>% 
  pivot_longer(! c(YOD), names_to = "Opioid_Stim", values_to = "num_deaths_opioid_stim")  %>%
  ungroup() 

ODs_stim_summary <- print(list(ODs_stim_opioid_short_summary,ODs_stim_short_summary,ODs_stim_only_short_summary) %>% reduce(right_join, by='YOD'))
```


```{r}
#Extrapolate numbers#
ODs_stim_summary <- ODs_stim_summary %>%
        mutate(num_deaths_proj_stim = case_when(YOD == 2023 ~ num_deaths_stim * 2,
                                      TRUE ~ num_deaths_stim),
               num_deaths_proj_only_stim = case_when(YOD == 2023 ~ num_deaths_only_stim * 2,
                                      TRUE ~ num_deaths_only_stim),
               num_deaths_proj_opioid_stim = case_when(YOD == 2023 ~ num_deaths_opioid_stim * 2,
                                      TRUE ~ num_deaths_opioid_stim))

#ODs_stim_and_opioids_summary <- ODs_stim_and_opioids %>% 
#  filter(DNAME_CITY == "BOSTON") %>% 
#  group_by(YOD) %>% 
#  summarize("H no Stim" = sum(h_no_f_no_stim),
#            "F no Stim" = sum(no_h_f_no_stim),
#            "H+F no Stim" = sum(h_and_f_no_stim),
#            "H+PS" = sum(h_no_f_PS_only),
#            "F+PS" = sum(no_h_f_PS_only),
#            "H+F+PS" = sum(h_and_f_PS_only),
#            "H+Cocaine" = sum(h_no_f_coc_only),
#            "F+Cocaine" = sum(no_h_f_coc_only),
#            "H+F+Cocaine" = sum(h_and_f_coc_only),
#            "H+PS+Cocaine" = sum(h_no_f_coc_and_PS),
#            "F+PS+Cocaine" = sum(no_h_f_coc_and_PS),
#            "H+F+PS+Cocaine" = sum(h_and_f_coc_and_PS),
#            ) %>% 
#  pivot_longer(-YOD, names_to = "drug", values_to = "num_deaths")
```


```{r}
##############################################################################
# Graphing the data #
##############################################################################

counties_remove <- c("Barnstable", "Dukes", "Nantucket")
drug_of_interest <- c("Total Stim Deaths", "Opioid + Stim Deaths", "Stim Only Deaths")

S1_p <- ODs_stim_and_opioids_summary %>% 
  filter(drug %in% c("H no Stim", "F no Stim", "H+F no Stim")) %>% 
  ggplot(aes(x = YOD, y = num_deaths, fill = fct_relevel(drug, "H no Stim", "H+F no Stim", "F no Stim"))) + 
  labs(x = "Deaths", y = NULL, title = "S1, No Stimulants", fill = NULL, color = NULL) +
  scale_fill_brewer(palette = "Dark2") +
  #geom_line() +
  geom_col(position = "fill") +
  theme_bw()

S2_p <- ODs_stim_and_opioids_summary %>% 
  filter(drug %in% c("H+Cocaine", "F+Cocaine", "H+F+Cocaine")) %>% 
  ggplot(aes(x = YOD, y = num_deaths, fill = fct_relevel(drug, "H+Cocaine", "F+Cocaine", "H+F+Cocaine"))) + 
  labs(x = NULL, y = NULL, title = "S2, Cocaine Only", fill = NULL, color = NULL) +
  scale_fill_brewer(palette = "Dark2") +
  #geom_line() +
  geom_col(position = "fill") +
  theme_bw()

S3_p <- ODs_stim_and_opioids_summary %>% 
  filter(drug %in% c("H+Cocaine", "F+Cocaine", "H+F+Cocaine"),
         RACEGROUP %in% c("White NH", "Hispanic", "Black NH")) %>% 
  ggplot(aes(x = YOD, y = num_deaths, fill = fct_relevel(drug,"H+Cocaine", "H+F+Cocaine", "F+Cocaine"))) +
  labs(x = NULL, y = NULL, title = "S3, Cocaine Only", fill = NULL, color = NULL) +
  scale_fill_brewer(palette = "Dark2") +
  #geom_line() +
  geom_col(position = "fill") +
  theme_bw() +
  facet_wrap(~RACEGROUP)

S3_g <- ODs_stim_and_opioids_summary %>% 
  filter(drug %in% Stim_Prop,
         YOD > 2002) %>%
  ggplot(aes(x = YOD, y = num_deaths, group = drug, color = drug)) +
  labs(x = NULL, y = NULL, title = "Opioid + Stim Comparison by Region", fill = NULL, color = NULL) +
  geom_line() +
  #geom_bar(position = "stack", stat = 'identity') + 
  #scale_fill_brewer(palette = "Dark2") + 
  theme_bw() +
  facet_wrap(~region)

S4_g <- ODs_stim_and_opioids_summary %>% 
  filter(drug %in% Stim_Prop,
         YOD < 2022) %>% 
  ggplot(aes(x = YOD, y = num_deaths, fill = fct_relevel(drug, "Prop Involving Opioid + PS", "Prop Involving Opioid + Coc", "Prop Involving PS Only", "Prop Involving Cocaine Only"))) + 
  labs(x = NULL, y = NULL, title = "Prop of Substances Found in Stimulant-Related Overdose Deaths: 2000-2022", fill = NULL, color = NULL) +
  scale_fill_brewer(palette = "Dark2") +
  #geom_line() +
  geom_col(position = "fill") +
  theme_bw() 

S4_p <- ODs_stim_and_opioids_summary %>% 
  filter(drug %in% c("H+PS+Cocaine", "F+PS+Cocaine", "H+F+PS+Cocaine")) %>% 
  ggplot(aes(x = YOD, y = num_deaths, fill = fct_relevel(drug, "H+PS+Cocaine", "H+F+PS+Cocaine", "F+PS+Cocaine"))) + 
  labs(x = NULL, y = NULL, title = "S4, PS and Cocaine", fill = NULL, color = NULL) +
  scale_fill_brewer(palette = "Dark2") +
  #geom_line() +
  geom_col(position = "fill") +
  theme_bw()

Stim_OD_race_age_involving_p <- ODs_stim_and_opioids_summary %>%
  filter(drug %in% drug_of_interest,
         RACEGROUP %in% races_of_interest,
         AGE1_RANGE %in% age_of_interest,
         QTR > 2012) %>%
  ggplot(aes(x= QTR, y = num_deaths, color = AGE1_RANGE)) +
  geom_line() +
  #geom_smooth(se = FALSE, span = 0.5) +
  facet_grid(RACEGROUP ~ drug, scales = "free_y")

R<- suppressWarnings(print(Stim_OD_race_age_involving_p))


mycolors <- c("#355C7D", "#6C5B7B", "#C06C84")
Stim_opioid_graph <- ODs_stim_summary %>%
    ggplot() +
  geom_col(aes(x = YOD, y = num_deaths_proj_stim, fill = Total_Stim), size = 0.1) +
  geom_line(aes(x = YOD, y = num_deaths_proj_only_stim, color = Stim_Only, group = 1), size = 1.5) +
  geom_line(aes(x = YOD, y = num_deaths_proj_opioid_stim, color = Opioid_Stim, group = 1), size = 1.5) +
  labs(x = "Year", y = "Number of OD Deaths", title = "Count of Stimulant-Related Deaths in MA: 2000-2023", color = NULL) +
  scale_fill_discrete(name = NULL) +
  scale_fill_manual(values=mycolors) 


S1_p
S2_p
S3_p
S3_g
S4_p
S4_g
Stim_opioid_graph

ggsave(plot = S4_g, filename = "S4_g.png", device = "png", height = 5, width = 9)
```

```{r plot_race}
#Pull table with counts
counts_race_involving_p <- MA_ODs_drugs_by_quarter_raceethnicity %>%
  filter(drug %in% stim,
         YOD > "2014") %>% 
  filter(RACEGROUP %in% c("Black NH", "White NH", "Hispanic"))
write.csv(counts_race_involving_p, "counts_race_involving_p.csv")

#graphing
overview_race_involving_p <- MA_ODs_drugs_by_quarter_raceethnicity %>%
  filter(drug %in% stim_mut_exclusive,
         YOD < "2022-11-01") %>% 
  filter(RACEGROUP %in% c("Black NH", "White NH", "Hispanic")) %>% 
  ggplot(aes(x = YOD, y = num_deaths, group = drug, color = drug)) + 
  # geom_smooth(se = FALSE, span = 0.5) +
  geom_col() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Overdose Deaths", color = NULL) + 
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~RACEGROUP, scales="free_y")

overview_race_involving_p <- overview_race_involving_p + geom_text(aes(y = num_deaths, label = prettyNum(num_deaths, big.mark=","), vjust=-0.2), col = "black")

write_xlsx(MA_ODs_drugs_by_quarter_raceethnicity, "MA_ODs_drugs_by_quarter_raceethnicity.xlsx")

overview_std_race_involving_p <- MA_ODs_drugs_by_quarter_raceethnicity %>%
  filter(drug %in% involving,
         QTR > "2014-11-01") %>% 
  filter(RACEGROUP %!in% c("Unknown")) %>% 
  filter(RACEGROUP %!in% c("Unknown", "American Indian / Alaska Native / Other NH")) %>% 
  ggplot(aes(x = QTR, y = std_race_prop*100000, group = RACEGROUP, color = RACEGROUP)) + 
  #geom_smooth(na.rm=TRUE, span = 0.5) +
  geom_line() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Standardized Overdose Deaths (per 100,000)", color = NULL) + 
  scale_y_continuous(labels = scales::number) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug)

plot_stim_opioid_race <- MA_ODs_drugs_by_quarter_raceethnicity %>%
  filter(drug %in% c("Involving Opioids + Stims", "Stim Only Deaths", "Total Stim Deaths")) %>% 
  filter(RACEGROUP %!in% c("Unknown", "American Indian / Alaska Native / Other NH")) %>% 
  ggplot(aes(x = YOD, y = std_race_prop_proj*100000, group = RACEGROUP, color = RACEGROUP)) + 
  geom_smooth(se = FALSE, na.rm=TRUE, span = 0.5) +
  #geom_line() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Standardized Overdose Deaths (per 100,000)", color = NULL) + 
  scale_y_continuous(labels = scales::number) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") + 
  facet_wrap(~drug)


overview_race_only_p <- MA_ODs_drugs_by_quarter_raceethnicity %>%
  filter(drug %!in% involving) %>% 
  filter(RACEGROUP %in% c("Black NH", "White NH", "Hispanic")) %>%
  ggplot(aes(x = QTR, y = num_deaths, group = drug, color = drug)) + 
  # geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~RACEGROUP)

race_by_involving_drug_p <- MA_ODs_drugs_by_quarter_fraction_per_raceethnicity %>% 
  filter(drug_category %in% involving_categories) %>%
  ggplot(aes(x = QTR, y = Prop, group = RACEGROUP, color = RACEGROUP)) + 
  #geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

race_by_only_drug_p <- MA_ODs_drugs_by_quarter_fraction_per_raceethnicity %>% 
  filter(drug_category %in% only_categories) %>%
  ggplot(aes(x = QTR, y = Prop, group = RACEGROUP, color = RACEGROUP)) + 
  #geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

drugs_by_quarter_raceethnicity <- MA_ODs_drugs_by_quarter_raceethnicity %>%
  filter(drug %in% stim,
         YOD < "2023-11-01") %>% 
   filter(RACEGROUP %in% RACEGROUP_ofinterest) %>% 
  ggplot(aes(x = YOD, y = std_race_prop_proj*100000, group = drug, color = drug)) + 
  geom_smooth(se = FALSE, na.rm=TRUE, span = 0.5) +
  #geom_line() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Standardized Overdose Deaths (per 100,000)", color = NULL) + 
  scale_y_continuous(labels = scales::number) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_grid(~RACEGROUP)

overview_race_involving_p
overview_std_race_involving_p
overview_race_only_p
race_by_involving_drug_p
race_by_only_drug_p
plot_stim_opioid_race
drugs_by_quarter_raceethnicity

ggsave(plot = overview_race_involving_p, filename = "overview_race_involving_p_Aug22.png", device = "png", height = 5, width = 9)
#ggsave(plot = overview_std_race_involving_p, filename = "overview_std_race_involving_p_Aug22.png", device = "png", height = 5, width = 9)
#ggsave(plot = race_by_involving_drug_p, filename = "race_by_involving_drug_p_Aug22.png", device = "png", height = 5, width = 9)
ggsave(plot = drugs_by_quarter_raceethnicity, filename = "drugs_by_quarter_raceethnicity.png", device = "png", height = 5, width = 9)

```

```{r plot_sex}
sex_by_involving_drug_p <- MA_ODs_drugs_by_quarter_fraction_per_sex %>% 
  filter(drug_category %in% involving_categories) %>%
  ggplot(aes(x = QTR, y = Prop, group = SEX, color = SEX)) + 
  geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

sex_by_only_drug_p <- MA_ODs_drugs_by_quarter_fraction_per_sex %>% 
  filter(drug_category %in% only_categories) %>%
  ggplot(aes(x = QTR, y = Prop, group = SEX, color = SEX)) + 
  geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

sex_by_opioid_stim <- MA_ODs_drugs_by_quarter_sex %>% 
  filter(drug %in% c("Involving Opioids + Stims")) %>%
  ggplot(aes(x = YOD, y = std_sex_prop_proj*100000, group = SEX, color = SEX)) + 
  geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::number) +
  labs(x = NULL, y = "Standardized Overdose Deaths (per 100,000)", color = NULL) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") 


sex_by_involving_drug_p
sex_by_only_drug_p
sex_by_opioid_stim

#ggsave(plot = sex_by_involving_drug_p, filename = "sex_by_involving_drug_p_Aug22.png", device = "png", height = 5, width = 9)
#ggsave(plot = sex_by_only_drug_p, filename = "sex_by_only_drug_p_Aug22.png", device = "png", height = 5, width = 9)
ggsave(plot = sex_by_opioid_stim, filename = "sex_by_opioid_stimOct22.png", device = "png", height = 5, width = 9)
```

```{r plot_age}
age_by_involving_drug_p <- MA_ODs_drugs_by_quarter_age_stats %>% 
  filter(drug_category %in% involving_categories) %>%
  ggplot(aes(x = QTR, y = `Mean Age`)) + 
  geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  geom_errorbar(aes(ymin = `Mean Age` - `SD Age`, ymax= `Mean Age` + `SD Age`), width=.1,
                 position=position_dodge(.9)) +
  coord_cartesian(ylim=c(0, 70), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Mean (SD) Age of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

age_by_only_drug_p <- MA_ODs_drugs_by_quarter_age_stats %>% 
  filter(drug_category %in% only_categories) %>%
  ggplot(aes(x = QTR, y = `Mean Age`)) + 
  geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  geom_errorbar(aes(ymin = `Mean Age` - `SD Age`, ymax= `Mean Age` + `SD Age`), width=.1,
                 position=position_dodge(.9)) +
  coord_cartesian(ylim=c(0, 70), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Mean (SD) Age of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

age_by_involving_drug_p
age_by_only_drug_p

#ggsave(plot = age_by_involving_drug_p, filename = "age_by_involving_drug_p_Aug22.png", device = "png", height = 5, width = 9)
#ggsave(plot = age_by_only_drug_p, filename = "age_by_only_drug_pp_Aug22.png", device = "png", height = 5, width = 9)
```

```{r PS_and_alcohol_summary_and_plot}
PS_alc_summary <- ODs_drug_categories %>%
  group_by(QTR) %>%
  summarize(
    "Total Overdose Deaths" = n(),
    "Psychostimulants Involved" = sum(psychostimulants),
    "Psychostimulants Only" = sum(psychostimulants_only),
    "Psychostimulants and Cocaine" = sum(psychostimulant_coc),
    "PS-Involved Deaths with Alcohol" = sum(psychostimulant_involved_and_alc),
    "PS-Only Deaths with Alcohol" = sum(psychostimulant_only_and_alc),
    "Proportion of PS-Involved Deaths with Alcohol" = sum(psychostimulant_involved_and_alc) /
      sum(psychostimulants),
    "Proportion of PS-Only Deaths with Alcohol" = sum(psychostimulant_only_and_alc) /
      sum(psychostimulants_only),
    "Proportion of PS and Opioid Deaths with Alcohol" = sum(psychostimulant_opioids_and_alc)/sum(psychostimulants),
    "Proportion of PS and Cocaine Deaths with Alcohol" = sum(psychostimulant_coc_and_alc)/sum(psychostimulant_coc)
  ) %>%
  pivot_longer(!c(QTR, `Total Overdose Deaths`),
               names_to = "drug",
               values_to = "num_deaths") %>%
  ungroup()

PS_props <- c("Proportion of PS-Involved Deaths with Alcohol", "Proportion of PS-Only Deaths with Alcohol", "Proportion of PS and Opioid Deaths with Alcohol", "Proportion of PS and Cocaine Deaths with Alcohol")

PS_alc_prop_p <- PS_alc_summary %>% 
  filter(drug == "Proportion of PS and Cocaine Deaths with Alcohol",
         QTR < "2021-11-01") %>% 
  ggplot(aes(x = QTR, y = num_deaths)) +
  geom_line(lwd=0.1) +
#  geom_smooth(na.rm = TRUE, span = 0.5, color = "#336B87") + 
#  coord_cartesian(ylim = c(0, 1), expand = FALSE) + 
  labs(x = NULL, y = NULL, title = "Proportion of Psychostimulant and Cocaine (no other substances) Deaths with Alcohol") + 
  theme_bw()
  
PS_alc_prop_p
  
#ggsave(plot = PS_alc_prop_p, filename = "PS_alc_prop_plot.svg", device = "svg", height = 3, width = 5)
```

```{R plots_MAcity}

HEALing_cities <- c("LOWELL", "FALMOUTH", "WORCESTER", "NORTHAMPTON", "BOSTON")
only <- c( "Only Opioids", "Only Fentanyl", "Only Cocaine", "Only Psychostimulants", "Only Benzos")
involving_new <- c("Involving Any Opioid", "Involving Opioid + Any Stim")

overview_macity_involving_p <- MA_ODs_drugs_by_quarter_macity %>%
  filter(drug %in% involving_new, 
         DNAME_CITY %in% HEALing_cities,
         DOD_4_FD > "2022-01-01") %>% 
  ggplot(aes(x = DOD_4_FD, y = num_deaths, group = drug, color = drug)) + 
  #geom_smooth(se = FALSE, span = 0.5) +
  geom_line() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::number) +
  labs(x = NULL, y = "Number of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~DNAME_CITY, scales="free_y")

overview_std_macity_involving_p <- MA_ODs_drugs_by_quarter_macity %>%
  filter(drug %in% stim, DNAME_CITY %in% HEALing_cities) %>% 
  filter(QTR >= 2010.1 & QTR <= 2022.4) %>%
  ggplot(aes(x = QTR, y = std_pop_prop_bycity*100000, group = drug, color = drug)) + 
  geom_smooth(na.rm=TRUE, span = 0.5) +
  geom_line() +
  #geom_point(size = 1.1) + 
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Standardized Overdose Deaths (per 100,000)", color = NULL) + 
  scale_y_continuous(labels = scales::number) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~DNAME_CITY)

std_macity_animate = overview_std_macity_involving_p +
  transition_time(QTR)

overview_macity_only_p <- MA_ODs_drugs_by_quarter_macity %>%
  filter(drug %!in% involving, 
          !grepl("Prop",drug),
         DNAME_CITY %in% HEALing_cities) %>% 
  ggplot(aes(x = QTR, y = num_deaths, group = drug, color = drug)) + 
  geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~DNAME_CITY, scales="free_y")

macity_by_involving_drug_p <- MA_ODs_drugs_by_quarter_fraction_per_macity %>% 
  filter(drug_category %in% involving_categories, DNAME_CITY %in% HEALing_cities) %>%
  ggplot(aes(x = QTR, y = Prop, group = DNAME_CITY, color = DNAME_CITY)) + 
  geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

macity_by_only_drug_p <- MA_ODs_drugs_by_quarter_fraction_per_macity %>% 
  filter(drug_category %in% only_categories, DNAME_CITY %in% HEALing_cities) %>%
  ggplot(aes(x = QTR, y = Prop, group = DNAME_CITY, color = DNAME_CITY)) + 
  geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
#  coord_cartesian(ylim=c(0, 1), expand = FALSE) +
#  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

overview_macity_involving_p
overview_std_macity_involving_p
overview_macity_only_p
macity_by_involving_drug_p
macity_by_only_drug_p

ggsave(plot = overview_macity_involving_p, filename = "overview_macity_involving_p_Aug23.png", device = "png", height = 5, width = 9)
ggsave(plot = overview_std_macity_involving_p, filename = "overview_std_macity_involving_p_Aug22.png", device = "png", height = 5, width = 9)
```

```{r plot MA Counties}
only <- c( "Only Opioids", "Only Fentanyl", "Only Cocaine", "Only Psychostimulants", "Only Benzos")
involving <- c("Involving Cocaine", "Involving Fentanyl")


overview_county_involving_p <- MA_ODs_drugs_by_quarter_county %>%
 filter(drug %in% stim, 
         DOD_4_FD > "2021-01-01") %>% 
  filter(County_name %!in% c("Other Area")) %>% 
  ggplot(aes(x = DOD_4_FD, y = num_deaths, group = drug, color = drug)) + 
  geom_smooth(se = FALSE, span = 0.5) +
  geom_line() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Overdose Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~region)

overview_std_county_involving_p <- MA_ODs_drugs_by_quarter_county %>%
  filter(drug %in% involving,
         QTR < "2021-11-01") %>% 
   filter(County_name %!in% c("Other Area")) %>% 
  ggplot(aes(x = QTR, y = std_pop_prop*100000, group = drug, color = drug)) + 
  #geom_smooth(na.rm=TRUE, span = 0.5) +
  geom_line() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Standardized Overdose Deaths (per 100,000)", color = NULL) + 
  scale_y_continuous(labels = scales::number) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
   facet_wrap(County_name~region)

# ggsave(plot = overview_county_involving_p, filename = "overview_county_involving_bydrug_p.svg", device = "svg", height = 5, width = 9)
# ggsave(plot = overview_std_county_involving_p, filename = "overview_std_county_involving_bydrug__p.svg", device = "svg", height = 5, width = 9)

overview_county_only_p <- MA_ODs_drugs_by_quarter_county %>%
  filter(drug %!in% involving) %>% 
  ggplot(aes(x = QTR, y = num_deaths, group = drug, color = drug)) + 
  # geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~County_name)

county_by_involving_drug_p <- MA_ODs_drugs_by_quarter_fraction_per_county %>% 
  filter(drug_category %in% involving_categories) %>%
  ggplot(aes(x = QTR, y = Prop, group = County_name, color = County_name)) + 
  #geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

county_by_only_drug_p <- MA_ODs_drugs_by_quarter_fraction_per_county %>% 
  filter(drug_category %in% only_categories) %>%
  ggplot(aes(x = QTR, y = Prop, group = County_name, color = County_name)) + 
  #geom_smooth(se = FALSE, span = 0.5) +
  geom_line() + 
  coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Proportion of OD Deaths", color = NULL) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_wrap(~drug_category)

overview_county_involving_p
overview_std_county_involving_p
overview_county_only_p
county_by_involving_drug_p
county_by_only_drug_p

```

```{r graphing race by county}
only <- c( "Only Opioids", "Only Fentanyl", "Only Cocaine", "Only Psychostimulants", "Only Benzos")
involving <- c("Involving Cocaine", "Involving Fentanyl", "Involving Opioids", "Involving Psychostimulants", "Involving Benzos")
races_of_interest <- c("Black NH", "White NH", "Hispanic")

overview_std_countyrace_involving_p <- MA_ODs_drugs_by_quarter_racecounty %>%
  filter(drug %in% involving,
         QTR < "2021-11-01") %>% 
   filter(County_name %in% SE_counties) %>% 
  ggplot(aes(x = QTR, y = std_countyrace_prop*100000, group = drug, color = drug)) + 
  #geom_smooth(na.rm=TRUE, span = 0.5) +
  geom_line() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Standardized Overdose Deaths (per 100,000)", color = NULL) + 
  scale_y_continuous(labels = scales::number) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom")


overview_std_countyrace_involving_p + facet_grid(RACEGROUP ~ County_name, scales='free_y') +
  force_panelsizes(rows = unit(c(2.5, 2, 2, 2, 2), "cm"),
                   cols = unit(c(4, 4, 4, 4), "cm"),
                   TRUE)
  #force_panelsizes(rows = unit(runif(12) + 2, "cm"), 
  #                 cols = unit(c(13, 9, 5), "cm"), 
  #                 TRUE)

countyrace_involving_p <- MA_ODs_drugs_by_quarter_racecounty %>%
  filter(drug %in% involving,
         RACEGROUP %in% races_of_interest,
         County_name %in% counties_of_interest,
         QTR > 2014.1) %>%
  ggplot(aes(x= QTR, y = std_countyrace_prop*100000, color = drug)) +
  geom_point() +
  #geom_smooth() +
  facet_grid(~ County_name)


overview_std_countyrace_involving_p
countyrace_involving_p

ggsave(plot = countyrace_involving_p, filename = "countyrace_involving_p.png", device = "png", height = 3, width = 5)
```

```{r graphing by race by city}
HEALing_cities <- c("LOWELL", "BROCKTON", "HOLYOKE", "PLYMOUTH", "SALEM")
HEALing_cities_pttwo <- c("LAWRENCE", "PITTSFIELD", "SPRINGFIELD", "WEYMOUTH")
only <- c( "Only Opioids", "Only Fentanyl", "Only Cocaine", "Only Psychostimulants", "Only Benzos")
involving <- c("Involving Cocaine", "Involving Fentanyl", "Involving Opioids", "Involving Psychostimulants", "Involving Benzos")
races_of_interest <- c("Black NH", "Hispanic", "White NH")

overview_std_cityrace_involving_p <- MA_ODs_drugs_by_quarter_racecity %>%
  filter(drug %in% involving,
         QTR < "2021-11-01") %>% 
   filter(DNAME_CITY %in% HEALing_cities) %>%
   filter(RACEGROUP %in% races_of_interest) %>%
  ggplot(aes(x = QTR, y = std_race_by_macity_prop*100000, group = drug, color = drug)) + 
  #geom_smooth(na.rm=TRUE, span = 0.5) +
  geom_line() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Standardized Overdose Deaths (per 100,000)", color = NULL) + 
  scale_y_continuous(labels = scales::number) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") 
#  facet_grid(RACEGROUP ~ DNAME_CITY)

overview_std_cityrace_involving_p + facet_grid(RACEGROUP ~ DNAME_CITY, scales='free_y') +
  force_panelsizes(rows = unit(c(1.5, 2, 2, 2, 2), "cm"),
                   cols = unit(c(4, 4, 4), "cm"),
                   TRUE)
  #force_panelsizes(rows = unit(runif(12) + 2, "cm"), 
  #                 cols = unit(c(13, 9, 5), "cm"), 
  #                 TRUE)


overview_std_cityrace_involving_p

```

```{r agg county race graphs}
only <- c( "Only Opioids", "Only Fentanyl", "Only Cocaine", "Only Psychostimulants", "Only Benzos")
involving <- c("Involving Cocaine", "Involving Psychostimulants")
RACEGROUP_ofinterest <- c("Black NH", "Hispanic", "White NH")

#ExtrapolaTE 2022 numbers#
MA_ODs_drugs_by_quarter_agg_racecounty <- MA_ODs_drugs_by_quarter_agg_racecounty %>%
        mutate(std_race_by_agg_macounty_prop_proj = case_when(YOD == 2023 ~ std_race_by_agg_macounty_prop * 2,
                                      TRUE ~ std_race_by_agg_macounty_prop))

overview_std_aggcountyrace_involving_p <- MA_ODs_drugs_by_quarter_agg_racecounty %>%
  filter(drug %in% stim,
         YOD < "2022") %>% 
   filter(RACEGROUP %in% RACEGROUP_ofinterest) %>% 
  ggplot(aes(x = YOD, y = std_race_by_agg_macounty_prop_proj*100000, group = drug, color = drug)) + 
  geom_smooth(se = FALSE, na.rm=TRUE, span = 0.5) +
  #geom_line() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Standardized Overdose Deaths (per 100,000)", color = NULL) + 
  scale_y_continuous(labels = scales::number) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_grid(RACEGROUP ~ region, scales = "free_y")


#overview_std_aggcountyrace_involving_p + facet_grid(drug ~ region, scales='free_y') +
#  force_panelsizes(rows = unit(c(4.5, 4.5, 4.5, 4.5), "cm"),
#                   cols = unit(c(4, 4, 4, 4), "cm"),
#                   TRUE)



overview_std_aggcountyrace_involving_p

ggsave(plot = overview_std_aggcountyrace_involving_p, filename = "overview_std_aggcountyrace_involving_p_Aug23.png", device = "png", height = 5, width = 7)
```



```{r raw count graph by race and county}
involving <- c("Involving Cocaine", "Involving Psychostimulants",  "Involving Fentanyl", "Involving Opioids", "Involving Benzos")
counties_of_interest <- c("Berkshire", "Hampden", "Hampshire", "Franklin", "Worcester", "Essex", "Middlesex")
other_counties_of_interest <- c("Suffolk", "Norfolk", "Bristol", "Plymouth", "Barnstable", "Dukes", "Nantucket")

Graph_ODraw_by_racecounty <- MA_ODs_drugs_raw %>%
  filter(drug %in% involving,
         QTR > 2013.1) %>% 
   filter(RACEGROUP %in% RACEGROUP_ofinterest) %>%
  ggplot(aes(x = QTR, y = num_deaths, group = drug, color = drug)) + 
  geom_line() +
  #coord_cartesian(ylim=c(0, 1), expand = FALSE) +
  #scale_y_continuous(labels = scales::label_percent(accuracy=1)) +
  labs(x = NULL, y = "Overdose Deaths", color = NULL) + 
  scale_y_continuous(labels = scales::number) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1, color="black"),
        axis.text.y = element_text(color="black"),
        legend.position = "bottom") +
  facet_grid(~RACEGROUP, scales = "free_y")

Graph_ODraw_by_racecounty

#create tables#
tab <- table(MA_ODs_drugs_by_quarter_raw$row_variable, MA_ODs_drugs_by_quarter_raw$column_variable)
write.csv(raw_counts, "raw_counts.csv")


```

```{r create spatial map of raw death counts}

Counties_MA <- counties %>%
  mutate(county_name = str_remove_all(county_name, "County")) %>%
  filter(state_name == "Massachusetts")
Counties_MA$county_name <- stringr::str_trim(Counties_MA$county_name)

###############

MASS <-map_data('county', 'massachusetts')

###################

unzip("C:/Users/TJH52/Documents/covid-opioids_analysis/MA_County_Shapefile.zip", 
      exdir = "MA_Shapefile_County", junkpaths = TRUE, 
      overwrite = TRUE)

ZIP_geo <- st_read("C:/Users/TJH52/Documents/covid-opioids_analysis/ma_zip_shapefile/acs2020_5yr_B01003_86000US02370.shp")
ZIP_geo <- dplyr::filter(ZIP_geo,
                            name != "Massachusetts")

qtm(ZIP_geo) +
  tm_legend(show = FALSE)

MA_ODs_drugs_raw_geo <- MA_ODs_drugs_raw %>%
  right_join(ZIP_geo, by = c("DZIP9" = "name"))

poin_geo <- st_as_sf(MA_ODs_drugs_raw,
                     coords = c (x = "lon", y = "lat"),
                     crs = 'WGS 84')

#################

MA_ODs_drugs_raw_geo <- MA_ODs_drugs_raw %>%
  right_join(Counties_MA, by = c("County_name" = "county_name"))

MA_ODs_drugs_raw_geo %>%
  ggplot(aes(long, lat, group = group, fill = num_deaths)) +
    geom_polygon(color = "#ffffff", size = 0.05) +
    coord_map(projection = "albers", lat0 = 39, lat1 = 45)+
  geom_text(data = MA_ODs_drugs_raw_geo, aes(long, lat, label = County_name), color = "darkblue", size = 3) +
  theme(legend.title = element_text(),
        legend.key.width = unit(.5, "in")) +
  labs(fill = "Number of Overdoses") 
```

```{r analysis by race and age}
age_of_interest <- c("11-20", "21-30", "31-40", "41-50", "51-60")

race_age_involving_p <- MA_ODs_quarter_raceethnicity_age %>%
  filter(drug %in% involving,
         RACEGROUP %in% RACEGROUP_ofinterest,
         AGE1_RANGE %in% age_of_interest,
         QTR > 2012) %>%
  ggplot(aes(x= QTR, y = num_deaths, color = AGE1_RANGE)) +
  geom_line() +
#  geom_smooth() +
  facet_grid(RACEGROUP ~ drug, scales = "free_y")

R<- suppressWarnings(print(race_age_involving_p))
```

```{r choropleth map}

# Read in the MSA dataset
state_msa <- read.csv("MSA_STATE_CODES_MA.csv",  header = TRUE, stringsAsFactors = FALSE, sep = ",")

# Merge the state abbreviation data with the state/procedure cost data
state_msa$MSA <- as.character(state_msa$MSA)
MA_county <- MA_ODs_drugs_by_quarter_county %>%
  right_join(state_msa, by = c("County_name"))

counties <- map_data("county")
counties$subregion <- str_to_title(counties$subregion) 
counties <- counties %>%
  filter(region %in% c("massachusetts"))

MA_county <- merge(counties, MA_county, by.x = "subregion", by.y = "County_name", all.x = TRUE, all.y = TRUE)

#### filter surg cats ###
MA_county <- MA_county %>%
  filter(STATE %in% c("massachusetts"))

# Plot a choropleth map of procedure costs by state
MA_county_map <- MA_county %>%
   filter(drug %in% stim) %>% 
  ggplot(aes(x = long, y = lat, group = group, fill = std_pop_prop)) +
  geom_polygon() +
  scale_fill_gradient(low = "pink", high = "purple") +
  coord_fixed(1.3) +
  theme_void() +
  labs(title = "Thyr Costs by State: Inpatient",
       subtitle = "Average Cost for Thyr",
       fill = "Average Cost ($)") +
  geom_text_repel(data = subset(MA_county, std_pop_prop == sum(std_pop_prop)), aes(label = drug), size = 3) +
facet_wrap(~ YOD)
```


```{r Data for daily overdose drug deaths analysis}
MA_ODs_drugs_by_day_county <- ODs_drug_categories %>% 
  group_by(DOD_4_FD, County_name) %>% 
  summarize("Total Overdose Deaths" = n(),
            "Involving Opioids" = sum(any_opioids_with_or_without_fent),
            "Only Opioids" = sum(any_opioids_only),
            "Involving Fentanyl" = sum(fentanyl),
            "Only Fentanyl" = sum(fentanyl_only),
            "Involving Psychostimulants" = sum(psychostimulants),
            "Only Psychostimulants" = sum(psychostimulants_only),
            "Involving Cocaine" = sum(cocaine),
            "Only Cocaine" = sum(cocaine_only),
            "Involving Benzos" = sum(benzos),
            "Only Benzos" = sum(benzos_only),
            "unidentified" = sum(unidentified),
            "Stim Only Deaths" = sum(only_stim),
            "Opioid + Stim Only Deaths" = sum(any_opioids_with_stim_only),
            "Involving Opioid + Any Stim" = sum(any_opioids_with_stim),
            "Involving Opioid + PS" = sum(any_opioids_w_PS),
            "Involving Opioid + Coc" = sum(any_opioids_w_Coc),
            "Involving Any Opioid" = sum(any_opioids),
            "Involving Any Opioid- No Stim" = sum(any_opioids_nostim),
            "Involving Meth + Fent" = sum(meth_fent),
            "Involving Xylazine + any Opioid" = sum(xylazine_any_opioid),
            "Xylazine + any Opioid Only" = sum(xylazine_any_opioid_only),
            "Xylazine + any Stim Only" = sum(xylazine_any_stim_only),
            "Involving Xylazine + any Stim" = sum(xylazine_any_stim),
            "Involving Xylazine + Fent" = sum(xylazine_fent)) %>% 
   pivot_longer(!c(DOD_4_FD, County_name), names_to = "drug", values_to = "num_deaths") %>%
   ungroup()

MA_ODs_deaths_by_day_county <- ODs_drug_categories %>% 
  group_by(DOD_4_FD, County_name) %>% 
  summarize("Total_Overdose_Deaths" = n())

MA_ODs_deaths_by_day_city <- ODs_drug_categories %>% 
  group_by(DOD_4_FD, DNAME_CITY) %>% 
  summarize("Total_Overdose_Deaths" = n())

# This will give us the total overdose deaths in Massachusetts and what cities those deaths occured in for each day
MA_ODs_deaths_by_day <- ODs_drug_categories %>%  
  group_by(DOD_4_FD) %>% 
  summarize("Total_Overdose_Deaths" = n(),
            cities = list(DNAME_CITY))

MA_ODs_deaths_by_day$cities <- sapply(MA_ODs_deaths_by_day$cities, paste, collapse=", ")

MA_ODs_drugs_by_day <- ODs_drug_categories %>% 
  group_by(DOD_4_FD) %>% 
  summarize("Any fent without stim" = sum(fent_wo_stim_only),
            "Meth without fent" = sum (meth_wo_fent),
            "Meth with fent" = sum(meth_w_fent),
            "Coke without fent" = sum(coke_wo_fent),
            "Coke with fent" = sum(coke_w_fent),
            "Any opioids without fent" = sum(any_opioids_involved_wo_fent),
            "Meth and coke" = sum(meth_and_coke)) %>%
     pivot_longer(!c(DOD_4_FD), names_to = "drug", values_to = "num_deaths") %>%
   ungroup()

MA_ODs_deaths_by_day_city_race <- ODs_drug_categories %>% 
  group_by(DOD_4_FD, DNAME_CITY, RACEGROUP) %>% 
  summarize("Total_Overdose_Deaths" = n())


MA_ODs_deaths_by_year_race <- ODs_drug_categories %>% 
  group_by(YOD, RACEGROUP) %>% 
  summarize("Total_Overdose_Deaths" = n())

MA_ODs_deaths_by_day_race <- ODs_drug_categories %>% 
  group_by(DOD_4_FD, RACEGROUP) %>% 
  summarize("Total_Overdose_Deaths" = n())


```


```{r MA yearly population estimates by county (for standardization)}
MA_POP_01_county <- MA_POP_multiyear_county %>% # Our population estimates are missing certain years, so we will just use the population estimate of the closest year
  filter(YOD == 2000) %>%
  mutate(YOD = 2001)
MA_POP_02_county <- MA_POP_01_county %>% mutate(YOD = 2002)
MA_POP_03_county <- MA_POP_multiyear_county %>%
  filter(YOD == 2005) %>%
  mutate(YOD = 2003)
MA_POP_04_county <- MA_POP_03_county %>% mutate(YOD = 2004)
MA_POP_20_county <- MA_POP_multiyear_county %>%
  filter(YOD == 2019) %>%
  mutate(YOD = 2020)
MA_POP_21_county <- MA_POP_20_county %>% mutate(YOD = 2021)
MA_POP_22_county <- MA_POP_20_county %>% mutate(YOD = 2022)
MA_POP_23_county <- MA_POP_20_county %>% mutate(YOD = 2023)

MA_POP_multiyear_temp <- MA_POP_multiyear_county %>%
  filter(County_name == "Nantucket" | County_name == "Dukes")
years <- 2003:2023
county_year <- expand.grid(County_name = unique(MA_POP_multiyear_temp$County_name), YOD = years)
# Nantucket and Dukes only has pop estimates for 2000
nantucket_estimate <- MA_POP_multiyear_county %>% # Our population estimates are missing certain years, so we will just use the population estimate of the closest year
  filter(County_name == "Nantucket")
dukes_estimate <- MA_POP_multiyear_county %>% # Our population estimates are missing certain years, so we will just use the population estimate of the closest year
  filter(County_name == "Dukes")
MA_POP_multiyear_county_temp <- merge(county_year, MA_POP_multiyear_temp , by = c("County_name", "YOD"), all.x = TRUE)
MA_POP_multiyear_county_full <- MA_POP_multiyear_county_temp %>%
  mutate(estimate = if_else(is.na(estimate) & County_name == "Nantucket", nantucket_estimate$estimate, estimate)) %>%
  mutate(estimate = if_else(is.na(estimate) & County_name == "Dukes", dukes_estimate$estimate, estimate))

# Create the dataframe
MA_POP_00_23_county <- bind_rows(MA_POP_multiyear_county, MA_POP_01_county, MA_POP_02_county, MA_POP_03_county, MA_POP_04_county, MA_POP_20_county, MA_POP_21_county, MA_POP_22_county, MA_POP_23_county, MA_POP_multiyear_county_full)
MA_POP_00_23_county <- arrange(MA_POP_00_23_county, YOD) # this data has population estimates for counties for years 00-23
```

```{r MA yearly population estimates by city (for standardization)}
library(readxl)
city_pop_sizes <- read_excel('UMDI_Census_V2022_Subcounty_Estimates.xlsx')

city_pop_sizes <- city_pop_sizes %>%
  rename(Municipality = `Annual Estimates of the Resident Population for Minor Civil Divisions in Massachusetts: April 1, 2010 to July 1, 2022`, 
         County = `...2`,
         Census_2010 = `...3`,
         Estimates_Base_2010 = `...4`,
         "2010" = `...5`,
         "2011" = `...6`, 
         "2012" = `...7`,
         "2013" = `...8`, 
         "2014" = `...9`,
         "2015" = `...10`, 
         "2016" = `...11`,
         "2017" = `...12`,
         "2018" = `...13`,
         "2019" = `...14`,
         Census_2020 = `...15`,
         Estimates_Base_2020 = `...16`, 
         "2020" = `...17`,
         "2021" = `...18`,
         "2022" = `...19`
  )

city_pop_sizes_temp <- city_pop_sizes %>%
  select(Municipality, `2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`,`2019`, `2020`, `2021`, `2022`)
city_pop_sizes_temp <- city_pop_sizes_temp[-(1:2), ]

 
# Transform the dataframe
city_pop_sizes_temp  <- city_pop_sizes_temp  %>%
  mutate(across(`2010`:`2022`, as.numeric, .names = "{.col}"))

MA_POP_10_22_city_temp <- pivot_longer(city_pop_sizes_temp, cols = c(`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`,`2019`, `2020`, `2021`, `2022`), 
                        names_to = "YOD", 
                        values_to = "counts")

# Convert the 'year' column to numeric if necessary
MA_POP_10_22_city_temp$YOD <- as.numeric(as.character(MA_POP_10_22_city_temp$YOD))

# Convert the 'year' column to a numeric type if necessary
MA_POP_10_22_city_temp <- arrange(MA_POP_10_22_city_temp, YOD) # this data has population estimates for counties for years 10-22

MA_POP_10_22_city <- MA_POP_10_22_city_temp %>%
  rename(DNAME_CITY = Municipality) %>%
  mutate(DNAME_CITY = str_to_upper(DNAME_CITY))
```


```{r Dataset that has daily overdose deaths for MA (including missing dates that indicate zero deaths)}
# Add missing dates to the dataset
MA_ODs_deaths_by_day$DOD_4_FD <- as.Date(MA_ODs_deaths_by_day$DOD_4_FD)

# Create a sequence of dates from the minimum to maximum date
all_dates <- seq(as.Date("2000-01-01"), as.Date("2023-12-31"), by = "1 day")

# Create a new dataframe with all dates
complete_data <- data.frame(DOD_4_FD = all_dates)

# Merge your_data with complete_data to fill in missing dates with zero counts
daily_overdose_deaths_ma <- merge(complete_data, MA_ODs_deaths_by_day, by = "DOD_4_FD", all.x = TRUE)

# Replace NAs with zero in the Count column (there were no deaths reported that day based on this dataset)
daily_overdose_deaths_ma$Total_Overdose_Deaths[is.na(daily_overdose_deaths_ma$Total_Overdose_Deaths)] <- 0

daily_overdose_deaths_ma$YOD <- format(daily_overdose_deaths_ma$DOD_4_FD, "%Y") # add year column to make it easy to get daily graphs by year
daily_overdose_deaths_ma$YOD <- as.numeric(daily_overdose_deaths_ma$YOD)
```


```{r Dataset that has daily overdose deaths for each city}
ma_geo <- st_read("zipcodes_nt/ZIPCODES_NT_POLY.shp")
ma_cities <- ma_geo %>%
  group_by(PA_NAME) %>% 
  summarise() # get unique counties 

# Add missing dates to the dataset
MA_ODs_deaths_by_day_city$DOD_4_FD <- as.Date(MA_ODs_deaths_by_day_city$DOD_4_FD)

# Create a sequence of dates from the minimum to maximum date
all_dates <- seq(as.Date("2000-01-01"), as.Date("2023-06-04"), by = "1 day")

# Create a new dataframe with all dates
complete_data <- data.frame(DOD_4_FD = all_dates)

# Merge your_data with complete_data to fill in missing dates with zero counts
daily_overdose_deaths_cities <- merge(complete_data, MA_ODs_deaths_by_day_city, by = "DOD_4_FD", all.x = TRUE)

# Replace NAs with zero in the Count column (there were no deaths reported that day based on this dataset)
daily_overdose_deaths_cities$Total_Overdose_Deaths[is.na(daily_overdose_deaths_cities$Total_Overdose_Deaths)] <- 0

# aggregate counts by city
daily_overdose_deaths_by_city <- daily_overdose_deaths_cities %>%
  group_by(DOD_4_FD, DNAME_CITY) %>%
  summarize(Total_Overdose_Deaths = sum(Total_Overdose_Deaths)) 

# clean up the final dataset so that we have death counts for each county in MA daily
all_days <- unique(daily_overdose_deaths_by_city$DOD_4_FD)
city_day <- expand.grid(DOD_4_FD = all_days, DNAME_CITY = ma_cities$PA_NAME)
daily_overdose_deaths_by_city <- full_join(city_day, daily_overdose_deaths_by_city, by = c("DOD_4_FD", "DNAME_CITY"))
daily_overdose_deaths_by_city <- arrange(daily_overdose_deaths_by_city, DOD_4_FD)
daily_overdose_deaths_by_city$Total_Overdose_Deaths[is.na(daily_overdose_deaths_by_city$Total_Overdose_Deaths)] <- 0 # will add a 0 count for counties with no reported deaths for that week
daily_overdose_deaths_by_city$YOD <- format(daily_overdose_deaths_by_city$DOD_4_FD, "%Y") # add year column to make it easy to get weekly graphs by year
daily_overdose_deaths_by_city$YOD <- as.numeric(daily_overdose_deaths_by_city$YOD)

# Standardization
daily_overdose_deaths_by_city_temp <- merge(daily_overdose_deaths_by_city, MA_POP_10_22_city, by = c("DNAME_CITY", "YOD"))
daily_overdose_deaths_by_city_std <- daily_overdose_deaths_by_city_temp %>%
     mutate(Standardized_Counts = (Total_Overdose_Deaths / counts) * 10000)
daily_overdose_deaths_by_city_std <- arrange(daily_overdose_deaths_by_city_std, DOD_4_FD)
```


```{r Dataset that has standardized daily overdose deaths for each county}
# ma_zipcodes <- st_read("//rfawin.partners.org/mgh-itafisma/CDC Study- Mass Datasets/Mass Vital Statistics/zipcodes_nt/ZIPCODES_NT_POLY.shp")
# get unique counties of MA
ma_geo <- st_read("zipcodes_nt/ZIPCODES_NT_POLY.shp")
ma_counties <- ma_geo %>%
  group_by(COUNTY) %>% 
  mutate(COUNTY = str_to_lower(COUNTY) %>% str_to_title()) %>%
  summarise() # get unique counties 

# Add missing dates to the dataset
MA_ODs_deaths_by_day_county$DOD_4_FD <- as.Date(MA_ODs_deaths_by_day_county$DOD_4_FD)

# Create a sequence of dates from the minimum to maximum date
all_dates <- seq(as.Date("2000-01-01"), as.Date("2023-12-31"), by = "1 day")

# Create a new dataframe with all dates
complete_data <- data.frame(DOD_4_FD = all_dates)

# Merge your_data with complete_data to fill in missing dates with zero counts
daily_overdose_deaths_county <- merge(complete_data, MA_ODs_deaths_by_day_county, by = "DOD_4_FD", all.x = TRUE)

# Replace NAs with zero in the Count column (there were no deaths reported that day based on this dataset)
daily_overdose_deaths_county$Total_Overdose_Deaths[is.na(daily_overdose_deaths_county$Total_Overdose_Deaths)] <- 0

# aggregate counts by county
daily_overdose_deaths_by_county <- daily_overdose_deaths_county %>%
  group_by(DOD_4_FD, County_name) %>%
  summarize(Total_Overdose_Deaths = sum(Total_Overdose_Deaths))

# clean up the final dataset so that we have death counts for each county in MA daily
all_days <- unique(daily_overdose_deaths_by_county$DOD_4_FD)
county_day <- expand.grid(DOD_4_FD = all_days, County_name = ma_counties$COUNTY)
daily_overdose_deaths_by_county <- full_join(county_day, daily_overdose_deaths_by_county, by = c("DOD_4_FD", "County_name"))
daily_overdose_deaths_by_county <- arrange(daily_overdose_deaths_by_county, DOD_4_FD)
daily_overdose_deaths_by_county$Total_Overdose_Deaths[is.na(daily_overdose_deaths_by_county$Total_Overdose_Deaths)] <- 0 # will add a 0 count for counties with no reported deaths for that week
daily_overdose_deaths_by_county$YOD <- format(daily_overdose_deaths_by_county$DOD_4_FD, "%Y") # add year column to make it easy to get weekly graphs by year
daily_overdose_deaths_by_county$YOD <- as.numeric(daily_overdose_deaths_by_county$YOD)

# Standardize dataset by population, 100,000
daily_overdose_deaths_by_county_temp <- merge(daily_overdose_deaths_by_county, MA_POP_00_23_county, by = c("County_name", "YOD"))
daily_overdose_deaths_by_county_std <- daily_overdose_deaths_by_county_temp %>%
     mutate(Standardized_Counts = (Total_Overdose_Deaths / estimate) * 100000)
daily_overdose_deaths_by_county_std <- arrange(daily_overdose_deaths_by_county_std, DOD_4_FD)
```


```{r Dataset that has standardized weekly overdose deaths for each county}
# Change daily data to weekly 
weekly_overdose_deaths_county <- daily_overdose_deaths_county %>%
  group_by(Week = floor_date(DOD_4_FD, "week"), County_name) %>%
  summarize(WeeklyCount = sum(Total_Overdose_Deaths))

# aggregate counts by county
weekly_overdose_deaths_county <- weekly_overdose_deaths_county %>%
  group_by(Week, County_name) %>%
  summarize(Deaths = sum(WeeklyCount))

# clean up the final dataset so that we have death counts for each county in MA weekly
all_weeks <- unique(weekly_overdose_deaths_county$Week)  # Assuming 'week' is a column in your weekly_deaths dataset
county_week <- expand.grid(Week = all_weeks, County_name = ma_counties$COUNTY)
weekly_overdose_deaths_county <- full_join(county_week, weekly_overdose_deaths_county, by = c("Week", "County_name"))
weekly_overdose_deaths_county <- arrange(weekly_overdose_deaths_county, Week)
weekly_overdose_deaths_county$Deaths[is.na(weekly_overdose_deaths_county$Deaths)] <- 0 # will add a 0 count for counties with no reported deaths for that week
weekly_overdose_deaths_county$YOD <- format(weekly_overdose_deaths_county$Week, "%Y") # add year column to make it easy to get weekly graphs by year
weekly_overdose_deaths_county$YOD <- ifelse(weekly_overdose_deaths_county$YOD == 1999, 2000, weekly_overdose_deaths_county$YOD) # change year 1999 to 2000, because the day itself is in the year 2000
weekly_overdose_deaths_county$YOD <- as.numeric(weekly_overdose_deaths_county$YOD)

# Standardize dataset by population, 100,000
weekly_overdose_deaths_county_temp <- merge(weekly_overdose_deaths_county, MA_POP_00_23_county, by = c("County_name", "YOD"))

weekly_overdose_deaths_county_std <- weekly_overdose_deaths_county_temp %>%
     mutate(Standardized_Counts = (Deaths / estimate) * 100000)
weekly_overdose_deaths_county_std <- arrange(weekly_overdose_deaths_county_std, Week) 
```


```{r MA Death Spikes Analysis (Beginning Analyses)}
require(stats)
require(TTR)
require(tseries)

# Change this to get the year you want
year_of_interest = 2022

daily_overdose_deaths_temp <- daily_overdose_deaths_ma %>%
  filter(YOD == year_of_interest)

daily_overdose_deaths_ts <- ts(daily_overdose_deaths_temp$Total_Overdose_Deaths)

# Check if data is stationary 
adf.test(daily_overdose_deaths_ts) # p-value = 0.01 indicates that the data is stationary

# Calculate the moving average
window_size <- 7
threshold <- 2
moving_avg <- stats::filter(daily_overdose_deaths_ts, c(0, rep(1/window_size, window_size)), sides = 1)

residuals <- daily_overdose_deaths_ts - moving_avg
rolling_std <- runSD(residuals, window_size)
rolling_std <- c(NA, head(rolling_std, -1))

df <- data.frame(Date = 1:length(daily_overdose_deaths_ts), Data = daily_overdose_deaths_ts, MovingAvg = moving_avg, RollingStd = rolling_std)
df$Spikes <- ifelse((df$Data - df$MovingAvg) > threshold * df$RollingStd, df$Data, NA)
# df$Spikes <- ifelse((df$Data > 2*df$MovingAvg), df$Data, NA)

ggplot(df, aes(x = Date)) +
  geom_line(aes(y = Data, color = 'Deaths')) +
  geom_point(aes(y = Spikes, color = 'Spikes'), size = 2) +
  geom_line(aes(y = MovingAvg, color = 'Moving Average (14-day)')) +
  theme_minimal() +
  scale_color_manual(name = 'Labels',
    labels = c('Deaths', 'Moving Average (14-day)', 'Spikes'),
    values = c("gray", "lightseagreen", "red")
  ) +
  labs(
    title = paste("Time Series Daily Overdose Death Data with Moving Average and Spikes,", year_of_interest),
    x = "Day",
    y = "Raw Counts of Overdose Deaths"
  ) + 
  ylim(0,17)

print(sum(!is.na(df$Spikes)))

```

```{r Robust peak detection algorithm (using z-scores) - just spikes}
# https://stackoverflow.com/questions/22583391/peak-signal-detection-in-realtime-timeseries-data/22640362#22640362
require(stats)
require(TTR)
require(tseries)
require(patchwork)

daily_overdose_deaths_ts <- ts(daily_overdose_deaths_ma$Total_Overdose_Deaths)

# Check if data is stationary 
adf.test(daily_overdose_deaths_ts) # p-value = 0.01 indicates that the data is stationary

# Robust Peak Detection Algorithm
ThresholdingAlgo <- function(y,lag,threshold,influence) {
  signals <- rep(0,length(y))
  filteredY <- y[1:lag]
  avgFilter <- NULL
  stdFilter <- NULL
  avgFilter[lag] <- mean(y[1:lag], na.rm=TRUE)
  stdFilter[lag] <- sd(y[1:lag], na.rm=TRUE)
  for (i in (lag+1):length(y)){
    if (y[i]-avgFilter[i-1] > threshold*stdFilter[i-1]) {
      signals[i] <- 1
      filteredY[i] <- influence*y[i]+(1-influence)*filteredY[i-1];
    } else {
      signals[i] <- 0
      filteredY[i] <- y[i]
    }
    avgFilter[i] <- mean(filteredY[(i-lag+1):i], na.rm=TRUE)
    stdFilter[i] <- sd(filteredY[(i-lag+1):i], na.rm=TRUE)
  }
  return(list("signals"=signals,"avgFilter"=avgFilter,"stdFilter"=stdFilter))
}

# Set parameters
lag       <- 7 
threshold <- 2
influence <- 0.3 

# Code for looking at specific county
# daily_overdose_deaths_by_county_temp <- daily_overdose_deaths_by_county_std %>%
#   filter(County_name == "Nantucket")

# y <- daily_overdose_deaths_by_county_temp$Standardized_Counts

y <- daily_overdose_deaths_ma$Total_Overdose_Deaths

result <- ThresholdingAlgo(y,lag,threshold,influence)

df <- data.frame(date = daily_overdose_deaths_ma$DOD_4_FD, 
                 y = y, 
                 avgFilter = result$avgFilter, 
                 upperThreshold = result$avgFilter + threshold * result$stdFilter, 
                 signals = result$signals,
                 YOD = daily_overdose_deaths_ma$YOD)
df$year <- year(df$date)
df_modified <- df
df_modified$modified_y <- ifelse(df$signals == 0, 0, df$y)

# Add new column: 'y_minus_avgFilter_or_zero'
# This column is 'y - avgFilter' where signals is not 0, and 0 where signals is 0
df_modified$y_minus_avgFilter_or_zero <- ifelse(df$signals == 0, 0, df$y - df$avgFilter)

# Reshape the data into long format
long_df <- df %>%
  gather(key = "type", value = "value", -date, -signals, -year)

# Uncomment the code below and comment out the for loop below if you simply want plots that indicate whether or not we had a spike for a day
# for (i in (2017:2022)) {
#   variable_name <- paste0("plot", i)
#   long_df <- df %>%
#     gather(key = "type", value = "value", -date, -signals, -year) %>%
#     filter(year == i)
#   plot <- ggplot(long_df, aes(x = date, y = modified_y)) +
#     geom_step(color = "red") +
#     scale_x_date(date_breaks = "1 month", date_labels = "%b") +
#     scale_y_continuous(limits = c(0, 1.5)) +
#     labs(x = "", y = "") +
#     theme_minimal() +
#     ggtitle(i)
#   assign(variable_name,plot)
# }

# This code provides us plots of spikes, such that each spike has a value of the distance between the number of deaths and the rolling avg
for (i in (2017:2022)) {
  variable_name <- paste0("plot", i)
  long_df <- df_modified %>%
    gather(key = "type", value = "value", -date, -signals, -year, -y_minus_avgFilter_or_zero) %>%
    filter(year == i)
  plot <- ggplot(long_df, aes(x = date, y = y_minus_avgFilter_or_zero)) +
    geom_step(color = "red") +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    scale_y_continuous(limits = c(0, 10)) +
    labs(x = "", y = "") +
    theme_minimal() +
    ggtitle(i)
  assign(variable_name,plot)
}

# Plot to get spikes per year (2017-2022)
combined_plot <- plot2022 / plot2021 / plot2020 / plot2019 / plot2018 / plot2017
# / plot2019/ plot2018 / plot2017 / plot2016 / plot2015 / plot2014 / plot2013 / plot2012 / plot2011 / plot2010 / plot2009 / plot2008 / plot2007 / plot2006 / plot2005 / plot2004 / plot2003 / plot2002 / plot2001 / plot2000
combined_plot

```

```{r Analyses for Spikes}
year_of_interest = 2018
# Summary Statistics
long_df <- df %>%
  gather(key = "type", value = "value", -date, -signals, -year) %>%
  filter(year == year_of_interest)

hist(daily_overdose_deaths_ma$Total_Overdose_Deaths, main="Histogram of Data", xlab="Data", border="blue", col="green") # data is non-normal, right skewed

# Number of spikes per year (actual counts)
unique_days_df <- long_df %>%
  distinct(date, .keep_all = TRUE)
sum(unique_days_df$signals)

# Spikes per year (number of spikes within a particular sequence)

# Function to create the sequence vector (this is to find the number of isolated spikes to expand off the idea that sequential spikes may be considered as one spike)
create_sequence_vector <- function(data, seq_length) {
  vec <- numeric()
  count <- 0
  last_one <- -seq_length # Initialize to a value outside the range
  
  for (i in 1:length(data)) {
    if (data[i] == 1) {
      if (i - last_one <= seq_length) {
        count <- count + 1
      } else {
        if (count > 0) vec <- c(vec, count)
        count <- 1
      }
      last_one <- i
    }
  }
  
  if (count > 0) vec <- c(vec, count) # Add the last sequence if needed
  return(vec)
}
sequence_vector <- create_sequence_vector(unique_days_df$signals, 7) 
# Fraction of isolated spikes 
isolated_spikes <- sum(sequence_vector == 1) / sum(sequence_vector)
print(isolated_spikes)

# ACF for spikes
acf(unique_days_df$signals)

# acf do not consider consecutive
modify_sequence <- function(data) {
  # Create a duplicate of the original data
  modified_data <- data
  
  # Initialize a flag to indicate if the previous number was a '1'
  prev_one <- FALSE
  
  # Loop through the data
  for (i in 1:length(modified_data)) {
    if (modified_data[i] == 1) {
      if (prev_one) {
        modified_data[i] <- 0
      }
      prev_one <- TRUE
    } else {
      prev_one <- FALSE
    }
  }
  
  return(modified_data)
}
new_data <- modify_sequence(unique_days_df$signals)
acf(new_data)

# Periods of calm per year
unique_calm_days_df <- long_df %>%
  distinct(date, .keep_all = TRUE) %>%
  filter(signals == 0)
nrow(unique_calm_days_df)


# Gaps between spikes
# Find indices of ones
indices <- which(unique_days_df$signals == 1)
differences <- diff(indices) - 1 # to account for only zeros in between two spikes
differences
mean(differences)
median(differences)
hist(differences, main="Gaps between Spikes ", xlab="Days", breaks = seq(from = min(differences), to = max(differences), by = 1), xlim = c(0, 50), ylim = c(0, 150)) 

# Distance of each spike from the moving average
df_temp <- df %>%
  filter(year == 2019) %>%
  filter(signals == 1)

distance <- df_temp$y - df_temp$avgFilter
hist(distance, main="Distance of Each Spikes From Rolling Moving Average", xlab="Distance", breaks = seq(0, 10, by = 1), xlim = c(0, 10), ylim = c(0, 25)) 

# Average of daily deaths that occur from 2017-2022
daily_overdose_deaths_17_22 <- daily_overdose_deaths_ma %>%
  filter(YOD >= 2017 & YOD <= 2022)
mean(daily_overdose_deaths_17_22$Total_Overdose_Deaths)

# How many fewer deaths are there without the spikes?
df_temp <- df %>%
  filter(YOD == 2019)
df_no_spikes <- df_temp %>%
  mutate(y = case_when(
    signals == 1 ~ avgFilter,
    TRUE ~ y
  ))
sum(df_temp$y)
sum(df_no_spikes$y)
sum(df_temp$y) - sum(df_no_spikes$y)

# Create a histogram of the "size" of consecutive spikes 

# Percentage of deaths the spikes account for
daily_overdose_deaths_17_22 <- daily_overdose_deaths_ma %>%
  filter(YOD >= 2017 & YOD <= 2022)

sum(daily_overdose_deaths_17_22$Total_Overdose_Deaths)

df_temp <- unique_days_df %>%
  filter(year >= 2017 & year <= 2022) %>%
  filter(signals == 1)

sum(df_temp$value) / sum(daily_overdose_deaths_17_22$Total_Overdose_Deaths) * 100
```



```{r Robust peak detection algorithm (using z-scores) - both spikes and dips}
# https://stackoverflow.com/questions/22583391/peak-signal-detection-in-realtime-timeseries-data/22640362#22640362
require(stats)
require(TTR)
require(tseries)
require(patchwork)

daily_overdose_deaths_ts <- ts(daily_overdose_deaths_ma$Total_Overdose_Deaths)

# Check if data is stationary 
adf.test(daily_overdose_deaths_ts) # p-value = 0.01 indicates that the data is stationary

# Original Robust Peak Algorithm that considers both spikes and dips
ThresholdingAlgo <- function(y,lag,threshold,influence) {
  signals <- rep(0,length(y))
  filteredY <- y[1:lag]
  avgFilter <- NULL
  stdFilter <- NULL
  avgFilter[lag] <- mean(y[1:lag], na.rm=TRUE)
  stdFilter[lag] <- sd(y[1:lag], na.rm=TRUE)
  for (i in (lag+1):length(y)){
    if (abs(y[i]-avgFilter[i-1]) > threshold*stdFilter[i-1]) {
      if (y[i] > avgFilter[i-1]) {
        signals[i] <- 1;
      } else {
        signals[i] <- -1;
 
      }
      filteredY[i] <- influence*y[i]+(1-influence)*filteredY[i-1]
    } else {
      signals[i] <- 0
      filteredY[i] <- y[i]
    }
    avgFilter[i] <- mean(filteredY[(i-lag+1):i], na.rm=TRUE)
    stdFilter[i] <- sd(filteredY[(i-lag+1):i], na.rm=TRUE)
  }
  return(list("signals"=signals,"avgFilter"=avgFilter,"stdFilter"=stdFilter))
}

# Parameters
lag       <- 30
threshold <- 2.5
influence <- 0.3

# daily_overdose_deaths_by_county_temp <- daily_overdose_deaths_by_county %>%
#    filter(County_name == "Suffolk")
# y <- daily_overdose_deaths_by_county_temp$Deaths
y <- daily_overdose_deaths_ma$Total_Overdose_Deaths

# Function to create plots
create_plots <- function(geographical_data) {
  y <- geographical_data$Total_Overdose_Deaths
  result <- ThresholdingAlgo(y,lag,threshold,influence)
  df <- data.frame(date = geographical_data$DOD_4_FD, 
                   y = y, 
                   avgFilter = result$avgFilter, 
                   upperThreshold = result$avgFilter + threshold * result$stdFilter, 
                   signals = result$signals,
                   YOD = geographical_data$YOD)
  df$year <- year(df$date)
  df_modified <- df
  df_modified$modified_y <- ifelse(df$signals == 0, 0, df$y)
  df_modified$y_minus_avgFilter_or_zero <- ifelse(df$signals == 0, 0, df$y - df$avgFilter)
  
  # Reshape the data into long format
  long_df <- df %>%
    gather(key = "type", value = "value", -date, -signals, -year)
  unique_days_df <- long_df %>%
    distinct(date, .keep_all = TRUE) 
  
  
  for (i in (2017:2022)) {
    variable_name <- paste0("figure", i)
    df_temp <- geographical_data %>%
      filter(YOD == i)
    df_temp1 <- ts(df_temp$Total_Overdose_Deaths)
    figure <- ggplot(df_temp, aes(x=DOD_4_FD, y=Total_Overdose_Deaths)) +  ggtitle(i) +
    geom_line()
    assign(variable_name,figure)
  }
  
  
  for (i in (2017:2022)) {
    variable_name <- paste0("plot", i)
    long_df <- df_modified %>%
      gather(key = "type", value = "value", -date, -signals, -year, -y_minus_avgFilter_or_zero) %>%
      filter(year == i)
    plot <- ggplot(long_df, aes(x = date, y = y_minus_avgFilter_or_zero)) +
      geom_step(color = "red") +
      scale_x_date(date_breaks = "1 month", date_labels = "%b") +
      scale_y_continuous(limits = c(-10, 10)) +
      labs(x = "", y = "") +
      theme_minimal() +
      ggtitle(i)
    assign(variable_name,plot)
}

  combined_plot <- plot2022 / plot2021 / plot2020 / plot2019 / plot2018 / plot2017
  # / plot2019/ plot2018 / plot2017 / plot2016 / plot2015 / plot2014 / plot2013 / plot2012 / plot2011 / plot2010 / plot2009 / plot2008 / plot2007 / plot2006 / plot2005 / plot2004 / plot2003 / plot2002 / plot2001 / plot2000

  combined_plot1 <- figure2022 / figure2021 / figure2020 / figure2019 / figure2018 / figure2017
  # / plot2019/ plot2018 / plot2017 / plot2016 / plot2015 / plot2014 / plot2013 / plot2012 / plot2011 / plot2010 / plot2009 / plot2008 / plot2007 / plot2006 / plot2005 / plot2004 / plot2003 / plot2002 / plot2001 / plot2000
  library(ggpubr)
  combined <- ggarrange(combined_plot, combined_plot1, ncol=2, nrow=1)
  combined
}

# Get plots for both spikes/dips and time series data each year
plots <- create_plots(daily_overdose_deaths_ma)
plots
```

```{r Analyses for Spikes/Dips}
result <- ThresholdingAlgo(y,lag,threshold,influence)
df <- data.frame(date = daily_overdose_deaths_ma$DOD_4_FD, 
                 y = y, 
                 avgFilter = result$avgFilter, 
                 upperThreshold = result$avgFilter + threshold * result$stdFilter, 
                 signals = result$signals,
                 YOD = daily_overdose_deaths_ma$YOD
                 )

df$cities <- daily_overdose_deaths_ma$cities


long_df <- df %>%
  gather(key = "type", value = "value", -date, -signals, -YOD)

# View cities that occur at spikes
df_temp <- df %>%
  filter(YOD >= 2017 & YOD <= 2022) %>%
  filter(signals == 1)
df_temp$cities <- sapply(df_temp$cities, paste, collapse=", ")

df_temp1 <- daily_overdose_deaths_ma %>%
  filter(YOD >= 2017 & YOD <= 2022) %>%
  select(DOD_4_FD, cities, Total_Overdose_Deaths)

# Total number of deaths
daily_overdose_deaths_ma_filtered <- daily_overdose_deaths_ma %>%
  filter(YOD >= 2017 & YOD <= 2022)
sum(daily_overdose_deaths_ma_filtered$Total_Overdose_Deaths)
# Average number of deaths per day
mean(daily_overdose_deaths_ma_filtered$Total_Overdose_Deaths)

# Spikes per year (actual counts) 
df <- data.frame(date = daily_overdose_deaths_ma$DOD_4_FD, 
                 y = y, 
                 avgFilter = result$avgFilter, 
                 upperThreshold = result$avgFilter + threshold * result$stdFilter, 
                 signals = result$signals,
                 YOD = daily_overdose_deaths_ma$YOD)
df$year <- year(df$date)
  df_modified <- df
  df_modified$modified_y <- ifelse(df$signals == 0, 0, df$y)
  df_modified$y_minus_avgFilter_or_zero <- ifelse(df$signals == 0, 0, df$y - df$avgFilter)
long_df <- df %>%
  gather(key = "type", value = "value", -date, -signals, -year)
unique_days_df <- long_df %>%
  distinct(date, .keep_all = TRUE) %>%
  filter(year == 2021) %>%
  filter(signals == 1)
daily_overdose_deaths1 <-daily_overdose_deaths_17_22 %>%
  filter(YOD == 2022)

sum(unique_days_df$signals)


# Raw counts of spikes
# values <- unique_days_df$value[unique_days_df$signals == 1]
values <- unique_days_df$value
sum(values)
sum(values) / sum(daily_overdose_deaths1$Total_Overdose_Deaths) * 100

# how many deaths do spikes account for?
# Percentage of deaths the spikes account for
daily_overdose_deaths_17_22 <- daily_overdose_deaths_ma %>%
  filter(YOD >= 2017 & YOD <= 2022)

sum(daily_overdose_deaths_17_22$Total_Overdose_Deaths)

df_temp <- unique_days_df %>%
  filter(year >= 2017 & year <= 2022) %>%
  filter(signals == 1)


sum(values) / sum(daily_overdose_deaths_17_22$Total_Overdose_Deaths) * 100
sum(daily_overdose_deaths_17_22$Total_Overdose_Deaths)

# Spikes per year (number of spikes within a particular sequence)
# Function to create the sequence vector
create_sequence_vector <- function(data, seq_length) {
  vec <- numeric()
  count <- 0
  last_one <- -seq_length # Initialize to a value outside the range
  
  for (i in 1:length(data)) {
    if (data[i] == 1) {
      if (i - last_one <= seq_length) {
        count <- count + 1
      } else {
        if (count > 0) vec <- c(vec, count)
        count <- 1
      }
      last_one <- i
    }
  }
  
  if (count > 0) vec <- c(vec, count) # Add the last sequence if needed
  return(vec)
}

sequence_vector <- create_sequence_vector(unique_days_df$signals, 7) 
print(sequence_vector)
print(length(sequence_vector))
# Fraction of isolated spikes 
isolated_spikes <- sum(sequence_vector == 1) / sum(sequence_vector)

print(isolated_spikes)


# acf do not consider consecutive
modify_sequence <- function(data) {
  # Create a duplicate of the original data
  modified_data <- data
  
  # Initialize a flag to indicate if the previous number was a '1'
  prev_one <- FALSE
  
  # Loop through the data
  for (i in 1:length(modified_data)) {
    if (modified_data[i] == 1) {
      if (prev_one) {
        modified_data[i] <- 0
      }
      prev_one <- TRUE
    } else {
      prev_one <- FALSE
    }
  }
  
  return(modified_data)
}
new_data <- modify_sequence(unique_days_df$signals)
acf(new_data)

# Periods of calm per year
unique_calm_days_df <- long_df %>%
  distinct(date, .keep_all = TRUE) %>%
  filter(signals == 0)
nrow(unique_calm_days_df)



MA_ODs_deaths_by_day_county_temp <- MA_ODs_deaths_by_day_county %>%
  filter(County_name == "Hampden")
data <- ts(MA_ODs_deaths_by_day_county_temp$Total_Overdose_Deaths)
plot(data) 

# Raw counts of spikes
# Distance of each spike from the moving average
df_temp <- df %>%
  filter(year == 2019) %>%
  filter(signals == 1)

distance <- df_temp$y - df_temp$avgFilter
hist(distance, main="Distance of Each Spikes From Rolling Moving Average", xlab="Distance", breaks = seq(0, 10, by = 1), xlim = c(0, 10), ylim = c(0, 25)) 

# Average of daily deaths that occur from 2017-2022
daily_overdose_deaths_17_22 <- daily_overdose_deaths_ma %>%
  filter(YOD >= 2017 & YOD <= 2022)
mean(daily_overdose_deaths_17_22$Total_Overdose_Deaths)

# How many fewer deaths are there without the spikes?
df_temp <- df %>%
  filter(YOD == 2019)
df_no_spikes <- df_temp %>%
  mutate(y = case_when(
    signals == 1 ~ avgFilter,
    TRUE ~ y
  ))
sum(df_temp$y)
sum(df_no_spikes$y)
sum(df_temp$y) - sum(df_no_spikes$y)

# Percentage of deaths the spikes account for
daily_overdose_deaths_17_22 <- daily_overdose_deaths_ma %>%
  filter(YOD >= 2017 & YOD <= 2022)

sum(daily_overdose_deaths_17_22$Total_Overdose_Deaths)

df_temp <- unique_days_df %>%
  filter(year >= 2017 & year <= 2022) %>%
  filter(signals == 1)

sum(df_temp$value) / sum(daily_overdose_deaths_17_22$Total_Overdose_Deaths) * 100

```



```{r Number of Suspected Overdoses during each Spike Alert, By City/Race/Type of Drug}
# https://portal.ct.gov/-/media/Departments-and-Agencies/DPH/dph/ems/pdf/SWORD/SWORD-newsletters/2020/20200812-SWORD-Annual-ReportFINAL.pdf

# Attempt to see if there is a pattern in how spikes 'move' across cities
std_deaths_spikes_city <- daily_overdose_deaths_by_city_std  %>% filter(DOD_4_FD %in% df_temp$date) 
filtered_df <- std_deaths_spikes_city %>%
  group_by(DNAME_CITY) %>%
  filter(any(Standardized_Counts > 0)) %>%
  ungroup()
ggplot(filtered_df , aes(x = DOD_4_FD, y = Standardized_Counts, color = DNAME_CITY)) +
  geom_line()


# Compare distributions deaths in cities for spike vs non spike days
MA_ODs_deaths_by_day_city$YOD <- format(MA_ODs_deaths_by_day_city$DOD_4_FD, "%Y") # add year column to make it easy to get weekly graphs by year
MA_ODs_deaths_by_day_city_temp <- MA_ODs_deaths_by_day_city %>% filter(YOD >= 2017 & YOD <= 2022)
MA_ODs_deaths_by_spikes_city_temp <- MA_ODs_deaths_by_day_city_temp %>% filter(DOD_4_FD %in% df_temp$date) 
MA_ODs_deaths_by_spikes_city_temp$Day <- "Spike"
MA_ODs_deaths_by_nonspikes_city_temp <- MA_ODs_deaths_by_day_city_temp %>% filter(DOD_4_FD %!in% df_temp$date) 
MA_ODs_deaths_by_nonspikes_city_temp$Day <- "Non-Spike"
combined_df <- rbind(MA_ODs_deaths_by_spikes_city_temp, MA_ODs_deaths_by_nonspikes_city_temp)

aggregated_data <- combined_df %>%
  group_by(Day, DNAME_CITY) %>%
  summarise(Total_Count = sum(Total_Overdose_Deaths)) 
aggregated_data <- aggregated_data %>% filter(DNAME_CITY %!in% c("BEVERLY", "GLOUCESTER", "GREENFIELD", "NEWBURYPORT", "NEWTON", "WALTHAM"))

contingency_table <- xtabs(Total_Count ~ DNAME_CITY + Day, data = aggregated_data)
chisq_test_result <- chisq.test(contingency_table)
# Print the result
print(chisq_test_result)

ggplot(MA_ODs_deaths_by_nonspikes_city_temp, aes(x = DNAME_CITY, y = Total_Overdose_Deaths)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(x = "City", y = "Total Overdose Deaths", title = "Total Overdose Deaths by City in Non-Spikes, MA (2017-2022)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 8))


# Analysis for race 
# Chi square test between spike and non spike days
MA_ODs_deaths_by_day_race$YOD <- format(MA_ODs_deaths_by_day_race$DOD_4_FD, "%Y") # add year column to make it easy to get weekly graphs by year

require(collapse)
MA_ODs_deaths_by_spike_race <- MA_ODs_deaths_by_day_race %>% filter(DOD_4_FD %in% df_temp$date) 
MA_ODs_deaths_by_spike_race$Day <- "Spike"

MA_ODs_deaths_by_nonspike_race <- MA_ODs_deaths_by_day_race %>% filter(YOD >= 2017 & YOD <= 2022) %>% filter(DOD_4_FD %!in% df_temp$date)
MA_ODs_deaths_by_nonspike_race$Day <- "Non-Spike"

combined_df <- rbind(MA_ODs_deaths_by_spike_race, MA_ODs_deaths_by_nonspike_race)
aggregated_data <- combined_df %>%
  group_by(Day, RACEGROUP) %>%
  summarise(Total_Count = sum(Total_Overdose_Deaths)) 
aggregated_data <- aggregated_data %>% filter(RACEGROUP %in% c("American Indian / Alaska Native / Other NH", "Black NH", "Hispanic", "White NH", "Asian/PI NH"))

contingency_table <- xtabs(Total_Count ~ RACEGROUP + Day, data = aggregated_data)
chisq_test_result <- chisq.test(contingency_table)
# Print the result
print(chisq_test_result)

MA_ODs_deaths_by_spike_race$YOD <- format(MA_ODs_deaths_by_spike_race$DOD_4_FD, "%Y") # add year column to make it easy to get daily graphs by year

MA_ODs_deaths_by_spike_race_temp <- MA_ODs_deaths_by_spike_race %>%
  filter(YOD >= 2017 & YOD <= 2022) %>%
  group_by(RACEGROUP, YOD) %>%
  summarize(Total_Overdose_Deaths = sum(Total_Overdose_Deaths)) 

year_totals <- MA_ODs_deaths_by_spike_race_temp %>% group_by(YOD) %>% summarize(total_count = sum(Total_Overdose_Deaths))
merged_data <- MA_ODs_deaths_by_spike_race_temp  %>% left_join(year_totals, by = "YOD") 

proportions <- merged_data %>%
                 summarize(YOD, proportion = Total_Overdose_Deaths / total_count)
proportions_spikes <- merged_data %>%
                 summarize(YOD, proportion = Total_Overdose_Deaths / total_count)
proportions_nonspikes <- merged_data %>%
                 summarize(YOD, proportion = Total_Overdose_Deaths / total_count)
# all years
ggplot(MA_ODs_deaths_by_spike_race_temp, aes(x = RACEGROUP, y = Total_Overdose_Deaths)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(x = "Race", y = "Total Overdose Deaths", title = "Total Overdose Deaths Daily by Race in MA (2017-2022)") +
  theme_minimal()

#compare two cities
MA_ODs_deaths_by_day_city_race_1 <- MA_ODs_deaths_by_day_city_race %>% filter(DOD_4_FD %!in% df_temp$date) %>% filter(DNAME_CITY == "SPRINGFIELD")

MA_ODs_deaths_by_spike_race$YOD <- format(MA_ODs_deaths_by_spike_race$DOD_4_FD, "%Y") # add year column to make it easy to get daily graphs by year

ggplot(MA_ODs_deaths_by_day_city_race_1, aes(x = RACEGROUP, y = Total_Overdose_Deaths)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(x = "Race", y = "Total Overdose Deaths", title = "Total Overdose Deaths Daily by Race in MA (2017-2022)") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 8)) +
  facet_wrap(~ DNAME_CITY)

MA_ODs_deaths_by_day_city_race$YOD <- format(MA_ODs_deaths_by_day_city_race$DOD_4_FD, "%Y") 
MA_ODs_deaths_by_day_city_race_1 <- MA_ODs_deaths_by_day_city_race %>% filter(YOD >= 2017 & YOD <= 2022) %>% filter(DNAME_CITY == "SPRINGFIELD")
MA_ODs_deaths_by_spike_city_race <- MA_ODs_deaths_by_day_city_race_1 %>% filter(DOD_4_FD %in% df_temp$date) 
MA_ODs_deaths_by_spike_city_race$Day <- "Spike"
MA_ODs_deaths_by_nonspike_city_race <- MA_ODs_deaths_by_day_city_race_1 %>% filter(DOD_4_FD %!in% df_temp$date)
MA_ODs_deaths_by_nonspike_city_race$Day <- "Non-Spike"

combined_df <- rbind(MA_ODs_deaths_by_spike_city_race, MA_ODs_deaths_by_nonspike_city_race)
aggregated_data <- combined_df %>%
  group_by(Day, RACEGROUP) %>%
  summarise(Total_Count = sum(Total_Overdose_Deaths)) 
aggregated_data <- aggregated_data %>% filter(RACEGROUP %in% c("Black NH", "Hispanic", "White NH", "Asian/PI NH"))

contingency_table <- xtabs(Total_Count ~ RACEGROUP + Day, data = aggregated_data)
chisq_test_result <- chisq.test(contingency_table)
# Print the result
print(chisq_test_result)


# faceted by year 
ggplot(MA_ODs_deaths_by_spike_race_temp, aes(x = RACEGROUP, y = Total_Overdose_Deaths)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(x = "Race", y = "Total Overdose Deaths", title = "Total Overdose Deaths Daily by Race in MA (2017-2022)") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 8)) +
  facet_wrap(~ YOD)
MA_ODs_deaths_by_spike_race <- MA_ODs_deaths_by_day_race %>% filter(DOD_4_FD %in% df_temp$date) 

# By Drugs analysis
MA_ODs_drugs_by_day$YOD <- format(MA_ODs_drugs_by_day$DOD_4_FD, "%Y") # add year column to make it easy to get weekly graphs by year
MA_ODs_drugs_by_day <- MA_ODs_drugs_by_day %>%  filter(YOD >= 2017 & YOD <= 2022) 
MA_ODs_drugs_by_spike <- MA_ODs_drugs_by_day %>% filter(DOD_4_FD %in% df_temp$date) 
MA_ODs_drugs_by_spike$Day <- "Spike"

MA_ODs_drugs_by_nonspike <- MA_ODs_drugs_by_day %>% filter(YOD >= 2017 & YOD <= 2022) %>% filter(DOD_4_FD %!in% df_temp$date)
MA_ODs_drugs_by_nonspike$Day <- "Non-Spike"

combined_df <- rbind(MA_ODs_drugs_by_spike, MA_ODs_drugs_by_nonspike)
aggregated_data <- combined_df %>%
  group_by(Day, drug) %>%
  summarise(Total_Count = sum(num_deaths)) 
aggregated_data <- aggregated_data %>% filter(drug %!in% c("Involving Xylazine + Fent", "Involving Xylazine + any Stim", "Xylazine + any Opioid Only", "Xylazine + any Stim Only", "unidentified"))

contingency_table <- xtabs(Total_Count ~ drug + Day, data = aggregated_data)
chisq_test_result <- chisq.test(contingency_table)
# Print the result
print(chisq_test_result)


MA_ODs_drugs_by_spike_temp <- MA_ODs_drugs_by_spike %>%
  filter(YOD >= 2017 & YOD <= 2022) %>%
  group_by(drug, YOD) %>%
  summarize(Total_Overdose_Deaths = sum(num_deaths))


year_totals <- MA_ODs_drugs_by_spike_temp %>% group_by(YOD) %>% summarize(total_count = sum(Total_Overdose_Deaths))
merged_data <- MA_ODs_drugs_by_spike_temp  %>% left_join(year_totals, by = "YOD") 

proportions <- merged_data %>%
                 summarize(YOD, proportion = Total_Overdose_Deaths / total_count)
proportions_spikes <- merged_data %>%
                 summarize(YOD, proportion = Total_Overdose_Deaths / total_count)
proportions_nonspikes <- merged_data %>%
                 summarize(YOD, proportion = Total_Overdose_Deaths / total_count)

ggplot(MA_ODs_drugs_by_nonspike, aes(x = drug, y = num_deaths)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(x = "Drug", y = "Total Overdose Deaths", title = "Total Overdose Deaths by Drug for Non-Spike Days, MA (2017-2022)") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10))
ggplot(MA_ODs_drugs_by_spike_temp, aes(x = drug, y = Total_Overdose_Deaths)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(x = "Drug", y = "Total Overdose Deaths", title = "Total Overdose Deaths by Drug for Non-Spike Days by Drug, MA (2017-2022)") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 8)) +
  facet_wrap(~ YOD)  
```

```{r Find proportions of races in spike/non-spike days}
# MA_ODs_deaths_by_year_sex_race <- ODs_drug_categories %>% 
#   group_by(YOD, SEX_RACE) %>% 
#   summarize("Total_Overdose_Deaths" = n())
# 
# MA_ODs_deaths_by_day_sex_race <- ODs_drug_categories %>% 
#   group_by(DOD_4_FD, SEX_RACE) %>% 
#   summarize("Total_Overdose_Deaths" = n())
# 
# MA_ODs_deaths_by_year_sex_race_temp <- MA_ODs_deaths_by_year_sex_race %>%
#   filter(YOD >= 2017 & YOD <= 2022) 
# MA_ODs_deaths_by_spike_sex_race_temp <-MA_ODs_deaths_by_day_sex_race %>% filter(DOD_4_FD %in% df_temp$date)
# 
# 
# 
# MA_ODs_deaths_by_spike_race_temp <- MA_ODs_deaths_by_day_race %>% filter(DOD_4_FD %!in% df_temp$date)
# MA_ODs_deaths_by_spike_race_temp$YOD <- format(MA_ODs_deaths_by_spike_race_temp$DOD_4_FD, "%Y") # add year column to make it easy to get daily graphs by year
# MA_ODs_deaths_by_spike_race_temp <- MA_ODs_deaths_by_spike_race_temp %>% filter(YOD >= 2017 & YOD <= 2022)
# MA_ODs_deaths_by_spike_race_temp$RACEGROUP <- ifelse(is.na(MA_ODs_deaths_by_spike_race_temp$RACEGROUP) | MA_ODs_deaths_by_spike_race_temp$RACEGROUP %in% c("American Indian / Alaska Native / Other NH", "Asian/PI NH", "American Indian / Alaska Native", "Other NH", "Unknown"), "Other", MA_ODs_deaths_by_spike_race_temp$RACEGROUP)
# 
# 
# MA_ODs_deaths_by_spike_race_temp <- MA_ODs_deaths_by_spike_race_temp %>% group_by(YOD, RACEGROUP) %>% summarise(count = sum(Total_Overdose_Deaths))
# MA_ODs_deaths_by_spike_race_temp$RACEGROUP <- ifelse(is.na(MA_ODs_deaths_by_spike_race_temp$RACEGROUP) | MA_ODs_deaths_by_spike_race_temp$RACEGROUP %in% c("American Indian / Alaska Native / Other NH", "Asian/PI NH", "American Indian / Alaska Native", "Other NH", "Unknown"), "Other", MA_ODs_deaths_by_spike_race_temp$RACEGROUP)
# 
# MA_ODs_deaths_by_spike_sex_race_temp <- MA_ODs_deaths_by_spike_sex_race %>% 
#   mutate(gender = ifelse(substr(SEX_RACE, nchar(SEX_RACE), nchar(SEX_RACE)) == 'F', 'Female', 'Male')) %>%
#   mutate(SEX_RACE = substr(SEX_RACE, 1, nchar(SEX_RACE) - 1)) %>%
#   filter(SEX_RACE != "")
# 
# MA_ODs_deaths_by_spike_sex_race_temp_m <- MA_ODs_deaths_by_spike_sex_race_temp %>%
#   filter(gender == "Male") %>%
#   summarize(count = sum(count))
# 
# MA_ODs_deaths_by_spike_sex_race_temp <- MA_ODs_deaths_by_spike_sex_race_temp %>% group_by(YOD, SEX_RACE) %>% summarise(count = sum(`Total Overdose Deaths`))
# 
# MA_ODs_deaths_by_year_sex_race_temp <- MA_ODs_deaths_by_year_sex_race_temp %>% 
#   mutate(gender = ifelse(substr(SEX_RACE, nchar(SEX_RACE), nchar(SEX_RACE)) == 'F', 'Female', 'Male')) %>%
#   mutate(SEX_RACE = substr(SEX_RACE, 1, nchar(SEX_RACE) - 1)) %>%
#   filter(SEX_RACE != "")
# 
# ggplot(MA_ODs_drugs_by_spike_temp, aes(x = drug, y = `Total Overdose Deaths`)) +
#   geom_bar(stat = "identity", fill = "blue") +
#   labs(x = "Drug", y = "Total Overdose Deaths", title = "Total Overdose Deaths by Drug in MA (2017-2022)") +
#   theme_minimal() + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10))
# 
# ggplot(df_M, aes(x = SEX_RACE, y = `Total Overdose Deaths`)) +
#   geom_bar(stat = "identity", fill = "blue") +
#   labs(x = "Drug", y = "Total Overdose Deaths", title = "Total Overdose Deaths for by Race (Females) in MA (2017-2022)") +
#   theme_minimal() + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 8)) +
#   facet_wrap(~ YOD) 
# 
# 
# MA_ODs_drugs_by_day_race_temp <- MA_ODs_drugs_by_day_race %>% filter(DOD_4_FD %in% df_temp$date) %>% group_by(YOD)
# year_totals <- MA_ODs_drugs_by_day_race_temp %>% group_by(RACEGROUP) %>% summarize(total_count = sum(num_deaths))
# 
# merged_data <- MA_ODs_drugs_by_day_race_temp %>% left_join(year_totals, by = "RACEGROUP") 
# 
# proportions <- merged_data %>%
#                  summarize(RACEGROUP, proportion = num_deaths / total_count)
# 
# MA_ODs_drugs_by_day_race_temp_temp <- MA_ODs_drugs_by_day_race_temp %>% filter(RACEGROUP == "White NH" & drug == "Involving Any Opioid")
# 
# ggplot(MA_ODs_drugs_by_day_race_temp, aes(x = drug, y = num_deaths)) +
#   geom_bar(stat = "identity", fill = "blue") +
#   labs(x = "Drug", y = "Overdose Deaths", title = "Overdose Deaths by Drugs Involved in MA (2017-2022)") +
#   theme_minimal() + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 8)) +
#   facet_wrap(~ RACEGROUP) 
# 
# 
# ggplot(MA_ODs_deaths_by_year_sex_race_temp, aes(x = YOD, y = `Total Overdose Deaths`, group = SEX_RACE, color = SEX_RACE)) +
#     geom_line() +
#     theme_minimal() +
#     labs(title = "Total Overdose Deaths by Race",
#          x = "Year",
#          y = "Total Overdose Deaths") +
#     scale_y_continuous(breaks = seq(from = 0, 
#                                     to = 900, 
#                                     by = 100)) +
#   facet_wrap(~gender)
# 
# ggplot(MA_ODs_deaths_by_spike_sex_race_temp, aes(x = YOD, y = count, group = SEX_RACE, color = SEX_RACE)) +
#     geom_line() +
#     theme_minimal() +
#     labs(title = "Total Overdose Deaths by Race",
#          x = "Year",
#          y = "Total Overdose Deaths") +
#     scale_y_continuous(breaks = seq(from = 0, 
#                                     to = 900, 
#                                     by = 100)) +
#   facet_wrap(~gender)
# 
# 
# ggplot(MA_ODs_deaths_by_year_race_temp, aes(x = YOD, y = `Total Overdose Deaths`, group = RACEGROUP, color = RACEGROUP)) +
#     geom_line() +
#     theme_minimal() +
#     labs(title = "Total Overdose Deaths by Race",
#          x = "Year",
#          y = "Total Overdose Deaths") +
#     scale_y_continuous(breaks = seq(from = 0, 
#                                     to = 1300, 
#                                     by = 100))
# 
# ggplot(MA_ODs_deaths_by_spike_race_temp, aes(x = YOD, y = count, group = RACEGROUP, color = RACEGROUP)) +
#     geom_line() +
#     theme_minimal() +
#     labs(title = "Total Overdose Deaths by Race",
#          x = "Year",
#          y = "Total Overdose Deaths") +
#     scale_y_continuous(breaks = seq(from = 0, 
#                                     to = 1300, 
#                                     by = 100))
# 
# 
# 
# nonspike_race <- MA_ODs_deaths_by_spike_race_temp %>%
#   group_by(RACEGROUP) %>%
#   summarise(count = sum(count))
# 
# spike_race$spikes <- "Spike"
# 
# nonspike_race$spikes <- "Nonspike"
# 
# combined_df <- rbind(nonspike_race, spike_race)
# 
# # Create contingency table
# table_data <- xtabs(count ~ RACEGROUP + spikes, data = combined_df)
# fisher_result <- chisq.test(table_data)
# # View the results
# print(fisher_result)
# 
# 
# MA_ODs_drugs_by_day$YOD <- format(MA_ODs_drugs_by_day$DOD_4_FD, "%Y") # add year column to make it easy to get daily graphs by year
# 
# MA_ODs_drugs_by_day_temp <- MA_ODs_drugs_by_day %>% filter(YOD == 2022)
# 
# MA_ODs_drugs_by_day_temp <- MA_ODs_drugs_by_day_temp %>% filter(DOD_4_FD %!in% df_temp$date)
# MA_ODs_drugs_by_day_temp <- MA_ODs_drugs_by_day_temp %>% group_by(YOD, drug) %>% summarise(count = sum(num_deaths))
# 
# nonspike_drug <- MA_ODs_drugs_by_day_temp%>%
#   group_by(drug) %>%
#   summarise(count = sum(count))
# spike_drug$spikes <- "Spike"
# nonspike_drug$spikes <- "Nonspike"
# combined_df <- rbind(nonspike_drug, spike_drug)
# table_data <- xtabs(count ~ drug + spikes, data = combined_df)
# 
# fisher_result <- fisher.test(table_data, workspace = 100000000)
# 
# # View the results
# print(fisher_result)

```


```{r Identify spikes by city}
lag       <- 30
threshold <- 2.5
influence <- 0.3

cities <- unique(daily_overdose_deaths_by_city$DNAME_CITY)

for (i in 1:length(cities)) {
  daily_overdose_deaths_by_county_temp <- daily_overdose_deaths_by_city %>%
  filter(YOD >= 2017 & YOD <= 2022) %>%
  filter(cities[i])
  
  y <- geographical_data$Total_Overdose_Deaths
  result <- ThresholdingAlgo(y,lag,threshold,influence)
  df <- data.frame(date = geographical_data$DOD_4_FD, 
                   y = y, 
                   avgFilter = result$avgFilter, 
                   upperThreshold = result$avgFilter + threshold * result$stdFilter, 
                   signals = result$signals,
                   YOD = geographical_data$YOD)
  df$year <- year(df$date)
}

#    filter(County_name == "Suffolk")
# y <- daily_overdose_deaths_by_county_temp$Deaths


create_plots <- function(geographical_data) {
  y <- geographical_data$Total_Overdose_Deaths
  result <- ThresholdingAlgo(y,lag,threshold,influence)
  df <- data.frame(date = geographical_data$DOD_4_FD, 
                   y = y, 
                   avgFilter = result$avgFilter, 
                   upperThreshold = result$avgFilter + threshold * result$stdFilter, 
                   signals = result$signals,
                   YOD = geographical_data$YOD)
  df$year <- year(df$date)
  df_modified <- df
  df_modified$modified_y <- ifelse(df$signals == 0, 0, df$y)
  df_modified$y_minus_avgFilter_or_zero <- ifelse(df$signals == 0, 0, df$y - df$avgFilter)
  
  # Reshape the data into long format
  long_df <- df %>%
    gather(key = "type", value = "value", -date, -signals, -year)
  unique_days_df <- long_df %>%
    distinct(date, .keep_all = TRUE) 
  
  
  for (i in (2017:2022)) {
    variable_name <- paste0("figure", i)
    df_temp <- geographical_data %>%
      filter(YOD == i)
    df_temp1 <- ts(df_temp$Total_Overdose_Deaths)
    figure <- ggplot(df_temp, aes(x=DOD_4_FD, y=Total_Overdose_Deaths)) +  ggtitle(i) +
    geom_line()
    assign(variable_name,figure)
  }
  
  
  # look at spikes not in a binary way as well
  for (i in (2017:2022)) {
    variable_name <- paste0("plot", i)
    long_df <- df_modified %>%
      gather(key = "type", value = "value", -date, -signals, -year, -y_minus_avgFilter_or_zero) %>%
      filter(year == i)
    plot <- ggplot(long_df, aes(x = date, y = y_minus_avgFilter_or_zero)) +
      geom_step(color = "red") +
      scale_x_date(date_breaks = "1 month", date_labels = "%b") +
      scale_y_continuous(limits = c(-10, 10)) +
      labs(x = "", y = "") +
      theme_minimal() +
      ggtitle(i)
    assign(variable_name,plot)
}

  combined_plot <- plot2022 / plot2021 / plot2020 / plot2019 / plot2018 / plot2017
  # / plot2019/ plot2018 / plot2017 / plot2016 / plot2015 / plot2014 / plot2013 / plot2012 / plot2011 / plot2010 / plot2009 / plot2008 / plot2007 / plot2006 / plot2005 / plot2004 / plot2003 / plot2002 / plot2001 / plot2000
  combined_plot
  
  combined_plot1 <- figure2022 / figure2021 / figure2020 / figure2019 / figure2018 / figure2017
  # / plot2019/ plot2018 / plot2017 / plot2016 / plot2015 / plot2014 / plot2013 / plot2012 / plot2011 / plot2010 / plot2009 / plot2008 / plot2007 / plot2006 / plot2005 / plot2004 / plot2003 / plot2002 / plot2001 / plot2000
  combined_plot1
  library(ggpubr)
  combined <- ggarrange(combined_plot, combined_plot1, ncol=2, nrow=1)
  combined
}

```


```{r MA Death Spikes (Multi-Window) Analysis}
daily_overdose_deaths_temp <- daily_overdose_deaths_ma %>%
  filter(YOD == 2018)

daily_overdose_deaths_ts <- ts(daily_overdose_deaths_temp$Total_Overdose_Deaths)

threshold <- 2

# 3-day
window_size <- 3
moving_avg_3 <- stats::filter(daily_overdose_deaths_ts, c(0, rep(1/window_size, window_size)), sides = 1)
residuals_3 <- daily_overdose_deaths_ts - moving_avg_3
rolling_std_3 <- runSD(residuals_3, window_size)
rolling_std_3 <- c(NA, head(rolling_std_3, -1))

# 7-day
window_size <- 7
moving_avg_7 <- stats::filter(daily_overdose_deaths_ts, c(0, rep(1/window_size, window_size)), sides = 1)
residuals_7 <- daily_overdose_deaths_ts - moving_avg_7
rolling_std_7 <- runSD(residuals_7, window_size)
rolling_std_7 <- c(NA, head(rolling_std_7, -1))

# 14-day
window_size <- 14
moving_avg_14 <- stats::filter(daily_overdose_deaths_ts, c(0, rep(1/window_size, window_size)), sides = 1)
residuals_14 <- daily_overdose_deaths_ts - moving_avg_14
rolling_std_14 <- runSD(residuals_14, window_size)
rolling_std_14 <- c(NA, head(rolling_std_14, -1))

df <- data.frame(Date = 1:length(daily_overdose_deaths_ts), Data = daily_overdose_deaths_ts, MovingAvg3 = moving_avg_3, RollingStd3 = rolling_std_3, MovingAvg7 = moving_avg_7, RollingStd7 = rolling_std_7, MovingAvg14 = moving_avg_14, RollingStd14 = rolling_std_14)
df$Spikes3 <- ifelse((df$Data - df$MovingAvg3) > threshold * df$RollingStd3, df$Data, NA)
df$Spikes7 <- ifelse((df$Data - df$MovingAvg7) > threshold * df$RollingStd7, df$Data, NA)
df$Spikes14 <- ifelse((df$Data - df$MovingAvg14) > threshold * df$RollingStd14, df$Data, NA)

df_count_spikes <- df %>%  
  select(Spikes3, Spikes7, Spikes14)

row_has_non_na <- apply(df_count_spikes, 1, function(row) any(!is.na(row)))
# Convert logical to numeric
row_has_non_na_numeric <- as.numeric(row_has_non_na)
print(sum(row_has_non_na_numeric))

ggplot(df, aes(x = Date)) +
  geom_line(aes(y = Data), color = 'gray') +
  geom_point(aes(y = Spikes14), color = 'red', size = 1.5) +
  geom_point(aes(y = Spikes7), color = 'red', size = 1.5) +
  geom_point(aes(y = Spikes3), color = 'red', size = 1.5) +
  theme_minimal() +
  labs(
    title = "Time Series Daily Overdose Death Data with Moving Average and Spikes, 2022",
    x = "Day",
    y = "Raw Counts of Overdose Deaths"
  ) + 
  ylim(0,17)
```



```{r Weekly overdose deaths analysis}
# library(tseries)
# library(forecast)
# 
# threshold <- 0.2
# 
# # For every year
# weekly_overdose_deaths_county_std_suffolk <- weekly_overdose_deaths_county_std %>%
#   filter(County_name == "Suffolk") %>%
#   filter(YOD == 2019) %>%
#   mutate(Difference = c(NA, diff(Standardized_Counts)))
# 
# 
# expected_counts <- rep(mean(weekly_overdose_deaths_county_std_suffolk$Standardized_Counts), length(weekly_overdose_deaths_county_std_suffolk$Standardized_Counts))
# 
# chisq.test(weekly_overdose_deaths_county_std_suffolk$Standardized_Counts, p = expected_counts)
# 
# 
# ggplot(weekly_overdose_deaths_county_std_suffolk, aes(x = Week, y = Difference)) +
#   geom_segment(data = subset(weekly_overdose_deaths_county_std_suffolk, Difference > threshold),
#                aes(x = as.Date(Week), xend = as.Date(Week),
#                    y = 0, yend = Difference),
#                color = "red") +
#   theme_minimal() +
#   ggtitle("Temporal Trend of Standardized Rate of Overdose Death Differences in", weekly_overdose_deaths_county_std_suffolk$County_name[1]) +  # Add plot title
#   xlab("Year") +  # Rename X-axis
#   ylab("Weekly Standardized Rate of Overdose Death Difference") +  # Rename Y-axis
#   ylim(c(0, 1.5)) +  # Set Y-axis limits
#   theme_minimal()
# 
# weekly_overdose_deaths_county_std_middlesex <- weekly_overdose_deaths_county_std %>%
#   filter(County_name == "Middlesex") %>%
#   filter(YOD > 2019) %>%
#   mutate(Difference = c(NA, diff(Standardized_Counts)))
# 
# ggplot(weekly_overdose_deaths_county_std_middlesex, aes(x = Week, y = Difference)) +
#   geom_segment(data = subset(weekly_overdose_deaths_county_std_middlesex, Difference > threshold),
#                aes(x = as.Date(Week), xend = as.Date(Week),
#                    y = 0, yend = Difference),
#                color = "red") +
#   theme_minimal() +
#   ggtitle("Temporal Trend of Standardized Rate of Overdose Death Differences in", weekly_overdose_deaths_county_std_middlesex$County_name[1]) +  # Add plot title
#   xlab("Year") +  # Rename X-axis
#   ylab("Weekly Standardized Rate of Overdose Death Difference") +  # Rename Y-axis
#   ylim(c(0, 1.5)) +  # Set Y-axis limits
#   theme_minimal()
# 
# weekly_overdose_deaths_county_std_norfolk <- weekly_overdose_deaths_county_std %>%
#   filter(County_name == "Norfolk") %>%
#   filter(YOD > 2019) %>%
#   mutate(Difference = c(NA, diff(Standardized_Counts)))
# 
# ggplot(weekly_overdose_deaths_county_std_norfolk, aes(x = Week, y = Difference)) +
#   geom_segment(data = subset(weekly_overdose_deaths_county_std_norfolk, Difference > threshold),
#                aes(x = as.Date(Week), xend = as.Date(Week),
#                    y = 0, yend = Difference),
#                color = "red") +
#   theme_minimal() +
#   ggtitle("Temporal Trend of Standardized Rate of Overdose Death Differences in", weekly_overdose_deaths_county_std_norfolk$County_name[1]) +  # Add plot title
#   xlab("Year") +  # Rename X-axis
#   ylab("Weekly Standardized Rate of Overdose Death Difference") +  # Rename Y-axis
#   ylim(c(0, 1.5)) +  # Set Y-axis limits
#   theme_minimal()
# 
# weekly_overdose_deaths_county_std_essex <- weekly_overdose_deaths_county_std %>%
#   filter(County_name == "Essex") %>%
#   filter(YOD > 2019) %>%
#   mutate(Difference = c(NA, diff(Standardized_Counts)))
# 
# ggplot(weekly_overdose_deaths_county_std_essex, aes(x = Week, y = Difference)) +
#   geom_segment(data = subset(weekly_overdose_deaths_county_std_essex, Difference > threshold),
#                aes(x = as.Date(Week), xend = as.Date(Week),
#                    y = 0, yend = Difference),
#                color = "red") +
#   theme_minimal() +
#   ggtitle("Temporal Trend of Standardized Rate of Overdose Death Differences in", weekly_overdose_deaths_county_std_essex$County_name[1]) +  # Add plot title
#   xlab("Year") +  # Rename X-axis
#   ylab("Weekly Standardized Rate of Overdose Death Difference") +  # Rename Y-axis
#   ylim(c(0, 1.5)) +  # Set Y-axis limits
#   theme_minimal()
# 
# weekly_overdose_deaths_county_std_suffolk_ts <- ts(weekly_overdose_deaths_county_std_suffolk$Standardized_Counts, frequency = 52)
# weekly_overdose_deaths_county_std_m_ts <- ts(weekly_overdose_deaths_county_std_m$Standardized_Counts, frequency = 52)
# 
# # Plot weekly trends, check for heteroscedasticity
# plot(weekly_overdose_deaths_county_std_suffolk_ts, type = "l", main = "Time Series Plot", xlab = "Time", ylab = "Standardized Rate of Overdose Deaths")
# plot(weekly_overdose_deaths_county_std_suffolk$Week, weekly_overdose_deaths_county_std_suffolk$Standardized_Counts, type = "l")
# plot(weekly_overdose_deaths_county_std_m_ts, type = "l", main = "Time Series Plot", xlab = "Time", ylab = "Standardized Rate of Overdose Deaths", ylim=c(0,2))
# 
# differenced_data <- diff(weekly_overdose_deaths_county_std_suffolk_ts, differences = 1) # difference to remove linear trends and seasonality (difference twice, due to ljung box test)
# 
# # Check stationarity
# adf.test(weekly_overdose_deaths_county_std_m_ts) # reject the null hypothesis, it is stationary meaning constant mean, variance, covariance over time
# kpss.test(differenced_data, null = "Level") # low p-value implies that there is a trend
# 
# # Ljung-Box test
# Box.test(differenced_data, lag = 20, type = "Ljung-Box") # low p-value indicates that autocorrelation is significant at specific lags
# 
# acf(weekly_overdose_deaths_county_std_suffolk_ts, lag.max = 104) 
# Acf(differenced_data, lag.max = 52) # indicates that there is still a strong autocorrelation between consecutive observations, even after removing the linear trend (significant first lag)
# Pacf(differenced_data, lag.max = 104) 
# 
# model <- arima(differenced_data, order=c(8, 1, 1))
# acf(model$residuals)
# pacf(model$residuals)
# 
# Box.test(model$residuals, lag=52, type="Ljung-Box")
# 
# # Print the test results
# 
# model <- arima(differenced_data, order=c(1, 1, 0))
# sarima_model <- Arima(differenced_data, order=c(p, d, q), seasonal=c(P, D, Q, s))
# 
# summary(model)
# # Plot the residuals
# plot(residuals(model))
# 
# # Autocorrelation function (ACF) of residuals
# acf(residuals(model))


```

```{r Create animated maps of deaths by day}
output_directory <- "daily_maps/graphs"

ma_geo <- st_read("zipcodes_nt/ZIPCODES_NT_POLY.shp")
ma_cities <- ma_geo %>%
  group_by(PA_NAME) 

years <- unique(weekly_data$year)
# currently do not have the population estimates for all years, so the maps are only accurate for the years we have population estimates for (2000, 2005, 2006, ..., 2019)
for (i in seq(1, length(years))) {
  MA_ODs_deaths_by_week_county_temp <- weekly_data %>%
    filter(year == years[i])
  weeks <- unique(MA_ODs_deaths_by_week_county_temp$Week)
  MA_POP_multiyear_county_temp <- MA_POP_multiyear_county %>%
    filter(YOD == years[i])
  MA_ODs_deaths_by_week_county_yearly <- left_join(MA_ODs_deaths_by_week_county_temp, MA_POP_multiyear_county_temp, by = "County_name")
  
  MA_ODs_deaths_by_week_county_yearly_temp <- MA_ODs_deaths_by_week_county_yearly %>%
    rename(COUNTY = County_name) %>%
    mutate(COUNTY = toupper(COUNTY))
  
  # Standardize by population
  MA_ODs_deaths_by_week_county_yearly_standardized <- MA_ODs_deaths_by_week_county_yearly_temp %>%
    mutate(Standardized_Counts = (Deaths / estimate) * 100000)
  
  for (i in seq(1, length(weeks))) {
    MA_ODs_deaths_by_week_county_temp <- MA_ODs_deaths_by_week_county_yearly_standardized %>%
      filter(Week == weeks[i])
    
    complete_data <- left_join(ma_counties, MA_ODs_deaths_by_week_county_temp, by = "COUNTY")
  
    title <- paste("Standardized Overdose Deaths per 100,000 Population in MA Counties: Week", weeks[i])
    # Create the map for the specific day
    p <- ggplot() +
      geom_sf(data = complete_data, aes(fill = Standardized_Counts)) +
      scale_fill_gradientn(
        colors = c("pink", "firebrick"),
         na.value = "pink",
        limits = c(low_value, high_value),
        breaks = seq(low_value, high_value, by = 1)
      ) +
      theme_minimal() +
      labs(title = title, fill = "Standardized OD Death Rate") +
      theme(legend.position = "bottom", panel.background = element_rect(fill = "white")) +
      theme(plot.title = element_text(hjust = 0.5, margin = margin(b = 2)))


    # Generate the map
    ggsave(filename = paste0(output_directory, "map_", days[i], ".png"), plot = p, width = 8, height = 8)
  }
}

# get the number of deaths in each city for the signal
# use std_deaths_spikes_city 

# get counts of deaths in each city, and also mark if each day was a signal
 
daily_overdose_deaths_by_city_std_temp <- daily_overdose_deaths_by_city_std %>% rename(date = "DOD_4_FD")
df_full_temp <- full_join(daily_overdose_deaths_by_city_std_temp, df, by = "date")

df_full <- df_full_temp %>% filter(date >= as.Date('2020-01-01') & date <= as.Date('2020-12-31'))
df_full <- df_full %>% select(DNAME_CITY, date, Total_Overdose_Deaths, Standardized_Counts, signals)

days <- unique(df_full$date)
ma_cities <- ma_cities %>% rename(DNAME_CITY = PA_NAME)

low_value <- 0
high_value <- 1
for (i in seq(1, length(days))) { 
    daily_city_deaths_temp <- df_full %>%
      filter(date == days[i])

    complete_data <- left_join(ma_cities, daily_city_deaths_temp, by = "DNAME_CITY")
    complete_data$spike_condition <- ifelse(complete_data$signals == 1, "Color1", "Color2")

    title <- paste("Standardize Rate of Overdose Deaths per 10,000 Population in MA Cities: ", days[i])
    # Create the map for the specific day
    p <- ggplot() +
      geom_sf(data = complete_data, aes(fill = Standardized_Counts, color = spike_condition)) +
      scale_fill_gradientn(
        colors = c("white", "blue4"),
         na.value = "white",
        limits = c(low_value, high_value),
        breaks = seq(low_value, high_value, by = 0.25)
      ) +
      scale_color_manual(values = c("Color1" = "firebrick", "Color2" = "darkgrey")) +

      theme_minimal() +
      # scale_fill_manual(values = c("Color1" = "firebrick", "Color2" = "black")) +

      labs(title = title, fill = "Standardized Rate of Total Overdose Deaths") +
      theme(legend.position = "bottom", panel.background = element_rect(fill = "white")) +
      theme(plot.title = element_text(hjust = 0.5, margin = margin(b = 2)))


    # Generate the map
    ggsave(filename = paste0('daily_maps/graphs', "map_", days[i], ".png"), plot = p, width = 8, height = 8)
}
```

```{r Function to create a Calendar Heat Map to represent daily trends}
# Created using https://raw.githubusercontent.com/iascchen/VisHealth/master/R/calendarHeat.R 
# Function was modified - there are some days in the dataset where no deaths are recorded. In the heat map calender, this code will produce dates with no recorded deaths as just zero deaths

library(tidyr)  # Load the tidyr package

calendarHeat <- function(dates, 
                         values, 
                         ncolors = 99, 
                         color = "g2r", 
                         varname = "Values",
                         date.form = "%Y-%m-%d",
                         max_value = 0, 
                         min_value = 3, ...) {
  if (inherits(dates, "character") | inherits(dates, "factor")) {
    dates <- strptime(dates, date.form)
  }
  caldat <- data.frame(value = values, dates = dates)

  # Ensure all dates in the range are present with a value of 0
  min.date <- as.Date(paste(format(min(dates), "%Y"), "-1-1", sep = ""))
  max.date <- as.Date(paste(format(max(dates), "%Y"), "-12-31", sep = ""))
  complete_dates <- data.frame(dates = seq(min.date, max.date, by = "days"))
  caldat <- merge(caldat, complete_dates, all = TRUE)
  caldat$value[is.na(caldat$value)] <- 0

  caldat$dotw <- as.numeric(format(caldat$date, "%w"))
  caldat$woty <- as.numeric(format(caldat$date, "%U")) + 1
  caldat$yr <- as.factor(format(caldat$date, "%Y"))
  caldat$month <- as.numeric(format(caldat$date, "%m"))
  yrs <- as.character(unique(caldat$yr))
  d.loc <- as.numeric()
  for (m in min(yrs):max(yrs)) {
    d.subset <- which(caldat$yr == m)
    sub.seq <- seq(1, length(d.subset))
    d.loc <- c(d.loc, sub.seq)
  }
  caldat <- cbind(caldat, seq = d.loc)
  
  #color styles
  r2b <- c("#0571B0", "#92C5DE", "#F7F7F7", "#F4A582", "#CA0020") #red to blue                                                                               
  g2r <- c("#B5E384", "#FFFFBD","#FFAE63", "#D61818")   #green to red
  w2b <- c("#045A8D", "#2B8CBE", "#74A9CF", "#BDC9E1", "#F1EEF6")   #white to blue
  
  assign("col.sty", get(color))
  calendar.pal <- colorRampPalette((col.sty), space = "Lab")
  
  def.theme <- lattice.getOption("default.theme")
  cal.theme <-
    function() {  
      theme <-
        list(
          strip.background = list(col = "transparent"),
          strip.border = list(col = "transparent"),
          axis.line = list(col="transparent"),
          par.strip.text=list(cex=0.8))
    }
  lattice.options(default.theme = cal.theme)
  yrs <- (unique(caldat$yr))
  nyr <- length(yrs)
  print(cal.plot <- levelplot(value~woty*dotw | yr, data=caldat,
                              as.table=TRUE,
                              aspect=.12,
                              layout = c(0, 24),
                              between = list(x=0, y=c(1,1)),
                              strip=TRUE,
                              main = paste(varname),
                              scales = list(
                                x = list(
                                  at= c(seq(2.9, 52, by=4.42)),
                                  labels = month.abb,
                                  alternating = c(1, rep(0, (nyr-1))),
                                  tck=0,
                                  cex = 0.7),
                                y=list(
                                  at = c(0, 1, 2, 3, 4, 5, 6),
                                  labels = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday",
                                             "Friday", "Saturday"),
                                  alternating = 1,
                                  cex = 0.6,
                                  tck=0)),
                              xlim =c(0.4, 54.6),
                              ylim=c(6.6,-0.6),
                              cuts= 1,
                              col.regions = (calendar.pal(ncolors)),
                              xlab="" ,
                              ylab="",
                              colorkey= list(col = calendar.pal(ncolors), width = 0.6, height = 0.5),
                              subscripts=TRUE,
                              at = seq(min_value, max_value, length.out = ncolors)
  ) )
  panel.locs <- trellis.currentLayout()
  for (row in 1:nrow(panel.locs)) {
    for (column in 1:ncol(panel.locs))  {
      if (panel.locs[row, column] > 0)
      {
        trellis.focus("panel", row = row, column = column,
                      highlight = FALSE)
        xyetc <- trellis.panelArgs()
        subs <- caldat[xyetc$subscripts,]
        dates.fsubs <- caldat[caldat$yr == unique(subs$yr),]
        y.start <- dates.fsubs$dotw[1]
        y.end   <- dates.fsubs$dotw[nrow(dates.fsubs)]
        dates.len <- nrow(dates.fsubs)
        adj.start <- dates.fsubs$woty[1]
        
        for (k in 0:6) {
          if (k < y.start) {
            x.start <- adj.start + 0.5
          } else {
            x.start <- adj.start - 0.5
          }
          if (k > y.end) {
            x.finis <- dates.fsubs$woty[nrow(dates.fsubs)] - 0.5
          } else {
            x.finis <- dates.fsubs$woty[nrow(dates.fsubs)] + 0.5
          }
          grid.lines(x = c(x.start, x.finis), y = c(k -0.5, k - 0.5), 
                     default.units = "native", gp=gpar(col = "grey", lwd = 1))
        }
        if (adj.start <  2) {
          grid.lines(x = c( 0.5,  0.5), y = c(6.5, y.start-0.5), 
                     default.units = "native", gp=gpar(col = "grey", lwd = 1))
          grid.lines(x = c(1.5, 1.5), y = c(6.5, -0.5), default.units = "native",
                     gp=gpar(col = "grey", lwd = 1))
          grid.lines(x = c(x.finis, x.finis), 
                     y = c(dates.fsubs$dotw[dates.len] -0.5, -0.5), default.units = "native",
                     gp=gpar(col = "grey", lwd = 1))
          if (dates.fsubs$dotw[dates.len] != 6) {
            grid.lines(x = c(x.finis + 1, x.finis + 1), 
                       y = c(dates.fsubs$dotw[dates.len] -0.5, -0.5), default.units = "native",
                       gp=gpar(col = "grey", lwd = 1))
          }
          grid.lines(x = c(x.finis, x.finis), 
                     y = c(dates.fsubs$dotw[dates.len] -0.5, -0.5), default.units = "native",
                     gp=gpar(col = "grey", lwd = 1))
        }
        for (n in 1:51) {
          grid.lines(x = c(n + 1.5, n + 1.5), 
                     y = c(-0.5, 6.5), default.units = "native", gp=gpar(col = "grey", lwd = 1))
        }
        x.start <- adj.start - 0.5
        
        if (y.start > 0) {
          grid.lines(x = c(x.start, x.start + 1),
                     y = c(y.start - 0.5, y.start -  0.5), default.units = "native",
                     gp=gpar(col = "black", lwd = 1.75))
          grid.lines(x = c(x.start + 1, x.start + 1),
                     y = c(y.start - 0.5 , -0.5), default.units = "native",
                     gp=gpar(col = "black", lwd = 1.75))
          grid.lines(x = c(x.start, x.start),
                     y = c(y.start - 0.5, 6.5), default.units = "native",
                     gp=gpar(col = "black", lwd = 1.75))
          if (y.end < 6  ) {
            grid.lines(x = c(x.start + 1, x.finis + 1),
                       y = c(-0.5, -0.5), default.units = "native",
                       gp=gpar(col = "black", lwd = 1.75))
            grid.lines(x = c(x.start, x.finis),
                       y = c(6.5, 6.5), default.units = "native",
                       gp=gpar(col = "black", lwd = 1.75))
          } else {
            grid.lines(x = c(x.start + 1, x.finis),
                       y = c(-0.5, -0.5), default.units = "native",
                       gp=gpar(col = "black", lwd = 1.75))
            grid.lines(x = c(x.start, x.finis),
                       y = c(6.5, 6.5), default.units = "native",
                       gp=gpar(col = "black", lwd = 1.75))
          }
        } else {
          grid.lines(x = c(x.start, x.start),
                     y = c( - 0.5, 6.5), default.units = "native",
                     gp=gpar(col = "black", lwd = 1.75))
        }
        
        if (y.start == 0 ) {
          if (y.end < 6  ) {
            grid.lines(x = c(x.start, x.finis + 1),
                       y = c(-0.5, -0.5), default.units = "native",
                       gp=gpar(col = "black", lwd = 1.75))
            grid.lines(x = c(x.start, x.finis),
                       y = c(6.5, 6.5), default.units = "native",
                       gp=gpar(col = "black", lwd = 1.75))
          } else {
            grid.lines(x = c(x.start + 1, x.finis),
                       y = c(-0.5, -0.5), default.units = "native",
                       gp=gpar(col = "black", lwd = 1.75))
            grid.lines(x = c(x.start, x.finis),
                       y = c(6.5, 6.5), default.units = "native",
                       gp=gpar(col = "black", lwd = 1.75))
          }
        }
        for (j in 1:12)  {
          last.month <- max(dates.fsubs$seq[dates.fsubs$month == j])
          x.last.m <- dates.fsubs$woty[last.month] + 0.5
          y.last.m <- dates.fsubs$dotw[last.month] + 0.5
          grid.lines(x = c(x.last.m, x.last.m), y = c(-0.5, y.last.m),
                     default.units = "native", gp=gpar(col = "black", lwd = 1.75))
          if ((y.last.m) < 6) {
            grid.lines(x = c(x.last.m, x.last.m - 1), y = c(y.last.m, y.last.m),
                       default.units = "native", gp=gpar(col = "black", lwd = 1.75))
            grid.lines(x = c(x.last.m - 1, x.last.m - 1), y = c(y.last.m, 6.5),
                       default.units = "native", gp=gpar(col = "black", lwd = 1.75))
          } else {
            grid.lines(x = c(x.last.m, x.last.m), y = c(- 0.5, 6.5),
                       default.units = "native", gp=gpar(col = "black", lwd = 1.75))
          }
        }
      }
    }
    trellis.unfocus()
  } 
  lattice.options(default.theme = def.theme)
}
```

```{r Calendar Heat Maps for Stimulant Only and Cocaine + Stimulant Deaths; 2019-2023}
# Starting from mid-April, our current data did not record any deaths for 2023, so keep in mind that we do not necessarily always have zero deaths in these certain days
MA_ODs_drugs_by_day$year <- format(MA_ODs_drugs_by_day$DOD_4_FD, "%Y")

# Calendar heat map for stimulant only deaths in 2019-2023
MA_ODs_drugs_by_day_stimulants <- MA_ODs_drugs_by_day %>%
  filter(format(DOD_4_FD, "%Y") %in% c("2019", "2020", "2021", "2022", "2023")) %>%
  filter(drug == "Stim Only Deaths")
calendarHeat(MA_ODs_drugs_by_day_stimulants$DOD_4_FD, MA_ODs_drugs_by_day_stimulants$num_deaths, ncolors = 99, color = "g2r", varname="Stimulant Only Deaths in Massachusetts", date.form = "%Y-%m-%d")

# Calendar heat map for opioid and stimulant only deaths in 2019-2023
MA_ODs_drugs_by_day_stimulants_and_opioid <- MA_ODs_drugs_by_day %>%
  filter(format(DOD_4_FD, "%Y") %in% c("2019", "2020", "2021", "2022", "2023")) %>%
  filter(drug == "Opioid + Stim Only Deaths") 
calendarHeat(MA_ODs_drugs_by_day_stimulants_and_opioid$DOD_4_FD, MA_ODs_drugs_by_day_stimulants_and_opioid$num_deaths, ncolors = 99, color = "g2r", varname="Opioid + Stimulant Only Deaths in Massachusetts", date.form = "%Y-%m-%d")

# Calendar heat map for overdose deaths in 2019-2023
MA_ODs_deaths_by_day_filtered <- MA_ODs_deaths_by_day %>%
  filter(format(DOD_4_FD, "%Y") %in% c("2019", "2020", "2021", "2022", "2023"))
calendarHeat(MA_ODs_deaths_by_day_filtered$DOD_4_FD, MA_ODs_deaths_by_day_filtered$`Total Overdose Deaths`, ncolors = 99, color = "g2r", varname="Total Overdose Deaths in Massachusetts", date.form = "%Y-%m-%d")
```

```{r fig.width = 8, fig.height = 30}
# Calendar heat map for total overdose deaths involving any opioids for each county in MA

MA_ODs_deaths_by_day_county_new <- merge(MA_POP_multiyear_county, MA_ODs_drugs_by_day_county, by = "County_name") %>%
  filter(drug == "Involving Opioids") %>%
  select(DOD_4_FD, County_name, num_deaths)

# standardize deaths
MA_ODs_deaths_by_day_county_new_temp <- left_join(MA_ODs_deaths_by_day_county_new, MA_POP_multiyear_county, by = "County_name")
MA_ODs_deaths_by_day_county_new <- MA_ODs_deaths_by_day_county_new_temp %>%
  mutate(Standardized_Counts = (num_deaths / estimate) * 100000) %>%
  filter(!(YOD %in% c(2001, 2002, 2003, 2004, 2020, 2021, 2022, 2023)))
  

MA_ODs_deaths_by_day_county_new <- MA_ODs_deaths_by_day_county_new[complete.cases(MA_ODs_deaths_by_day_county_new$DOD_4_FD), ]

counties <- unique(MA_ODs_deaths_by_day_county_new$County_name) 
for (i in seq(1, 1)) {
  
  MA_ODs_deaths_by_day_county_new_temp <- MA_ODs_deaths_by_day_county_new %>%
    filter(County_name == counties[i])

  calendarHeat(MA_ODs_deaths_by_day_county_new_temp$DOD_4_FD, MA_ODs_deaths_by_day_county_new_temp$Standardized_Counts, ncolors = 99, color = "g2r", varname=paste("Standardized Rate of Overdose Deaths Involving Opioids in ", sub("^(.)", "\\U\\1", tolower(counties[i]), perl = TRUE), " County, MA", sep = ""), date.form = "%Y-%m-%d")
  # Save the plot to a file
  # ggsave("/Users/Hannah/Documents/R/Mass-Vital-Statistics/plot.png", plot = a)
}
```

```{r Stimulants Analysis}

MA_ODs_stims_by_year <- ODs_drug_categories %>% 
  group_by(YOD) %>% 
  filter(YOD >= 2010 & YOD <= 2021) %>%
     summarize(
            "Psychostimulants Only" = sum(ps_only),
            "Cocaine Only" = sum(coc_only),
            "Only Stimulants Only" = sum(stim_only),
            "Opioid and Stimulants Only" = sum(opioid_and_stim_only),
            "Stimulant Involved" = sum(stim_involved),
            "Opioid and Stimulant Involved" = sum(opioid_and_stim_involved))%>%
   pivot_longer(!c(YOD), names_to = "drug", values_to = "num_deaths") %>%
   ungroup()


# Drugs over the years
MA_ODs_stims_by_year <- ODs_drug_categories %>% 
  group_by(YOD) %>% 
  filter(YOD >= 2010 & YOD <= 2021) %>%
     summarize(
            "Only Psychostimulants" = sum(ps_only),
            "Only Cocaine" = sum(coc_only),
            # "PS and Cocaine Only" = sum(coc_and_ps_only),
            # "PS or Cocaine Only" = sum(stim_only),
            "Opioid and Stimulants Only" = sum(opioid_and_stim_only))%>%
   pivot_longer(!c(YOD), names_to = "drug", values_to = "num_deaths") %>%
   ungroup()

# Stacked bar graph to visualize the proportions of drugs over the years
ggplot(data = MA_ODs_stims_by_year, aes(x = YOD, y = num_deaths, fill = drug)) +
  geom_bar(stat = "identity") +
  labs(x = "Year", y = "Count", title = "Number of Overdose Deaths by Year (MA)") +
  scale_x_continuous(breaks = seq(2010, 2021, by = 1))  +
  scale_y_continuous(breaks = seq(0, 1300, by = 100), limits = c(0, 1300)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  geom_text(aes(label = num_deaths), position = position_stack(vjust = 0.5), size = 2.3, color = "black")

# Drugs by race
MA_ODs_stim_by_year_race <- ODs_drug_categories %>% 
  group_by(YOD, RACEGROUP) %>% 
  filter(YOD >= 2010 & YOD <= 2021) %>%
  summarize(
            # "Only Psychostimulants" = sum(ps_only),
            "Only Cocaine" = sum(coc_only),
            # "PS and Cocaine Only" = sum(coc_and_ps_only),
            # "PS or Cocaine Only" = sum(stim_only),
            "Opioid and Stimulants Only" = sum(opioid_and_stim_only)) %>%
   pivot_longer(!c(YOD, RACEGROUP), names_to = "drug", values_to = "num_deaths") %>%
   ungroup()

MA_ODs_stim_by_year_race_filtered <- MA_ODs_stim_by_year_race %>% 
  filter(YOD != 2021) %>%
  mutate(RACEGROUP = ifelse(RACEGROUP %in% c("American Indian / Alaska Native", "Other NH"), "American Indian / Alaska Native / Other NH", RACEGROUP)) %>%
  group_by(YOD,drug, RACEGROUP) %>%
  summarize(num_deaths = sum(num_deaths), .groups = 'drop')%>%
  filter(RACEGROUP != "Unknown")

ggplot(data = MA_ODs_stim_by_year_race_filtered, aes(x = YOD, y = num_deaths, fill = RACEGROUP)) +
  geom_bar(stat = "identity") +
  labs(x = "Year", y = "Count", title = "Number of Overdose Deaths by Year (MA)") +
  scale_x_continuous(breaks = seq(2010, 2021, by = 1))  +
  scale_y_continuous(breaks = seq(0, 900, by = 100), limits = c(0, 900)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~drug)

# Drugs by age
MA_ODs_stim_by_year_age <- ODs_drug_categories %>% 
  group_by(YOD, AGE1_RANGE) %>% 
  filter(YOD >= 2010 & YOD <= 2021) %>%
  filter(AGE1_RANGE != 'NA') %>%
  summarize(
            # "Only Psychostimulants" = sum(ps_only),
            "Only Cocaine" = sum(coc_only),
            # "PS and Cocaine Only" = sum(coc_and_ps_only),
            # "PS or Cocaine Only" = sum(stim_only),
            "Opioid and Stimulants Only" = sum(opioid_and_stim_only)) %>%
   pivot_longer(!c(YOD, AGE1_RANGE), names_to = "drug", values_to = "num_deaths") %>%
   ungroup()

ggplot(data = MA_ODs_stim_by_year_age, aes(x = YOD, y = num_deaths, fill = AGE1_RANGE)) +
  geom_bar(stat = "identity") +
  labs(x = "Year", y = "Count", title = "Number of Overdose Deaths by Year (MA)") +
  scale_x_continuous(breaks = seq(2010, 2021, by = 1))  +
  scale_y_continuous(breaks = seq(0, 1300, by = 100), limits = c(0, 1300)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~drug)

# Drugs by sex
MA_ODs_stim_by_year_sex <- ODs_drug_categories %>% 
  group_by(YOD, SEX) %>% 
  filter(YOD >= 2010 & YOD <= 2021) %>%
  summarize(
            # "Only Psychostimulants" = sum(ps_only),
            "Only Cocaine" = sum(coc_only),
            # "PS and Cocaine Only" = sum(coc_and_ps_only),
            # "PS or Cocaine Only" = sum(stim_only),
            "Opioid and Stimulants Only" = sum(opioid_and_stim_only)) %>%
   pivot_longer(!c(YOD, SEX), names_to = "drug", values_to = "num_deaths") %>%
   ungroup()
ggplot(data = MA_ODs_stim_by_year_sex, aes(x = YOD, y = num_deaths, fill = SEX)) +
  geom_bar(stat = "identity") +
  labs(x = "Year", y = "Count", title = "Number of Overdose Deaths by Year (MA)") +
  scale_x_continuous(breaks = seq(2010, 2021, by = 1))  +
  scale_y_continuous(breaks = seq(0, 1300, by = 100), limits = c(0, 1300)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~drug)

MA_ODs_stims_any_opioids_by_year <- ODs_drug_categories %>% 
  group_by(YOD) %>% 
  summarize(
            "Any Opioids with Cocaine and/or PS" = sum(any_opioids_with_stim),
            "Any Opioids with PS" = sum(any_opioids_with_ps),
            "Any Opioids with Cocaine" = sum(any_opioids_with_cocaine), 
            "Any Opioids with Cocaine and PS" = sum(any_opioids_with_ps_and_coc)) %>%
   pivot_longer(!c(YOD), names_to = "drug", values_to = "num_deaths") %>%
   ungroup()

ggplot(data = MA_ODs_stims_any_opioids_by_year, aes(x = YOD, y = num_deaths)) +  
  geom_line() + # Add a line plot
  theme_minimal() + # Optional: Use a minimal theme
  labs(title = "Raw Counts of ODs Involving Opioids w/ PS and/or Cocaine", 
       x = "Year", 
       y = "Counts") + # Add labels.
  scale_x_continuous(breaks = seq(2000, 2023, by = 1)) + # Adjust this line
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +  # Rotate x-axis labels vertically 
  facet_wrap(~drug)


ggplot(data = MA_ODs_stim_by_year_race_filtered, aes(x = YOD, y = num_deaths, color= RACEGROUP)) +  
  geom_line() + # Add a line plot
  theme_minimal() + # Optional: Use a minimal theme
  labs(title = "PS or Cocaine Only",
       x = "Year", 
       y = "Raw Counts") + # Add labels.
  scale_x_continuous(breaks = seq(2000, 2023, by = 1)) + # Adjust this line
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))  # Rotate x-axis labels vertically 

MA_ODs_stims_by_year_age <- ODs_drug_categories %>% 
  group_by(YOD, AGE1_RANGE) %>% 
  summarize("Only Psychostimulants" = sum(ps_only),
            "Only Cocaine" = sum(coc_only),
            "PS and Cocaine Only" = sum(coc_and_ps_only),
            "PS or Cocaine Only" = sum(stim_only)) %>%
   pivot_longer(!c(YOD, AGE1_RANGE), names_to = "drug", values_to = "num_deaths") %>%
   ungroup()

MA_ODs_stims_by_year_age_filtered <-MA_ODs_stims_by_year_age %>% 
  filter(drug == "Only Psychostimulants") %>%
  filter(AGE1_RANGE != 'NA')


ggplot(data = MA_ODs_stims_by_year_age_filtered, aes(x = AGE1_RANGE, y = num_deaths)) +  
  geom_bar(stat = 'identity' ) +
  theme_minimal() + # Optional: Use a minimal theme
  labs(title = "Raw Counts of Any Opioids with Cocaine Only Overdose Deaths by Age",
       x = "Age Range", 
       y = "Raw Counts") + # Add labels.
  facet_wrap(~YOD)


MA_ODs_xylazine <- ODs_drug_categories %>%
  group_by(YOD) %>% 
  summarize("Xylazine" = sum(any_xylazine)) %>%
   pivot_longer(!c(YOD), names_to = "drug", values_to = "num_deaths") %>%
   ungroup()

ggplot(data = MA_ODs_xylazine, aes(x = YOD, y = num_deaths)) +  
  geom_line() + # Add a line plot
  theme_minimal() + # Optional: Use a minimal theme
  labs(title = "Raw Counts of Psychostimulant and/or Cocaine Overdose Deaths", 
       x = "Year", 
       y = "Counts") + # Add labels.
  scale_x_continuous(breaks = seq(2000, 2023, by = 1)) + # Adjust this line
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +  # Rotate x-axis labels vertically 
  facet_wrap(~drug)


```

```{r Sensitivity analysis per year}

#New threshold algorithm for the sensitivity analysis, adds new outputs
ThresholdingAlgo2 <- function(y,lag,threshold,influence) {
  signals <- rep(0,length(y))
  filteredY <- y[1:lag]
  avgFilter <- NULL
  stdFilter <- NULL
  spikes<-rep(0,length(y))
  dips<-rep(0,length(y))
  avgFilter[lag] <- mean(y[1:lag], na.rm=TRUE)
  stdFilter[lag] <- sd(y[1:lag], na.rm=TRUE)
  for (i in (lag+1):length(y)){
    if (abs(y[i]-avgFilter[i-1]) > threshold*stdFilter[i-1]) {
      if (y[i] > avgFilter[i-1]) {
        signals[i] <- 1
        spikes[i]<-y[i]
        dips[i]<-0
        } 
      else {
        signals[i] <- -1
        dips[i]<-y[i]
        spikes[i]<-0
      }
      filteredY[i] <- influence*y[i]+(1-influence)*filteredY[i-1]
    } else {
      signals[i] <- 0
      spikes[i]<-0
      dips[i]<-0
      filteredY[i] <- y[i]
    }
    avgFilter[i] <- mean(filteredY[(i-lag+1):i], na.rm=TRUE)
    stdFilter[i] <- sd(filteredY[(i-lag+1):i], na.rm=TRUE)
  }
  return(list("signals"=signals,"avgFilter"=avgFilter,"stdFilter"=stdFilter,"spikes"=spikes,"dips"=dips))
}

#Parameters for the sensitivity analysis. Change the array accordingly

lag<-c(7,15,30,60,90,120,150,180)
threshold <- c(2.0,2.1,2.2,2.3,2.4,2.5,2.6,2.7,2.8,2.9,3)
influence<-c(0.3)

#This sensitivity analysis returns the results per year. The parameter year represents since which year you want to do the analysis. Hence if year=2017, then returns the analysis for 2017 thereafter. (Until 2022)

sens_analysis_year <- function(geographical_data, lag, threshold, influence,year)
{
  
  y <- geographical_data$Total_Overdose_Deaths
  
  theResult<-0
  
  pb <- progress_bar$new(format = " running [:bar] :percent eta: :eta",total = length(lag), clear = FALSE, width= 60)


  for(i in 1:length(lag))
  {
    pb$tick()
    for(j in 1:length(threshold))
    {
      for( k in 1:length(influence))
      {
        result <- ThresholdingAlgo2(y,lag[i],threshold[j],influence[k])
        df <- data.frame(date = geographical_data$DOD_4_FD, 
                         y = y, 
                         avgFilter = result$avgFilter, 
                         upperThreshold = result$avgFilter + threshold[j] * result$stdFilter, 
                         signals = result$signals,
                         spikes=result$spikes,
                         dips=result$dips,
                         YOD = geographical_data$YOD)
        df$year <- year(df$date)
        df_modified <- df
        df_modified$modified_y <- ifelse(df$signals == 0, 0, df$y)
        df_modified$y_minus_avgFilter_or_zero <- ifelse(df$signals == 0, 0, df$y - df$avgFilter)
        df_modified$lag<-lag[i]
        df_modified$threshold<-threshold[j]
        df_modified$influence<-influence[k]
        df_modified$percSpike<-ifelse(df_modified$signals==1,df_modified$y_minus_avgFilter_or_zero/df_modified$avgFilter,0)
        df_modified<-df_modified[df_modified$year>=year & df_modified$year<=2022,]
        df_modified<-df_modified %>%
        group_by(year,lag,threshold,influence) %>%
        summarise(Count = sum(y_minus_avgFilter_or_zero > 0),Average_spike=mean(spikes[spikes > 0]),Average_dip=mean(dips[dips>0]),Total_spikes=sum(spikes),Total_deaths=sum(y),Average_per_inc_spike=mean(percSpike[percSpike>0]),Average_diff=mean(y_minus_avgFilter_or_zero[y_minus_avgFilter_or_zero>0]))
        df_modified$perc_spike_death<-df_modified$Total_spikes/df_modified$Total_deaths
        if(i==1 & j==1 & k==1)
        {
          theResult<-df_modified
        }
        else
        {
          theResult<-rbind(theResult,df_modified)
        }   
      }
    }
  Sys.sleep(1 / 100)
  }
  
   return(theResult)
  
}

sensAnalysisYear<-sens_analysis_year(daily_overdose_deaths_ma, lag, threshold, influence,2017)
```


```{r Create tables for the sensitivity analysis - Percentage of deaths in spikes}
year<-2022

theTable<-sensAnalysisYear[sensAnalysisYear$year==year,]

theTable %>% pivot_wider(names_from = lag, 
              values_from = perc_spike_death, 
              id_cols = threshold)

```
```{r Create tables for the sensitivity analysis - Percentage of days as spikes}
year<-2022

theTable<-sensAnalysisYear[sensAnalysisYear$year==year,]
theTable$Count<-theTable$Count/365

theTable %>% pivot_wider(names_from = lag, 
              values_from = Count, 
              id_cols = threshold)

```
```{r Create tables for the sensitivity analysis - Avg size of a spike}
year<-2022

theTable<-sensAnalysisYear[sensAnalysisYear$year==year,]

theTable %>% pivot_wider(names_from = lag, 
              values_from = Average_spike, 
              id_cols = threshold)

```

```{r Create tables for the sensitivity analysis - Avg differnce vs the moving average}
year<-2022

theTable<-sensAnalysisYear[sensAnalysisYear$year==year,]

theTable %>% pivot_wider(names_from = lag, 
              values_from = Average_diff, 
              id_cols = threshold)

```

```{r Sensitivity analysis per year}

#New threshold algorithm for the sensitivity analysis, adds new outputs
ThresholdingAlgo2 <- function(y,lag,threshold,influence) {
  signals <- rep(0,length(y))
  filteredY <- y[1:lag]
  avgFilter <- NULL
  stdFilter <- NULL
  spikes<-rep(0,length(y))
  dips<-rep(0,length(y))
  avgFilter[lag] <- mean(y[1:lag], na.rm=TRUE)
  stdFilter[lag] <- sd(y[1:lag], na.rm=TRUE)
  for (i in (lag+1):length(y)){
    if (abs(y[i]-avgFilter[i-1]) > threshold*stdFilter[i-1]) {
      if (y[i] > avgFilter[i-1]) {
        signals[i] <- 1
        spikes[i]<-y[i]
        dips[i]<-0
        } 
      else {
        signals[i] <- -1
        dips[i]<-y[i]
        spikes[i]<-0
      }
      filteredY[i] <- influence*y[i]+(1-influence)*filteredY[i-1]
    } else {
      signals[i] <- 0
      spikes[i]<-0
      dips[i]<-0
      filteredY[i] <- y[i]
    }
    avgFilter[i] <- mean(filteredY[(i-lag+1):i], na.rm=TRUE)
    stdFilter[i] <- sd(filteredY[(i-lag+1):i], na.rm=TRUE)
  }
  return(list("signals"=signals,"avgFilter"=avgFilter,"stdFilter"=stdFilter,"spikes"=spikes,"dips"=dips))
}

#Parameters for the sensitivity analysis. Change the array accordingly

lag<-c(30)
threshold <- c(2.0)
influence<-c(0.1,0.3,0.5,0.7,0.9)

#This sensitivity analysis groups by all years between 2017 to 2022

sens_analysis <- function(geographical_data, lag, threshold, influence)
{
  
  y <- geographical_data$Total_Overdose_Deaths
  
  theResult<-0
    pb <- progress_bar$new(format = " running [:bar] :percent eta: :eta",total = length(lag), clear = FALSE, width= 60)


  for(i in 1:length(lag))
  {
    pb$tick()
    for(j in 1:length(threshold))
    {
      for( k in 1:length(influence))
      {
        result <- ThresholdingAlgo2(y,lag[i],threshold[j],influence[k])
        df <- data.frame(date = geographical_data$DOD_4_FD, 
                         y = y, 
                         avgFilter = result$avgFilter, 
                         upperThreshold = result$avgFilter + threshold[j] * result$stdFilter, 
                         signals = result$signals,
                         spikes=result$spikes,
                         dips=result$dips,
                         YOD = geographical_data$YOD)
        df$year <- year(df$date)
        df_modified <- df
        df_modified$modified_y <- ifelse(df$signals == 0, 0, df$y)
        df_modified$y_minus_avgFilter_or_zero <- ifelse(df$signals == 0, 0, df$y - df$avgFilter)
        df_modified$lag<-lag[i]
        df_modified$threshold<-threshold[j]
        df_modified$influence<-influence[k]
        df_modified$percSpike<-ifelse(df_modified$signals==1,df_modified$y_minus_avgFilter_or_zero/df_modified$avgFilter,0)
        df_modified<-df_modified[df_modified$year>=2017 & df_modified$year<=2022,]
        df_modified<-df_modified %>%
          #group_by(year,lag,threshold,influence) %>%
          group_by(lag,threshold,influence) %>%
          summarise(Count = sum(y_minus_avgFilter_or_zero > 0),Average_spike=mean(spikes[spikes > 0]),Average_dip=mean(dips[dips>0]),Total_spikes=sum(spikes),Total_deaths=sum(y),Average_per_inc_spike=mean(percSpike[percSpike>0]),Average_diff=mean(y_minus_avgFilter_or_zero[y_minus_avgFilter_or_zero>0]))
        df_modified$perc_spike_death<-df_modified$Total_spikes/df_modified$Total_deaths
        if(i==1 & j==1 & k==1)
        {
          theResult<-df_modified
        }
        else
        {
          theResult<-rbind(theResult,df_modified)
        }   
      }
    }
    Sys.sleep(1 / 100)
  }
  
   return(theResult)
  
}

sensAnalysis<-sens_analysis(daily_overdose_deaths_ma, lag, threshold, influence)

```

```{r Create tables for the sensitivity analysis for all years - Percentage of deaths in spikes}
sensAnalysis %>% pivot_wider(names_from = lag, 
              values_from = perc_spike_death, 
              id_cols = threshold)

```

```{r Create tables for the sensitivity analysis - Percentage of days as spikes}
theTable<-sensAnalysis
theTable$Count<-theTable$Count/2191

theTable %>% pivot_wider(names_from = lag, 
              values_from = Count, 
              id_cols = threshold)

```

```{r Create tables for the sensitivity analysis - Avg size of a spike}
sensAnalysis %>% pivot_wider(names_from = lag, 
              values_from = Average_spike, 
              id_cols = threshold)

```

```{r Create tables for the sensitivity analysis - Avg differnce vs the moving average}
sensAnalysis %>% pivot_wider(names_from = lag, 
              values_from = Average_diff, 
              id_cols = threshold)

```

```{r Sensitivity analysis per year output by days}

#New threshold algorithm for the sensitivity analysis, adds new outputs
ThresholdingAlgo2 <- function(y,lag,threshold,influence) {
  signals <- rep(0,length(y))
  filteredY <- y[1:lag]
  avgFilter <- NULL
  stdFilter <- NULL
  spikes<-rep(0,length(y))
  dips<-rep(0,length(y))
  avgFilter[lag] <- mean(y[1:lag], na.rm=TRUE)
  stdFilter[lag] <- sd(y[1:lag], na.rm=TRUE)
  for (i in (lag+1):length(y)){
    if (abs(y[i]-avgFilter[i-1]) > threshold*stdFilter[i-1]) {
      if (y[i] > avgFilter[i-1]) {
        signals[i] <- 1
        spikes[i]<-y[i]
        dips[i]<-0
        } 
      else {
        signals[i] <- -1
        dips[i]<-y[i]
        spikes[i]<-0
      }
      filteredY[i] <- influence*y[i]+(1-influence)*filteredY[i-1]
    } else {
      signals[i] <- 0
      spikes[i]<-0
      dips[i]<-0
      filteredY[i] <- y[i]
    }
    avgFilter[i] <- mean(filteredY[(i-lag+1):i], na.rm=TRUE)
    stdFilter[i] <- sd(filteredY[(i-lag+1):i], na.rm=TRUE)
  }
  return(list("signals"=signals,"avgFilter"=avgFilter,"stdFilter"=stdFilter,"spikes"=spikes,"dips"=dips))
}

#Parameters for the sensitivity analysis. Change the array accordingly

lag<-c(7,15,30,60,90,120,150,180)
threshold <- c(2.0,2.1,2.2,2.3,2.4,2.5,2.6,2.7,2.8,2.9,3)
influence<-c(0.3)

#This sensitivity analysis groups by all years between 2017 to 2022

sens_analysis_year_days <- function(geographical_data, lag, threshold, influence)
{
  
  y <- geographical_data$Total_Overdose_Deaths
  
  theResult<-0
    pb <- progress_bar$new(format = " running [:bar] :percent eta: :eta",total = length(lag), clear = FALSE, width= 60)


  for(i in 1:length(lag))
  {
    pb$tick()
    for(j in 1:length(threshold))
    {
      for( k in 1:length(influence))
      {
        result <- ThresholdingAlgo2(y,lag[i],threshold[j],influence[k])
        df <- data.frame(date = geographical_data$DOD_4_FD, 
                         y = y, 
                         avgFilter = result$avgFilter, 
                         upperThreshold = result$avgFilter + threshold[j] * result$stdFilter, 
                         signals = result$signals,
                         spikes=result$spikes,
                         dips=result$dips,
                         YOD = geographical_data$YOD)
        df$year <- year(df$date)
        df_modified <- df
        df_modified$modified_y <- ifelse(df$signals == 0, 0, df$y)
        df_modified$y_minus_avgFilter_or_zero <- ifelse(df$signals == 0, 0, df$y - df$avgFilter)
        df_modified$lag<-lag[i]
        df_modified$threshold<-threshold[j]
        df_modified$influence<-influence[k]
        df_modified$percSpike<-ifelse(df_modified$signals==1,df_modified$y_minus_avgFilter_or_zero/df_modified$avgFilter,0)
        df_modified<-df_modified[df_modified$year>=2017 & df_modified$year<=2022,]
        if(i==1 & j==1 & k==1)
        {
          theResult<-df_modified
        }
        else
        {
          theResult<-rbind(theResult,df_modified)
        }   
      }
    }
    Sys.sleep(1 / 100)
  }
  
   return(theResult)
  
}

sensAnalysisYearDays<-sens_analysis_year_days(daily_overdose_deaths_ma, lag, threshold, influence)

```

```{r Create tables for the sensitivity analysis - Avg differnce vs the moving average}

theData<-sensAnalysisYearDays[sensAnalysisYearDays$threshold==2 & sensAnalysisYearDays$lag==30 & sensAnalysisYearDays$year==2022,]
theData$spikes<-ifelse(theData$spikes>0,theData$spikes,NA)
ggplot(theData, aes(x = date)) +
  geom_line(aes(y = y, color = 'Deaths')) +
  geom_point(aes(y = spikes, color = 'Spikes'), size = 2) +
  geom_line(aes(y = avgFilter, color = 'Moving Average (1 months)')) +
  theme_minimal() +
  scale_color_manual(name = 'Labels',
                     labels = c('Deaths', 'Moving Average (1 months)', 'Spikes'),
                     values = c("gray", "lightseagreen", "red")
  ) +
  labs(
    title = paste("Time Series Daily Overdose Death Data with Adjusted Moving Average of 1 Months and Spikes,", year_of_interest),
    x = "Day",
    y = "Raw Counts of Overdose Deaths"
  ) + 
  ylim(0,17)


```